!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("qforms",[],t):"object"==typeof exports?exports.qforms=t():e.qforms=t()}(global,(()=>(()=>{"use strict";var __webpack_modules__={224:(e,t,s)=>{s.d(t,{Lm:()=>TableResult,U6:()=>DatabaseResult,cW:()=>InsertExResult,cY:()=>UpdateEx,sF:()=>UpdateResult,x4:()=>Result});class InsertExResult{}class UpdateResult{}class UpdateEx{}class TableResult{}class DatabaseResult{}class Result{static addInsertToResult(e,t,s,r){e[t]||(e[t]=new DatabaseResult),e[t][s]||(e[t][s]=new TableResult),e[t][s].insert||(e[t][s].insert=[]),e[t][s].insert.push(r)}static addInsertExToResult(e,t,s,r,o){e[t]||(e[t]=new DatabaseResult),e[t][s]||(e[t][s]=new TableResult),e[t][s].insertEx||(e[t][s].insertEx=new InsertExResult),e[t][s].insertEx[r]=o}static addUpdateToResult(e,t,s,r,o){e[t]||(e[t]=new DatabaseResult),e[t][s]||(e[t][s]=new TableResult),e[t][s].update||(e[t][s].update=new UpdateResult),e[t][s].update[r]=o}static addUpdateExToResult(e,t,s,r,o){e[t]||(e[t]=new DatabaseResult),e[t][s]||(e[t][s]=new TableResult),e[t][s].updateEx||(e[t][s].updateEx=new UpdateEx),e[t][s].updateEx[r]=o}static addDeleteToResult(e,t,s,r){e[t]||(e[t]=new DatabaseResult),e[t][s]||(e[t][s]=new TableResult),e[t][s].delete||(e[t][s].delete=[]),e[t][s].delete.push(r)}static addTableToResult(e,t,s,r){if(e[t]||(e[t]={}),e[t][s])throw new Error(`table ${s} already exists`);e[t][s]=r}}},491:(e,t,s)=>{s.d(t,{g:()=>BaseModel});class BaseModel{constructor(e,t){if(this.data=e,this.parent=t,!e)throw new Error(`new ${this.constructor.name}: no data`)}static getClassName(e){return e["@class"]}static getAttr(e,t){return e["@attributes"][t]}static getName(e){return BaseModel.getAttr(e,"name")}getClassName(){return this.data["@class"]}getName(){return BaseModel.getName(this.data)}static attributes(e){return e["@attributes"]}attributes(){return this.data["@attributes"]}getAttr(e){if(!this.isAttr(e))throw new Error(`no attribute '${e}'`);return this.data["@attributes"][e]}setAttr(e,t){this.data["@attributes"][e]=t}isAttr(e){return void 0!==this.data["@attributes"][e]}isData(e,t){if(!e)throw new Error("isData: no colName");if(!t)throw new Error("isData: no name");return!!this.getColItemData(e,t)}getData(){return this.data}getCol(e){if(!e)throw new Error("getCol: no name");const t=this.data[e];if(!t)throw new Error(`getCol: no col ${e}`);return t}getItemNames(e){return this.getCol(e).map((e=>BaseModel.getName(e)))}getColItemData(e,t){const s=BaseModel.findColDataByName(this.getCol(e),t);return s||null}removeColData(e,t){const s=this.getCol(e),r=BaseModel.findColDataByName(s,t);if(!r)throw new Error(`removeColData: no ${t} in ${e}`);return s.splice(s.indexOf(r),1),r}static findColDataByName(e,t){return e.find((e=>BaseModel.getName(e)===t))}addModelData(e,t){const s=BaseModel.getName(t);if(this.getColItemData(e,s))throw new Error(`${s} already exists in ${e}`);this.getCol(e).push(t)}getApp(){throw new Error("getApp: not implemented")}replaceDataColItem(e,t,s){const r=this.getCol(e),o=r.indexOf(t);if(-1===o)throw new Error(`replaceDataColItem: no ${BaseModel.getName(t)} in ${e}`);return r[o]=s,o}getParent(){if(!this.parent)throw new Error("no parent");return this.parent}}},686:(e,t,s)=>{s.d(t,{_:()=>BkHelper});var r=s(147),o=s.n(r);const a=require("glob");var i=s.n(a),n=s(17),l=s.n(n);const c=require("slash");var d=s.n(c),h=s(211),u=s.n(h);const g=require("node-fetch");var m=s.n(g);const p=require("node:fs/promises");var w=s(978);function f(e,t){const s=i().sync(l().join(e,"*."+t));return i().sync(l().join(e,"*/")).forEach((e=>{f(e,t).forEach((e=>{s.push(e)}))})),s}async function C(e,t,s){(await BkHelper._glob(l().join(e,"*."+t))).forEach((e=>{s.push(e)}));const r=await BkHelper._glob(l().join(e,"*/"));for(let e=0;e<r.length;e++){const o=r[e];await C(o,t,s)}}class BkHelper{static getRandomString(e){const t="abcdefghijklmnopqrstuvwxyz0123456789";let s="";for(let a=0;a<e;a++){const e=(r=0,o=t.length-1,Math.floor(Math.random()*(o-r+1))+r);s+=t.substr(e,1)}var r,o;return s}static getFilePathsSync(e,t,s){return f(l().join(e,t),s).map((t=>d()(l().relative(e,t))))}static _glob(e){return new Promise(((t,s)=>{i()(e,((e,r)=>{e?s(e):t(r)}))}))}static async getFilePaths(e,t){const s=[];await C(e,t,s);return s.map((t=>d()(l().relative(e,t))))}static currentTime(){const e=new Date,t=[e.getHours(),e.getMinutes(),e.getSeconds()],s=t.map((e=>e.toString()));for(let e=0;e<t.length;e++)t[e]<10&&(s[e]="0"+s[e]);return s.join(":")}static templateToJsString(e,t){return e.replace(/\$\{([\w.@]+)\}/g,((e,s)=>Object.prototype.hasOwnProperty.call(t,s)?`BkHelper.decodeValue('${BkHelper.encodeValue(t[s])}')`:"undefined"))}static readTextFile(e){return new Promise(((t,s)=>{o().readFile(e,"utf8",((e,r)=>{e?s(e):t(r)}))}))}static async getFileContent(e){return await BkHelper.exists2(e)?BkHelper.readTextFile(e):null}static getFileContentSync(e){return o().existsSync(e)?o().readFileSync(e,"utf8"):null}static readBinaryFile(e){return(0,w.fF)(u().blue("BkHelper.readBinaryFile"),e),new Promise(((t,s)=>{o().readFile(e,((e,r)=>{e?s(e):t(r)}))}))}static createPath(e){if(0===e.length)throw new Error("no path elements");return 1===e.length?"/":e.join("/")}static getDirPath(e){const t=e.split("/");return BkHelper.createPath(t.slice(0,t.length-1))}static async createDirIfNotExists2(e){const t=e.split("/");for(let e=1;e<=t.length;e++){const s=BkHelper.createPath(t.slice(0,e));await BkHelper.exists2(s)||await BkHelper.createDirIfNotExists(s)}}static createDirIfNotExists(e){return(0,w.fF)(u().blue("BkHelper.createDirIfNotExists"),e),new Promise(((t,s)=>{o().exists(e,(r=>{r?t():o().mkdir(e,(e=>{e?s(e):t()}))}))}))}static createDirIfNotExistsSync(e){o().existsSync(e)||o().mkdirSync(e)}static moveArrItem(e,t,s){const r=e.indexOf(t);if(-1===r)throw new Error("cannot find element");const o=r+s;if(o<0)throw new Error("cannot up top element");if(o>e.length-1)throw new Error("cannot down bottom element");e.splice(o,0,e.splice(r,1)[0])}static copyFile3(e,t){return new Promise(((s,r)=>{const a=o().createReadStream(e);a.on("error",(e=>{r(e)}));const i=o().createWriteStream(t);i.on("error",(e=>{r(e)})),i.on("close",(()=>{s()})),a.pipe(i)}))}static async exists2(e){try{return await(0,p.access)(e),!0}catch(e){if("ENOENT"===e.code)return!1;throw e}}static writeFile(e,t){return(0,w.fF)(u().blue("BkHelper.writeFile"),e),new Promise(((s,r)=>{o().writeFile(e,t,"utf8",(e=>{e?r(e):s()}))}))}static writeFileSync(e,t){return(0,w.fF)(u().blue("BkHelper.writeFileSync"),e),o().writeFileSync(e,t,"utf8")}static async writeFile2(e,t){const s=BkHelper.getDirPath(e);return await BkHelper.createDirIfNotExists2(s),await BkHelper.writeFile(e,t)}static mapObject(e,t){return Object.keys(e).reduce(((s,r)=>{const[o,a]=t(r,e[r]);return s[o]=a,s}),{})}static fsUnlink(e){return new Promise(((t,s)=>{o().unlink(e,(e=>{e?s(e):t()}))}))}static today(e){let t=Date.now();null!=e&&(t+=BkHelper.MINUTE()*e);const s=new Date(t);return t=new Date(s.getFullYear(),s.getMonth(),s.getDate()).getTime(),null!=e&&(t-=BkHelper.MINUTE()*e),new Date(t)}static dateTimeReviver(e,t){if("string"==typeof t){if(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(\.\d{3})?(Z|([+-])(\d{2}):(\d{2}))?$/.exec(t))return new Date(t)}return t}static decodeValue(e){if(void 0===e)throw new Error("decodeValue: undefined");if(null===e)throw new Error("decodeValue: null");if(""===e)throw new Error("decodeValue: empty string");try{return JSON.parse(e,BkHelper.dateTimeReviver)}catch(t){throw new Error(`decodeValue failed: ${t.message}, raw: "${e}"`)}}static encodeValue(e){return JSON.stringify(e)}static decodeObject(e){const t={};for(const s in e){if("string"!=typeof e[s])throw new Error(`cannot decode: ${s}, type: ${typeof e[s]}`);t[s]=BkHelper.decodeValue(e[s])}return t}static SECOND(){return 1e3}static MINUTE(){return 60*BkHelper.SECOND()}static HOUR(){return 60*BkHelper.MINUTE()}static DAY(){return 24*BkHelper.HOUR()}static WEEK(){return 7*BkHelper.DAY()}static addMinutes(e,t){e.setMinutes(e.getMinutes()+t)}static removeTimezoneOffset(e){BkHelper.addMinutes(e,-e.getTimezoneOffset())}static addTimezoneOffset(e){BkHelper.addMinutes(e,e.getTimezoneOffset())}static cloneDate(e){return new Date(e.getTime())}static fillArray(e){return Array.from(Array(e).keys())}static formatDate(e,t){const s=e.getFullYear(),r=e.getMonth()+1,o=e.getDate(),a=e.getHours(),i=e.getMinutes(),n=e.getSeconds(),l={YYYY:s,M:r,D:o,h:a,m:i,s:n,MM:r<10?`0${r}`:r,DD:o<10?`0${o}`:o,hh:a<10?`0${a}`:a,mm:i<10?`0${i}`:i,ss:n<10?`0${n}`:n};return t.replace(/\{([\w.]+)\}/g,((e,t)=>l[t]?l[t]:e))}static getFirstField(e){const[t]=Object.keys(e);if(!t)throw new Error("getFirstField: no fields");return e[t]}static argvAsKeyValue(e,t=2){return e.slice(t).map((e=>e.split("="))).reduce(((e,[t,s])=>(e[t]=s,e)),{})}static getWebSocketIP(e){return e.upgradeReq.headers["x-real-ip"]?e.upgradeReq.headers["x-real-ip"]:e.upgradeReq.socket.remoteAddress}static getWebSocketPort(e){return e.upgradeReq.headers["x-real-port"]?e.upgradeReq.headers["x-real-port"]:e.upgradeReq.socket.remotePort}static templateArray(e){return e.map((e=>{const t=typeof e;if("number"===t||"boolean"===t)return e;if("string"===t)return`'${e}'`;throw new Error(`wrong type for array item: ${t}`)}))}static formatNumber(e){return new Intl.NumberFormat("ru-RU").format(e)}static formatTime2(e){let t=e,s="";e<0&&(t=-t,s="-");let r=Math.floor(t/3600),o=Math.floor((t-3600*r)/60),a=Math.floor(t-3600*r-60*o);return r<10&&(r="0"+r),o<10&&(o="0"+o),a<10&&(a="0"+a),0===Math.floor(t/3600)?`${s}${o}m:${a}s`:`${s}${r}h:${o}m:${a}s`}static registerGlobalClass(e){if(global[e.name])throw new Error(`global.${e.name} already used`);global[e.name]=e}static getContentFromDataUrl(e){const[t,s]=e.split(";"),r=t.split(":")[1],o=s.split(",")[1];return[r,Buffer.from(o,"base64")]}static async post(e,t){const s=await m()(e,{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)return await s.json();throw new Error(`${s.status} ${s.statusText}: ${await s.text()}`)}}BkHelper.registerGlobalClass(BkHelper)},450:(e,t,s)=>{s.r(t),s.d(t,{ActionEditor:()=>ActionEditor,ActionEditorController:()=>ActionEditorController,ApplicationEditor:()=>ApplicationEditor,ApplicationEditorController:()=>ApplicationEditorController,BackHostApp:()=>BackHostApp,BaseModel:()=>i.g,BkAction:()=>BkAction,BkApplication:()=>BkApplication,BkCheckBoxField:()=>BkCheckBoxField,BkCheckBoxListField:()=>BkCheckBoxListField,BkColumn:()=>BkColumn,BkComboBoxField:()=>BkComboBoxField,BkDataSource:()=>BkDataSource,BkDatabase:()=>ae.P,BkDateField:()=>BkDateField,BkDateTimeField:()=>BkDateTimeField,BkField:()=>Ce.a,BkFileField:()=>BkFileField,BkForm:()=>BkForm,BkHelper:()=>a._,BkImageField:()=>BkImageField,BkLabelField:()=>BkLabelField,BkLinkField:()=>BkLinkField,BkModel:()=>N.U,BkMongoDbDatabase:()=>we.j,BkMySqlDatabase:()=>BkMySqlDatabase,BkNoSqlDataSource:()=>BkNoSqlDataSource,BkPage:()=>BkPage,BkPageLink:()=>BkPageLink,BkParam:()=>be.U,BkPasswordField:()=>BkPasswordField,BkPhoneField:()=>BkPhoneField,BkPostgreSqlDatabase:()=>BkPostgreSqlDatabase,BkRadioField:()=>BkRadioField,BkRowForm:()=>BkRowForm,BkSqlDataSource:()=>BkSqlDataSource,BkTable:()=>BkTable,BkTableForm:()=>BkTableForm,BkTextAreaField:()=>BkTextAreaField,BkTextBoxField:()=>BkTextBoxField,BkTimeField:()=>BkTimeField,CheckBoxFieldEditor:()=>CheckBoxFieldEditor,CheckBoxListFieldEditor:()=>CheckBoxListFieldEditor,ColumnEditor:()=>ColumnEditor,ColumnEditorController:()=>ColumnEditorController,ComboBoxFieldEditor:()=>ComboBoxFieldEditor,Context:()=>Context,Converter:()=>Converter,DataSourceEditor:()=>DataSourceEditor,DataSourceEditorController:()=>DataSourceEditorController,DatabaseEditor:()=>DatabaseEditor,DatabaseEditorController:()=>DatabaseEditorController,DateFieldEditor:()=>DateFieldEditor,DateTimeFieldEditor:()=>DateTimeFieldEditor,FieldEditor:()=>FieldEditor,FieldEditorController:()=>FieldEditorController,FileFieldEditor:()=>FileFieldEditor,FormEditor:()=>FormEditor,FormEditorController:()=>FormEditorController,ImageFieldEditor:()=>ImageFieldEditor,JsonFile:()=>JsonFile,KeyColumnEditor:()=>KeyColumnEditor,KeyColumnEditorController:()=>KeyColumnEditorController,LabelFieldEditor:()=>LabelFieldEditor,LinkFieldEditor:()=>LinkFieldEditor,MongoDbDatabaseEditor:()=>MongoDbDatabaseEditor,MySqlDatabaseEditor:()=>MySqlDatabaseEditor,NoSqlDataSourceEditor:()=>NoSqlDataSourceEditor,PageEditor:()=>PageEditor,PageEditorController:()=>PageEditorController,PageLinkEditor:()=>PageLinkEditor,PageLinkEditorController:()=>PageLinkEditorController,ParamEditor:()=>ParamEditor,ParamEditorController:()=>ParamEditorController,PasswordFieldEditor:()=>PasswordFieldEditor,PhoneFieldEditor:()=>PhoneFieldEditor,PostgreSqlDatabaseEditor:()=>PostgreSqlDatabaseEditor,RadioFieldEditor:()=>RadioFieldEditor,RowFormEditor:()=>RowFormEditor,SqlDataSourceEditor:()=>SqlDataSourceEditor,TableEditor:()=>TableEditor,TableEditorController:()=>TableEditorController,TableFormEditor:()=>TableFormEditor,TextAreaFieldEditor:()=>TextAreaFieldEditor,TextBoxFieldEditor:()=>TextBoxFieldEditor,TimeFieldEditor:()=>TimeFieldEditor,VisualEditorController:()=>VisualEditorController});var r={};s.r(r),s.d(r,{en:()=>j,ru:()=>S});var o={};s.r(o),s.d(o,{ActionEditor:()=>ActionEditor,ActionEditorController:()=>ActionEditorController,ApplicationEditor:()=>ApplicationEditor,ApplicationEditorController:()=>ApplicationEditorController,BackHostApp:()=>BackHostApp,BaseModel:()=>i.g,BkAction:()=>BkAction,BkApplication:()=>BkApplication,BkCheckBoxField:()=>BkCheckBoxField,BkCheckBoxListField:()=>BkCheckBoxListField,BkColumn:()=>BkColumn,BkComboBoxField:()=>BkComboBoxField,BkDataSource:()=>BkDataSource,BkDatabase:()=>ae.P,BkDateField:()=>BkDateField,BkDateTimeField:()=>BkDateTimeField,BkField:()=>Ce.a,BkFileField:()=>BkFileField,BkForm:()=>BkForm,BkHelper:()=>a._,BkImageField:()=>BkImageField,BkLabelField:()=>BkLabelField,BkLinkField:()=>BkLinkField,BkModel:()=>N.U,BkMongoDbDatabase:()=>we.j,BkMySqlDatabase:()=>BkMySqlDatabase,BkNoSqlDataSource:()=>BkNoSqlDataSource,BkPage:()=>BkPage,BkPageLink:()=>BkPageLink,BkParam:()=>be.U,BkPasswordField:()=>BkPasswordField,BkPhoneField:()=>BkPhoneField,BkPostgreSqlDatabase:()=>BkPostgreSqlDatabase,BkRadioField:()=>BkRadioField,BkRowForm:()=>BkRowForm,BkSqlDataSource:()=>BkSqlDataSource,BkTable:()=>BkTable,BkTableForm:()=>BkTableForm,BkTextAreaField:()=>BkTextAreaField,BkTextBoxField:()=>BkTextBoxField,BkTimeField:()=>BkTimeField,CheckBoxFieldEditor:()=>CheckBoxFieldEditor,CheckBoxListFieldEditor:()=>CheckBoxListFieldEditor,ColumnEditor:()=>ColumnEditor,ColumnEditorController:()=>ColumnEditorController,ComboBoxFieldEditor:()=>ComboBoxFieldEditor,Context:()=>Context,Converter:()=>Converter,DataSourceEditor:()=>DataSourceEditor,DataSourceEditorController:()=>DataSourceEditorController,DatabaseEditor:()=>DatabaseEditor,DatabaseEditorController:()=>DatabaseEditorController,DateFieldEditor:()=>DateFieldEditor,DateTimeFieldEditor:()=>DateTimeFieldEditor,FieldEditor:()=>FieldEditor,FieldEditorController:()=>FieldEditorController,FileFieldEditor:()=>FileFieldEditor,FormEditor:()=>FormEditor,FormEditorController:()=>FormEditorController,ImageFieldEditor:()=>ImageFieldEditor,JsonFile:()=>JsonFile,KeyColumnEditor:()=>KeyColumnEditor,KeyColumnEditorController:()=>KeyColumnEditorController,LabelFieldEditor:()=>LabelFieldEditor,LinkFieldEditor:()=>LinkFieldEditor,MongoDbDatabaseEditor:()=>MongoDbDatabaseEditor,MySqlDatabaseEditor:()=>MySqlDatabaseEditor,NoSqlDataSourceEditor:()=>NoSqlDataSourceEditor,PageEditor:()=>PageEditor,PageEditorController:()=>PageEditorController,PageLinkEditor:()=>PageLinkEditor,PageLinkEditorController:()=>PageLinkEditorController,ParamEditor:()=>ParamEditor,ParamEditorController:()=>ParamEditorController,PasswordFieldEditor:()=>PasswordFieldEditor,PhoneFieldEditor:()=>PhoneFieldEditor,PostgreSqlDatabaseEditor:()=>PostgreSqlDatabaseEditor,RadioFieldEditor:()=>RadioFieldEditor,RowFormEditor:()=>RowFormEditor,SqlDataSourceEditor:()=>SqlDataSourceEditor,TableEditor:()=>TableEditor,TableEditorController:()=>TableEditorController,TableFormEditor:()=>TableFormEditor,TextAreaFieldEditor:()=>TextAreaFieldEditor,TextBoxFieldEditor:()=>TextBoxFieldEditor,TimeFieldEditor:()=>TimeFieldEditor,VisualEditorController:()=>VisualEditorController});var a=s(686);class Context{constructor(e={}){this.options=e,this.connections={},this.params=Object.assign(Object.assign({},this.getQueryParams()),this.getBodyParams())}getQueryParams(){const e=this.getReq(),t=this.getAction();return e&&t&&["page","select"].includes(t)&&e.query.params?a._.decodeObject(e.query.params):{}}getBodyParams(){const e=this.getReq();return e&&e.body.params?e.body.params:{}}getRoute(){return`${this.getAppDirName()}/${this.getAppFileName()}/${this.getEnv()}/${this.getDomain()}`}getVirtualPath(){return`/${this.getModule()}/${this.getAppDirName()}/${this.getAppFileName()}/${this.getEnv()}/${this.getDomain()}`}getUser(){const e=this.getRoute();if(!this.getReq())return null;const t=this.getSession();return t.user&&t.user[e]?t.user[e]:null}getSession(){return this.getReq().session}getClientTimezoneOffset(){return"number"==typeof this.getSession().tzOffset?this.getSession().tzOffset:null}getTimeOffset(){const e=this.getClientTimezoneOffset();return null===e?null:(new Date).getTimezoneOffset()-e}getCookies(){return this.getReq().cookies||{}}getQuery(){var e;return(null===(e=this.getReq())||void 0===e?void 0:e.query)||{}}getBody(){var e;return(null===(e=this.getReq())||void 0===e?void 0:e.body)||{}}getAllParams(){const e=this.getUser(),t=this.getTimeOffset();return Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},this.getCookies()),this.getQuery()),this.params),e?{userId:e.id,userName:e.name}:{}),null!==t?{timeOffset:t}:{})}getReq(){return this.options.req}getRes(){if(!this.options.res)throw new Error("getRes: no res");return this.options.res}getModule(){return this.options.module?this.options.module:this.getReq().params.module}getDomain(){if(this.options.domain)return this.options.domain;if(this.getReq().params.domain)return this.getReq().params.domain;throw new Error("domain not defined")}getAppDirName(){return this.options.appDirName?this.options.appDirName:this.getReq().params.appDirName}getAppFileName(){return this.options.appFileName?this.options.appFileName:this.getReq().params.appFileName}getEnv(){return this.options.env?this.options.env:this.getReq().params.env}getUri(){return this.getReq().params[0]}getIp(){return Context.getIpFromReq(this.getReq())}getHost(){return this.getReq().headers.host}getProtocol(){return this.getReq().headers["x-forwarded-proto"]||"http"}setVersionHeaders(e,t){this.getRes().setHeader("qforms-platform-version",e),t&&this.getRes().setHeader("qforms-app-version",t)}getParam(e){return this.params[e]}setParam(e,t){this.params[e]=t}getParams(){return this.params}getAllParam(e){return this.getAllParams()[e]}isDebugMode(){return"1"===this.getQuery().debug}getUrl(){const e=this.getReq(),t=`${e.protocol}://${e.get("host")}${e.originalUrl}`;return new URL(t)}getAction(){let{action:e}=this.getBody();return e||(e=this.getQuery().action),e||null}static getIpFromReq(e){return e.headers["x-forwarded-for"]||e.connection.remoteAddress}getPage(){return this.getQuery().page?this.getQuery().page:null}destroy(){}}var i=s(491);const n=require("http");var l=s.n(n);const c=require("express");var d=s.n(c),h=s(211),u=s.n(h),g=s(147),m=s.n(g),p=s(17),w=s.n(p);const f=require("body-parser");var C=s.n(f);const b=require("cookie-parser");var y=s.n(b);const F=require("express-session");var E=s.n(F);const v=require("ws");var D=s.n(v);const x=require("url");var k=s.n(x),P=s(978);class WebSocketServer{constructor(e){this.options=e,this.server=new(D().Server)({server:e.httpServer,path:"/"}),this.server.on("error",this.onError.bind(this)),this.server.on("connection",this.onConnection.bind(this))}async onError(e){(0,P.vU)("WebSocketServer.onError",e)}async onConnection(e){(0,P.fF)("WebSocketServer.onConnection",e.upgradeReq.url),(0,P.cM)("wss:",u().bgYellow(u().black(decodeURIComponent(e.upgradeReq.url))));const t=k().parse(e.upgradeReq.url,!0);if(!t.query.route)throw new Error("no route");if(!t.query.uuid)throw new Error("no uuid");e.route=t.query.route,e.uuid=t.query.uuid,e.userId=t.query.userId,e.customFields={version:t.query.version},e.on("close",this.onClose.bind(this,e)),e.on("message",this.onMessage.bind(this,e));const[s,r,o,a]=t.query.route.split("/"),i=new Context({module:"viewer",appDirName:s,appFileName:r,env:o,domain:a});(await this.getHostApp().createApplicationIfNotExists(i)).addClient(e),e.send(JSON.stringify({type:"info",data:{hello:e.uuid}})),i.destroy()}async onClose(e,t,s){(0,P.fF)("WebSocketServer.onSocketClose",e.route,e.uuid,t,s),this.getHostApp().getApplicationByRoute(e.route).removeClient(e)}async onMessage(e,t,s){(0,P.fF)("WebSocketServer.onMessage",e.route,e.uuid,t,s)}getHostApp(){return this.options.hostApp}}const A=require("uuid");var N=s(484);class BkPageLink extends N.U{getPageFilePath(){return w().join(this.getParent().getDirPath(),this.getAttr("fileName"))}}class JsonFile{constructor(e,t=null){this.filePath=e,this.data=t,this.content=null}async create(){if(await a._.exists2(this.filePath))throw new Error(`File ${this.filePath} already exists`);this.data||(this.content?this.data=JSON.parse(this.content):this.data={}),this.content=JSON.stringify(this.data,null,4),await a._.writeFile2(this.filePath,this.content)}async read(){const e=await a._.readTextFile(this.filePath);this.content=e,this.data=JSON.parse(e)}async save(){(0,P.fF)("JsonFile.save",this.filePath),this.content=JSON.stringify(this.data,null,4),await a._.writeFile2(this.filePath,this.content)}getAttr(e){const t=i.g.getAttr(this.data,e);if(void 0===t)throw new Error(`no attribute '${e}'`);return t}}class HttpError extends Error{constructor(e){super(e.message),this.context=e.context,this.status=e.status,this.data=e.data}}var _=s(224);const j=JSON.parse('{"login":{"login":"Login","username":"Username","password":"Password","signIn":"Sign in","WrongUsernameOrPassword":"Wrong username or password"},"application":{"logout":"Logout","error":"Error","alert":"Alert","confirm":"Confirm","versionNotification":"New version is available. Please refresh page."},"page":{"create":"Create","cancel":"Cancel","saveAndClose":"Save and close","save":"Save","close":"Close","refresh":"Refresh","discard":"Discard","actions":"Actions","select":"Select","reset":"Reset"},"form":{"refresh":"Refresh","new":"New","delete":"Delete","areYouSure":"Are you sure?","count":"Count","previous":"Previous","next":"Next","edit":"Edit","save":"Save","cancel":"Cancel","discard":"Discard","actions":"Actions","required":"required","phoneNumberFormatError":"phone number format error"},"field":{"selectValue":"select value","fillValue":"fill in this field","timeNotValid":"time not valid","clear":"Clear"},"error":{"notNumber":"not a number","invalidDate":"invalid date"},"confirm":{"yes":"Yes","no":"No"}}'),S=JSON.parse('{"login":{"login":"Вход","signIn":"Войти","username":"Логин","password":"Пароль","WrongUsernameOrPassword":"Неверный логин или пароль"},"application":{"logout":"Выйти","error":"Ошибка","alert":"Внимание!","confirm":"Подтверждение","versionNotification":"Доступна новая версия. Пожалуйста обновите страницу."},"page":{"create":"Создать","cancel":"Отмена","saveAndClose":"Сохранить и закрыть","save":"Сохранить","close":"Закрыть","refresh":"Обновить","discard":"Сбросить","actions":"Действия","select":"Выбрать","reset":"Сбросить"},"form":{"refresh":"Обновить","new":"Создать","delete":"Удалить","areYouSure":"Вы уверены?","count":"Количество","previous":"Предыдущая","next":"Следующая","edit":"Редактировать","save":"Сохранить","cancel":"Отменить","discard":"Сбросить","actions":"Действия","required":"обязательно","phoneNumberFormatError":"неверный формат номера"},"field":{"selectValue":"выберите значение","fillValue":"заполните поле","timeNotValid":"ошибка ввода времени","clear":"Очистить"},"error":{"notNumber":"требуется числовое значение","invalidDate":"неверный формат даты"},"confirm":{"yes":"Да","no":"Нет"}}');var B;!function(e){e.debug="debug",e.log="log",e.warn="warn",e.error="error"}(B||(B={}));const M=[B.debug,B.log,B.warn,B.error];const O=new Proxy(console,{get:function(e,t,s){return"function"==typeof e[t]?function(...r){if(M.indexOf(t)>=M.indexOf("object"==typeof window?window.QFORMS_LOG_LEVEL||"debug":"object"==typeof global?process.env.QFORMS_LOG_LEVEL||("dev"===process.env.NODE_ENV?"debug":"log"):"debug")){if("undefined"==typeof jest)return e[t].apply(s,r);"error"===t?process.stderr.write(`${r.join(" ")}\n`):process.stdout.write(`${r.join(" ")}\n`)}}:e[t]}}),R=s(598);class BkApplication extends N.U{constructor(e,t,s="local"){if(super(e.appFile.data),this.appInfo=e,this.hostApp=t,this.env=s,this.databases=[],this.actions=[],this.dataSources=[],this.pages={},this.clients=[],!t)throw new Error("BkApplication: no hostApp")}async init(e){await super.init(e),await this.createColItems("databases",e),await this.createColItems("actions",e),await this.createColItems("dataSources",e),this.links=await this.getLinks(e),this.scripts=await this.getScripts(e),await this.createMenu(e)}getHostApp(){return this.hostApp}async getLinks(e){const t=e.getVirtualPath();return(await a._.getFilePaths(this.getPublicDirPath(),"css")).map((e=>`${t}/${e}`))}async getScripts(e){const t=e.getVirtualPath(),s=this.getPublicDirPath();return(0,P.fF)("publicDirPath:",s),(await a._.getFilePaths(s,"js")).map((e=>`${t}/${e}`))}async deinit(){(0,P.fF)(`Application.deinit: ${this.getName()}`),await super.deinit();for(const e of this.databases)await e.deinit()}getDirPath(){return this.appInfo.dirPath}getPublicDirPath(){const e=this.getDirPath();return w().join(e,"public")}getText(){const e=this.getAttr("lang")||"en";return r[e]}getVersion(){return null}fillAttributes(e){e.class=this.getClassName(),e.name=this.getAttr("name"),e.caption=this.getAttr("caption"),e.lang=this.getAttr("lang"),e.theme=this.getAttr("theme"),e.cssBlock=this.getAttr("cssBlock"),e.viewClass=this.getAttr("viewClass"),e.ctrlClass=this.getAttr("ctrlClass")}async fill(e){const t=Date.now(),s=await super.fill(e);return s.route=e.getRoute(),s.domain=e.getDomain(),s.virtualPath=e.getVirtualPath(),s.logErrorUrl=this.getHostApp().getFrontLogUrl()||"/error",s.versions={platform:R.version,app:this.getVersion()},await this.fillCollection(s,"databases",e),await this.fillCollection(s,"actions",e),await this.fillCollection(s,"dataSources",e),s.nodeEnv=this.getHostApp().getNodeEnv(),s.text=this.getText(),s.menu=this.menu,s.nav=this.nav,s.uuid=(0,A.v4)(),s.actions=this.getCol("actions").map((e=>({name:i.g.getName(e),caption:i.g.getAttr(e,"caption")}))),s.pages=await this.fillPages(e),s.user=this.isAuthentication()?await this.getClientUserFromServerUser(e):null,s.time=Date.now()-t,s}async getClientUserFromServerUser(e){const t=e.getUser();if(!t)throw new Error("getClientUserFromServerUser: no server user");return{id:t.id,login:t.name}}async createMenu(e){const t={},s={},r=this.getItemNames("pageLinks");for(const e of r){const r=this.createPageLink(e),o=r.getAttr("menu");if(o){const e=r.getPageFilePath(),a=new JsonFile(e);await a.read(),t[o]||(t[o]=[]),t[o].push({type:"page",page:r.getAttr("name"),caption:a.getAttr("caption")}),s[o]||(s[o]=[]),s[o].push({page:r.getAttr("name"),caption:a.getAttr("caption")})}}const o=this.getCol("actions");o.length&&(t.Actions=o.map((e=>({type:"action",action:i.g.getName(e),caption:i.g.getAttr(e,"caption")})))),this.menu=t,this.nav=s}createPageLink(e){const t=this.getColItemData("pageLinks",e);return new BkPageLink(t,this)}async createPage(e,t){if(!this.isData("pageLinks",t))throw new Error(`no page with name: ${t}`);const s=this.createPageLink(t).getAttr("fileName"),r=w().join(this.getDirPath(),s),o=await a._.readTextFile(r),i=JSON.parse(o),n=await this.createChildModel("pages",i);return await n.init(e),n}authorizePage(e,t){return!0}async getPage(e,t){O.debug("Application.getPage",t);const s=e.getUser();if(s&&!1===this.authorizePage(s,t))throw new Error("authorization error");return this.pages[t]?this.pages[t]:this.pages[t]=await this.createPage(e,t)}getStartupPageLinkNames(){return this.getCol("pageLinks").filter((e=>"true"===i.g.getAttr(e,"startup"))).map((e=>i.g.getName(e)))}getPageLinksToFill(e){const t=e.getPage();return t?[t]:this.getStartupPageLinkNames()}async fillPages(e){const t=[],s=this.getPageLinksToFill(e);for(const r of s){const s=await this.getPage(e,r),o=await s.fill(e);t.push(o)}return t}async authenticate(e,t,s){return(0,P.fF)("Application.authenticate"),t===this.getAttr("user")&&s===this.getAttr("password")?{id:1,name:t}:null}isAuthentication(){return"true"===this.getAttr("authentication")}async getUsers(e){return null}async rpc(e,t){if((0,P.fF)("BkApplication.rpc",e,t.getBody()),this[e])return await this[e](t);throw new HttpError({message:`no remote proc ${this.constructor.name}.${e}`,data:{method:`${this.constructor.name}.rpc`},context:t})}getEnv(){return this.env}getEnvVarValue(e){if(!e)throw new Error("no name");const t=this.getEnv(),s=this.data.env[t];if(!s)throw new Error(`no env ${t}`);if(s[e])return s[e];throw new Error(`no env ${e} in ${t}`)}getApp(){return this}findDatabase(e){return this.databases.find((t=>t.getName()===e))}getDatabase(e){const t=this.findDatabase(e);if(!t)throw new Error(`no database with name: ${e}`);return t}async initContext(e){}static makeAppInfoFromAppFile(e){const{data:t,filePath:s}=e,r=w().basename(w().dirname(s)),o=w().basename(s,w().extname(s));return{appFile:e,name:i.g.getName(t),caption:i.g.getAttr(t,"caption"),fullName:(0,p.join)(r,o),envs:BkApplication.getEnvList(t),dirName:r,fileName:o,filePath:w().resolve(s),fileNameExt:w().basename(s),extName:w().extname(s),dirPath:w().resolve(w().dirname(s))}}static async loadAppInfo(e){(0,P.fF)("Application.loadAppInfo",e);const t=new JsonFile(e);await t.read();return BkApplication.makeAppInfoFromAppFile(t)}static async getAppInfos(e){const t=await a._._glob(w().join(e,"*/*.json")),s=[];for(let e=0;e<t.length;e++){const r=t[e],o=await BkApplication.loadAppInfo(r);o&&s.push(o)}return s}findDataSource(e){return this.dataSources.find((t=>t.getName()===e))}getDataSource(e){const t=this.findDataSource(e);if(!t)throw new Error(`${this.getName()}: no data source ${e}`);return t}getViewClassName(){return this.getAttr("viewClass")||"ApplicationView"}async connect(e){try{for(const t of this.databases)await t.connect(e)}catch(t){for(const t of this.databases)t.isConnected(e)&&await t.release(e);throw t}}async release(e){for(const t of this.databases)await t.release(e)}addClient(e){this.clients.push(e)}removeClient(e){const t=this.clients.indexOf(e);if(-1===t)throw new Error(`cannot find socket: ${e.route} ${e.uuid}`);this.clients.splice(t,1)}broadcastDomesticResultToClients(e,t){if((0,P.fF)("Application.broadcastDomesticResultToClients",e.getReq().body.uuid,t),!e.getReq().body.uuid)throw new Error("no uuid");if(!t)throw new Error("no result");const s=e.getReq().body.uuid;for(const e of this.clients)e.uuid!==s&&e.send(JSON.stringify({type:"result",data:t}))}broadcastForeignResultToClients(e,t){if((0,P.fF)("Application.broadcastForeignResultToClients",e.getReq().body.uuid,t),!e.getReq().body.uuid)throw new Error("no uuid");if(!t)throw new Error("no result");const s=this.composeForeignResult(t);if(s){const t=e.getReq().body.uuid;for(const e of this.clients)e.uuid!==t&&e.send(JSON.stringify({type:"result",data:s}))}}composeForeignResult(e){let t=null;for(const s in e){const r=this.findDatabase(s);if(r)for(const o in e[s]){r.findTable(o)&&(t||(t=new _.x4),t[s]||(t[s]={}),t[s][o]={refresh:!0})}}return t}getTitle(e){return this.getAttr("caption")}getLoginViewClassName(){return"LoginView"}isAvailable(){return!0}async handleGetFile(e,t){const s=w().join(this.getPublicDirPath(),e.getUri());O.debug(`filePath: ${s}`),await a._.exists2(s)?e.getRes().sendFile(s):(e.getRes().status(404).end("Not Found"),await this.getHostApp().logError(new Error(`not found ${e.getUri()}`),e.getReq()))}renderIndexHtml(e,t,s,r,o,a,i){return((e,t,s,r,o,a,i,n)=>`<!DOCTYPE html>\n<html class="${e.getViewClassName()} ${e.getAttr("theme")} ${"1"===t.getQuery().debug?"debug":""} ${"1"===t.getQuery().frame?"iframe":"not-iframe"}" lang="${e.getAttr("lang")}">\n<head>\n    \x3c!-- qforms v${r} --\x3e\n    \x3c!-- app v${e.getVersion()}  --\x3e\n    <meta charset="utf-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>${s.getTitle()}</title>\n    \x3c!-- links --\x3e\n    ${o}\n    \x3c!-- scripts --\x3e\n    ${a}\n    <script>\n        document.addEventListener('DOMContentLoaded', async () => {\n            const dataScriptElement = document.querySelector('script[type="application/json"]');\n            const data = JSON.parse(dataScriptElement.textContent);\n            const frontHostApp = new ViewerFrontHostApp({data});\n            frontHostApp.init();\n            await frontHostApp.run();\n        });\n    <\/script>\n    <script type="application/json">${JSON.stringify(i)}<\/script>\n</head>\n<body class="${e.getViewClassName()}__body">\n    <div class="${e.getViewClassName()}__root">${n}</div>\n    <div class="alert-root"></div>\n</body>\n</html>`)(this,e,t,s,r,o,a,i)}static getEnvList(e){return["local",...e.env?Object.keys(e.env).filter((e=>"local"!==e)):[]]}}var T=s(997);const V=require("react-dom/server");var $=s.n(V);const I=({links:e})=>(0,T.jsx)(T.Fragment,{children:e.map(((e,t)=>"string"==typeof e?(0,T.jsx)("link",{rel:"stylesheet",href:e},t):"object"==typeof e?(0,T.jsx)("link",{rel:e.rel,href:e.href,crossOrigin:e.crossorigin?"anonymous":void 0},t):void 0))}),L=({scripts:e})=>(0,T.jsx)(T.Fragment,{children:e.map(((e,t)=>(0,T.jsx)("script",{type:"text/javascript",src:e},t)))}),q=s(598);class MonitorModule{constructor(e){this.hostApp=e}async init(){this.css=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"monitor/public"),"css")).map((e=>`/monitor/public/${e}`)),this.js=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"monitor/public"),"js")).map((e=>`/monitor/public/${e}`))}fill(){return{nodeEnv:this.hostApp.getNodeEnv(),uptime:Date.now()-this.hostApp.startTime.getTime(),applications:Object.keys(this.hostApp.applications).map((e=>{const t=this.hostApp.applications[e];return{route:e,version:t.getVersion(),pages:Object.keys(t.pages).map((e=>({name:e}))),clients:t.clients.map((e=>({uuid:e.uuid,userId:e.userId,ip:a._.getWebSocketIP(e),version:e.customFields.version})))}}))}}getLinks(){return this.css}getScripts(){return this.js}checkCredentials(e){const t=e.headers.authorization.substr(6),s=new Buffer(t,"base64").toString(),[r,o]=s.split(":");return r===this.hostApp.getParams().monitor.username&&o===this.hostApp.getParams().monitor.password}authorize(e){if(this.hostApp.isDevelopment())return!0;if(!this.hostApp.getParams().monitor)throw new Error("no monitor params");return e.headers.authorization&&"Basic"===e.headers.authorization.substr(0,5)&&this.checkCredentials(e)}render(){const e=$().renderToStaticMarkup((0,T.jsx)(I,{links:this.getLinks()})),t=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:this.getScripts()})),s=JSON.stringify(this.fill());return`<!DOCTYPE html>\n<html class="monitor" lang="en">\n<head>\n    \x3c!-- ${q.version}> --\x3e\n    <meta charSet="utf-8">\n    <title>QForms monitor v${q.version}</title>\n    \x3c!-- links --\x3e\n    ${e}\n    \x3c!-- scripts --\x3e\n    ${t}\n    <script type="application/json">${s}<\/script>\n</head>\n<body class="monitor__body">\n    <div class="monitor__root"></div>\n</body>\n</html>`}}const H=s(598);class IndexModule{constructor(e){this.hostApp=e}async init(){this.css=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"index/public"),"css")).map((e=>`/index/public/${e}`)),this.js=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"index/public"),"js")).map((e=>`/index/public/${e}`))}async fill(){const e=await BkApplication.getAppInfos(this.hostApp.appsDirPath);return{nodeEnv:this.hostApp.getNodeEnv(),appInfos:e.map((e=>({fullName:e.fullName,envs:e.envs})))}}getLinks(){return this.css}getScripts(){return this.js}async render(){const e=$().renderToStaticMarkup((0,T.jsx)(I,{links:this.getLinks()})),t=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:this.getScripts()})),s=await this.fill(),r=JSON.stringify(s);return`<!DOCTYPE html>\n<html>\n<head>\n    \x3c!-- ${H.version}> --\x3e\n    <meta charSet="utf-8">\n    <title>QForms v${H.version}</title>\n    \x3c!-- links --\x3e\n    ${e}\n    \x3c!-- scripts --\x3e\n    ${t}\n    <script type="application/json">${r}<\/script>\n    \x3c!--<script>\n        document.addEventListener('DOMContentLoaded', () => {\n            // console.debug('DOMContentLoaded');\n            const data = JSON.parse(document.querySelector('script[type="application/json"]').textContent);\n            new IndexFrontHostApp(data).init();\n        });\n    <\/script>--\x3e\n</head>\n<body>\n<div id="root"></div>\n</body>\n</html>`}}var W=s(689),U=s.n(W),K=s(274),G=s(367);const z=(e,t,s,r,o,a)=>`<!DOCTYPE html>\n<html class="${s.getLoginViewClassName()}" lang="${s.getAttr("lang")}">\n<head>\n\x3c!-- qforms v${e} --\x3e\n\x3c!-- app v${s.getVersion()}  --\x3e\n<meta charset="utf-8">\n<meta name="viewport" content="width=device-width, initial-scale=1.0">\n<title>${s.getTitle(t)} - ${s.getText().login.login}</title>\n\x3c!-- links --\x3e\n${r}\n\x3c!-- scripts --\x3e\n${o}\n<script>\n    document.addEventListener('DOMContentLoaded', async () => {\n        const data = JSON.parse(document.querySelector('script[type="application/json"]').textContent);\n        const frontHostApp = new LoginFrontHostApp(data);\n        frontHostApp.init();\n        await frontHostApp.run();\n    });\n<\/script>\n<script type="application/json">${JSON.stringify(a)}<\/script>\n</head>\n<body class="${s.getLoginViewClassName()}__body">\n<div class="${s.getLoginViewClassName()}__root"></div>\n</body>\n</html>`;var Q=s(587);s(834);const J=s(598),Y=["insert","select","update","_delete","page","rpc","logout","test"];class ViewerModule{constructor(e){this.hostApp=e}async init(){if(this.css=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"viewer/public"),"css")).map((e=>`/viewer/public/${e}`)),this.js=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"viewer/public"),"js")).map((e=>`/viewer/public/${e}`)),(0,P.fF)("ViewerModule.css:",this.css),(0,P.fF)("ViewerModule.js:",this.js),!this.js.length)throw new Error("no qforms js")}getLinks(){return this.css}getScripts(){return this.js}async handleGet(e,t){O.debug("ViewerModule.handleGet",e.getDomain(),e.getReq().url,e.getReq().params,e.getQuery());const s=e.getSession();if(!t.isAuthentication()||s.user&&s.user[e.getRoute()]){e.setVersionHeaders(J.version,t.getVersion());const s=e.getAction();"page"===s?await this.page(e,t):"select"===s?await this.select(e,t):await this.index(e,t)}else await this.loginGet(e,t)}async handlePost(e,t){const{action:s}=e.getBody();if("login"===s)await this.loginPost(e,t);else{const s=e.getUser();if(t.isAuthentication()&&!s)throw new HttpError({message:"Unauthorized",status:401,context:e});await this.handleAction(e,t)}}async handlePatch(e,t){const s=e.getUser();if(t.isAuthentication()&&!s)throw new HttpError({message:"Unauthorized",status:401,context:e});await this.handleAction(e,t)}async handleDelete(e,t){const s=e.getUser();if(t.isAuthentication()&&!s)throw new HttpError({message:"Unauthorized",status:401,context:e});await this.handleAction(e,t)}async handleAction(e,t){const s=e.getAction();if(!s)throw new Error("no action");if(-1===Y.indexOf(s))throw new Error(`unknown action: ${s}`);e.setVersionHeaders(J.version,t.getVersion()),await this[s](e,t)}async renderHtml(e,t){(0,P.fF)("ViewerModule.renderHtml");const s=$().renderToStaticMarkup((0,T.jsx)(I,{links:[...this.getLinks(),...e.links]})),r=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:[...this.getScripts(),...e.scripts]})),o=await e.fill(t),a=new Q.Qh({debug:t.isDebugMode(),url:t.getUrl(),cookies:t.getCookies()}),i=new K.M(o);i.init();const n=G._.create(i,a);n.init();const l=U().createElement(n.getViewClass(),{ctrl:n}),c=$().renderToString(l);return e.renderIndexHtml(t,n,J.version,s,r,o,c)}async loginGet(e,t){(0,P.fF)("ViewerModule.loginGet");const s=$().renderToStaticMarkup((0,T.jsx)(I,{links:[...this.getLinks(),...t.links]})),r=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:[...this.getScripts(),...t.scripts]})),o=z(J.version,e,t,s,r,{name:t.getName(),text:t.getText(),title:t.getTitle(e),errMsg:null,username:e.getQuery().username});e.getRes().end(o)}async loginPost(e,t){(0,P.fF)("ViewerModule.loginPost");const{tzOffset:s,username:r,password:o}=e.getBody();if(void 0===s)throw new Error("no tzOffset");if(void 0===r)throw new Error("no username");if(void 0===o)throw new Error("no password");const i=e.getReq(),n=e.getRes();await t.connect(e);try{const l=await t.authenticate(e,r,o);if(l){if(!l.id)throw new Error("no user id");if(!l.name)throw new Error("no user name");const r=e.getSession();void 0===r.user&&(r.user={}),r.user[e.getRoute()]=l,r.ip=e.getIp(),r.tzOffset=a._.decodeValue(s),n.redirect(i.url),this.getHostApp().logEvent(e,`login ${t.getName()}/${e.getDomain()} ${l.name}`)}else{const s=$().renderToStaticMarkup((0,T.jsx)(I,{links:[...this.getLinks(),...t.links]})),a=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:[...this.getScripts(),...t.scripts]})),i=z(J.version,e,t,s,a,{name:t.getName(),text:t.getText(),title:t.getTitle(e),errMsg:t.getText().login.WrongUsernameOrPassword,username:r,password:o});n.status(401).end(i)}}finally{await t.release(e)}}async index(e,t){(0,P.fF)("ViewerModule.index");const s=e.getRes();await t.connect(e);try{await t.initContext(e);const r=await this.renderHtml(t,e);s.setHeader("Content-Type","text/html; charset=utf-8").end(r)}finally{await t.release(e)}}async page(e,t){(0,P.fF)("ViewerModule.page",e.getReq().body.page);const s=e.getQuery().page;await t.connect(e);try{await t.initContext(e);const r=await t.getPage(e,s),o=await r.fill(e);if(void 0===o)throw new Error("page action: pageData is undefined");const a={page:o};e.getRes().json(a)}finally{await t.release(e)}}async select(e,t){(0,P.fF)("ViewerModule.select",e.getBody().page);const{page:s,form:r,ds:o}=e.getQuery(),a=Date.now(),i=await this.getDataSource(e,t,{page:s,form:r,ds:o});await i.getDatabase().use(e,(async s=>{await t.initContext(e);const[r,o]=await i.read(e),n=Date.now()-a;(0,P.fF)("select time:",n);const l={rows:r,count:o,time:n};e.getRes().json(l)}))}async getDataSource(e,t,{page:s,form:r,ds:o}){if(s){const a=await t.getPage(e,s);return r?a.getForm(r).getDataSource(o):a.getDataSource(o)}return t.getDataSource(o)}async insert(e,t){(0,P.fF)("ViewerModule.insert",e.getReq().body.page);const s=e.getBody(),r=(await t.getPage(e,s.page)).getForm(s.form).getDataSource("default");await r.getDatabase().use(e,(async s=>{await t.initContext(e);const o=await s.transaction(e,(async()=>{const t=await r.create(e);if(void 0===t)throw new Error("insert action: result is undefined");return t}));e.getRes().status(201).json(o),this.hostApp.broadcastResult(t,e,o)}))}async update(e,t){(0,P.fF)("ViewerModule.update",e.getReq().body.page);const s=e.getBody(),r=(await t.getPage(e,s.page)).getForm(s.form).getDataSource("default");await r.getDatabase().use(e,(async s=>{await t.initContext(e);const o=await s.transaction(e,(async()=>{const t=await r.update(e);if(void 0===t)throw new Error("action update: result is undefined");return t}));e.getRes().json(o),this.hostApp.broadcastResult(t,e,o)}))}async _delete(e,t){(0,P.fF)("ViewerModule._delete",e.getReq().body.page);const s=e.getBody(),r=(await t.getPage(e,s.page)).getForm(s.form).getDataSource("default");await r.getDatabase().use(e,(async s=>{await t.initContext(e);const o=await s.transaction(e,(async()=>{const t=await r.delete(e);if(void 0===t)throw new Error("delete result is undefined");return t}));e.getRes().json(o),this.hostApp.broadcastResult(t,e,o)}))}static async getModel(e,t){const s=e.getBody();if(s.page){const r=await t.getPage(e,s.page);return s.form?r.getForm(s.form):r}return t}async rpc(e,t){(0,P.fF)("ViewerModule.rpc",e.getReq().body);const s=e.getBody(),r=e.getRes(),o=await ViewerModule.getModel(e,t);try{const a=await o.rpc(s.name,e);if(void 0===a)throw new Error("rpc action: result is undefined");if(Array.isArray(a)){const[s,o]=a;if(r.json(s),!(o instanceof _.x4))throw new Error("_result is not Result");this.hostApp.broadcastResult(t,e,o)}else r.json(a),a instanceof _.x4&&this.hostApp.broadcastResult(t,e,a)}catch(t){const o=t.message;t.message=`rpc error ${s.name}: ${t.message}`,t.context=e,await this.hostApp.logError(t,e.getReq()),r.json({errorMessage:o})}}async logout(e,t){(0,P.fF)("ViewerModule.logout");const s=e.getUser(),r=e.getRoute();if(!s)throw new Error(`no user for route ${r}`);const o=e.getSession();!function(e,t){delete e.user[t]}(o,r),await function(e){return new Promise(((t,s)=>{e.save((e=>{e?s(e):t()}))}))}(o),e.getRes().json(null)}async test(e,t){(0,P.fF)("ViewerModule.test",e.getReq().body),e.getRes().json(null)}async handleGetFile(e,t,s){await t.handleGetFile(e,s)}getHostApp(){return this.hostApp}}const Z=s(598),X=["Application","Database","Param","Table","Column","DataSource","KeyColumn","Page","PageLink","Form","Field","Action"],ee=["save","_new","delete","getView","saveView","saveController","createView","createStyle","createController","get","getTableInfo","changeClass","moveUp","moveDown","createModelBackJs"];class EditorModule{constructor(e){this.hostApp=e}async init(){this.css=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"editor/public"),"css")).map((e=>`/editor/public/${e}`)),this.js=(await a._.getFilePaths(w().join(this.hostApp.getFrontendDirPath(),"editor/public"),"js")).map((e=>`/editor/public/${e}`))}getLinks(){return["/lib/codemirror-4.8/lib/codemirror.css","/lib/codemirror-4.8/theme/cobalt.css",...this.css]}getScripts(){return["/lib/codemirror-4.8/lib/codemirror.js","/lib/codemirror-4.8/mode/javascript/javascript.js",...this.js]}async handleEditorGet(e,t,s){(0,P.fF)("EditorModule.handleEditorGet");const r={app:(await BkApplication.loadAppInfo(this.hostApp.getSrcAppFilePath(s))).appFile.data,nodeEnv:this.hostApp.getNodeEnv(),logErrorUrl:"/error"},o=$().renderToStaticMarkup((0,T.jsx)(I,{links:this.getLinks()})),a=$().renderToStaticMarkup((0,T.jsx)(L,{scripts:this.getScripts()})),i=((e,t,s,r,o,a,i,n)=>`<!DOCTYPE html>\n<html class="editor" lang="en">\n<head>\n\x3c!-- ${e} --\x3e\n<meta charset="utf-8">\n<title>${r}/${o}[${a}] - QForms Editor</title>\n\x3c!-- links --\x3e\n${i}\n\x3c!-- scripts --\x3e\n${n}\n\x3c!--<script type="text/javascript">\n    document.addEventListener('DOMContentLoaded', async () => {\n        console.debug('editor.ejs DOMContentLoaded');\n        const data = JSON.parse(document.querySelector('script[type="application/json"]').textContent);\n        const runAppLink = "${s}";\n        const editorFrontHostApp = new EditorFrontHostApp(data, runAppLink);\n        editorFrontHostApp.init();\n        await editorFrontHostApp.run();\n    });\n<\/script>--\x3e\n<script type="application/json">${JSON.stringify(t)}<\/script>\n</head>\n<body class="editor__body">\n<div class="editor__root"></div>\n</body>\n</html>\n`)(Z.version,Object.assign(Object.assign({},r),{runAppLink:`/viewer/${s.getAppDirName()}/${s.getAppFileName()}/${s.getEnv()}/${s.getDomain()}/?debug=1`}),`/viewer/${s.getAppDirName()}/${s.getAppFileName()}/${s.getEnv()}/${s.getDomain()}/?debug=1`,s.getAppDirName(),s.getAppFileName(),s.getEnv(),o,a);t.setHeader("Content-Type","text/html; charset=utf-8").end(i)}async handleEditorPost(e,t,s){(0,P.fF)("EditorModule.handleEditorPost",e.body);const r=e.body;if(-1===X.indexOf(r.controller))throw new Error(`unknown controller: ${r.controller}`);if(-1===ee.indexOf(r.action))throw new Error(`unknown action ${r.action}`);const a=`${r.controller}EditorController`,i=o[a];if(!i)throw new Error(`no class with name ${a}`);const n=new i(await BkApplication.loadAppInfo(this.hostApp.getSrcAppFilePath(s)),this.hostApp,null);await n.init(s);const l=r.action;if(!n[l])throw new Error(`no method: ${a}.${l}`);const c=await n[l](s.getParams());if(void 0===c)throw new Error("handleEditorPost: result is undefined");t.json(c)}}class FileSessionStore extends F.Store{constructor(e){super(),this.dirPath=e,this.store={}}set(e,t,s){(0,P.fF)("FileSessionStore.set",e,t),this.store[e]=t;const r=w().join(this.dirPath,`${e}.json`),o=JSON.stringify(t,null,4);a._.writeFile(r,o).then((()=>s(null))).catch((e=>s(e)))}get(e,t){const s=this.store[e];if(s)t(null,s);else{const s=w().join(this.dirPath,`${e}.json`);a._.getFileContent(s).then((s=>{if(s)try{const r=this.store[e]=JSON.parse(s);t(null,r)}catch(e){t(e)}else t(null,null)}))}}destroy(e,t){(0,P.fF)("FileSessionStore.destroy",e),delete this.store[e],t(null)}}const te=s(632);class Editor extends i.g{constructor(e,t,s){super(e,t),this.editorPath=s}getEditorPath(){if(!this.editorPath)throw new Error(`${this.constructor.name}: no editorPath`);return this.editorPath}async createFileByParams(e,t,s){if(await a._.exists2(e))throw new Error(`File ${w().basename(e)} already exists.`);const r=await a._.readTextFile(t),o=te.render(r,s);return await a._.writeFile2(e,o),o}async getFile(e){(0,P.fF)("Editor.getFile",e);if(await a._.exists2(e))return await a._.readTextFile(e)}async saveFile(e,t){if(!await a._.exists2(e))throw new Error("File {path.basename(filePath)} doesn't exist.");await a._.writeFile2(e,t)}async getCustomFile(e){(0,P.fF)("Editor.getCustomFile",e);const t=await this.getCustomFilePath(e);return this.getFile(t)}async saveCustomFile(e,t){const s=await this.getCustomFilePath(e);await this.saveFile(s,t)}async getCustomFilePath(e){const t=await this.getCustomDirPath();return"js"===e?w().join(t,"Controller.front.ts"):"jsx"===e?w().join(t,"View.tsx"):"less"===e?w().join(t,"View.less"):w().join(t,this.getName()+"."+e)}moveDataColItem(e,t,s){a._.moveArrItem(this.getCol(e),this.getColItemData(e,t),s)}setColData(e,t){return this.getParent().replaceDataColItem(e,this.data,t)}createItemEditor(e,t){const s=this.getColItemData(e,t),r=i.g.getClassName(s);return new(0,o[`${r}Editor`])(s,this,this.editorPath)}async getCustomDirPath(){const e=await this.getCollectionDirPath();return w().join(e,this.getName())}async getCollectionDirPath(){throw new Error("Editor.getCollectionDirPath not implemented")}moveItemUp(e,t){this.moveDataColItem(e,t,-1)}moveItemDown(e,t){this.moveDataColItem(e,t,1)}newItemData(e,t,s){(0,P.fF)("Editor.newItemData",e,t,s);const{name:r}=s;if(!r)throw new Error("no name");const a=`${e}Editor`,i=o[a];if(!i)throw new Error(`no class ${a}`);const n=i.createData(s);return this.addModelData(t,n),n}getColName(){throw new Error(`${this.constructor.name}.getColName not implemented`)}static createItemData(e){try{const t=e["@attributes"]?Object.assign(Object.assign({class:i.g.getClassName(e)},i.g.attributes(e)),e):e;if(!t.class){const t=e["@attributes"]?i.g.getName(e):e.name;throw new Error(`${t}: no class in data`)}return o[`${t.class}Editor`].createData(t)}catch(t){const s=e["@attributes"]?i.g.getName(e):e.name;throw t.message=`${s}: ${t.message}`,t}}}class PageEditor extends Editor{constructor(e,t,s){super(t.data,e,s),this.appEditor=e,this.pageFile=t}static createData(e){return{"@class":"Page","@attributes":{formatVersion:"0.1",name:e.name,caption:void 0!==e.caption?e.caption:e.name,cssBlock:void 0!==e.cssBlock?e.cssBlock:"",viewClass:void 0!==e.viewClass?e.viewClass:"",ctrlClass:void 0!==e.ctrlClass?e.ctrlClass:"",modelClass:void 0!==e.modelClass?e.modelClass:"",formInTab:void 0!==e.formInTab?e.formInTab:"false"},dataSources:[...e.dataSources?e.dataSources.map(Editor.createItemData):[]],actions:[...e.actions?e.actions.map(Editor.createItemData):[]],forms:[...e.forms?e.forms.map(Editor.createItemData):[]]}}setAttr(e,t){if((0,P.fF)("PageEditor.setAttr",e,t),"name"===e){this.appEditor.createItemEditor("pageLinks",this.getName()).setAttr(e,t)}super.setAttr(e,t)}async save(){await this.pageFile.save()}async createJs(e){const t=w().join(this.getEditorPath(),"Editor/PageEditor/Page.js.ejs"),s=await this.getCustomFilePath("js");return await this.createFileByParams(s,t,{page:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createJsx(e){const t=w().join(this.getEditorPath(),"Editor/PageEditor/Page.jsx.ejs"),s=await this.getCustomFilePath("jsx");return await this.createFileByParams(s,t,{page:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createLess(e){const t=w().join(this.getEditorPath(),"Editor/PageEditor/Page.less.ejs"),s=await this.getCustomFilePath("less");return await this.createFileByParams(s,t,{page:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createModelBackJs(e){const t=w().join(await this.getCustomDirPath(),"Model.back.ts"),s=w().join(this.getEditorPath(),"Editor/PageEditor/Model.back.ts.ejs");return await this.createFileByParams(t,s,{name:this.getName()})}async getCustomDirPath(){(0,P.fF)("PageEditor.getCustomDirPath");const e=await this.getParent().getCustomDirPath();return w().join(e,"pages",this.getName())}reformat(){this.data=this.pageFile.data=PageEditor.createData(Object.assign(Object.assign({},this.attributes()),{dataSources:this.data.dataSources,actions:this.data.actions,forms:this.data.forms}))}}class ApplicationEditor extends Editor{constructor(e,t){super(e.data,void 0,t),this.appFile=e,this.appInfo=BkApplication.makeAppInfoFromAppFile(e)}getAppFile(){return this.data,this.appFile}static createData(e){if(!e.name)throw new Error("no name");return{"@class":"Application","@attributes":{formatVersion:"0.1",name:e.name,caption:e.caption||e.name,authentication:e.authentication||"false",user:e.user||"admin",password:e.password||"admin",lang:e.lang||"en",theme:e.theme||"standard",cssBlock:void 0!==e.cssBlock?e.cssBlock:"",viewClass:void 0!==e.viewClass?e.viewClass:"",ctrlClass:void 0!==e.ctrlClass?e.ctrlClass:"",modelClass:void 0!==e.modelClass?e.modelClass:""},env:e.env?e.env:{},databases:[...e.databases?e.databases.map(Editor.createItemData):[]],dataSources:[...e.dataSources?e.dataSources.map(Editor.createItemData):[]],actions:[...e.actions?e.actions.map(Editor.createItemData):[]],pageLinks:[...e.pageLinks?e.pageLinks.map(Editor.createItemData):[]]}}static async createAppFile(e,t){const s=ApplicationEditor.createData(t),r=new JsonFile(e,s);return await r.create(),r}async newPageAndPageLinkData(e){const t=w().join(this.appInfo.dirPath,"pages"),s=w().join(t,e.name),r=w().join(s,e.name+".json"),o=PageEditor.createData(e),a=new JsonFile(r,o);await a.create();return{page:o,pageLink:this.newItemData("PageLink","pageLinks",e)}}async save(){(0,P.fF)("ApplicationEditor.save"),await this.appFile.save()}async removePageFile(e){const t=this.createItemEditor("pageLinks",e),s=w().join(this.appInfo.dirPath,t.getAttr("fileName"));await a._.fsUnlink(s)}async createPageEditor(e){const t=w().join(this.appInfo.dirPath,e),s=new JsonFile(t);return await s.read(),new PageEditor(this,s,this.getEditorPath())}async getPage(e){const t=this.createItemEditor("pageLinks",e).getAttr("fileName");return await this.createPageEditor(t)}async createJs(e){const t=await this.getCustomFilePath("js"),s=w().join(this.getEditorPath(),"Editor/ApplicationEditor/Application.js.ejs");return await this.createFileByParams(t,s,{application:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createModelBackJs(e){const t=w().join(await this.getCustomDirPath(),"Model.back.ts"),s=w().join(this.getEditorPath(),"Editor/ApplicationEditor/Model.back.ts.ejs");return await this.createFileByParams(t,s,{name:this.getName()})}async getCustomDirPath(){return this.appInfo.dirPath}reformat(){this.data=this.appFile.data=ApplicationEditor.createData(Object.assign(Object.assign({},this.attributes()),{env:this.data.env,databases:this.data.databases,dataSources:this.data.dataSources,actions:this.data.actions,pageLinks:this.data.pageLinks}))}}const se=require("colors");var re=s.n(se);const oe=require("pg");var ae=s(688);class BkSqlDatabase extends ae.P{getUpdateQuery(e,t,s){(0,P.fF)("BkSqlDatabase.getUpdateQuery",e);const r=Object.keys(t),o=Object.keys(s);if(0===r.length)throw new Error("getUpdateQuery: no values");if(0===o.length)throw new Error("getUpdateQuery: no where");return`update ${e} set ${r.map((e=>`${e} = {val_${e}}`)).join(", ")} where ${o.map((e=>`${e} = {key_${e}}`)).join(" and ")}`}getInsertQuery(e,t){(0,P.fF)("BkSqlDatabase.getInsertQuery");const s=Object.keys(t);return`insert into ${e}(${s.join(", ")}) values (${s.map((e=>`{${e}}`)).join(", ")})`}getDeleteQuery(e,t){(0,P.fF)("BkSqlDatabase.getDeleteQuery");return`delete from ${e} where ${Object.keys(t).map((e=>`${e} = {${e}}`)).join(" and ")}`}static getUsedParams(e){const t=e.match(/\{([\w\.@]+)\}/g);return t?t.map((e=>e.substr(1,e.length-2))):[]}static checkParams(e,t){const s=BkSqlDatabase.getUsedParams(e),r=t?Object.keys(t):[],o=s.filter((e=>-1===r.indexOf(e)));if(o.length>0)throw new Error(`not passed params: ${o.join(",")}, passed: ${r.join(",")}, query: ${e}`)}}class BkPostgreSqlDatabase extends BkSqlDatabase{constructor(){super(...arguments),this.pool={}}async deinit(){(0,P.fF)(`PostgreSqlDatabase.deinit: ${this.getName()}`),await super.deinit();for(const e in this.pool){const t=this.pool[e];(0,P.fF)("ending pool:",e,t.totalCount),await t.end(),(0,P.fF)("pool ended")}this.pool={}}getPool(e){const t=this.getConfig(e),s=JSON.stringify(t);return this.pool[s]||((0,P.fF)(`creating connection pool for ${this.getName()}(${s})`),this.pool[s]=BkPostgreSqlDatabase.createPool(t)),this.pool[s]}static createPool(e){return new oe.Pool(e)}async connect(e){if((0,P.fF)("PostgreSqlDatabase.connect",this.getName()),!e)throw new Error("no context");this.checkDeinited();const t=this.getName();if(e.connections[t])throw new Error(`already connected: ${t}`);const s=this.getPool(e);e.connections[t]=await s.connect()}async release(e){if((0,P.fF)("PostgreSqlDatabase.release",this.getName()),!e)throw new Error("no context");this.getConnection(e).release(),e.connections[this.getName()]=null}async queryResult(e,t,s=null){e.getReq()&&e.getQuery().sql&&(0,P.fF)(re().blue("PostgreSqlDatabase.queryResult"),{query:t,params:s}),BkSqlDatabase.checkParams(t,s);const{sql:r,values:o}=BkPostgreSqlDatabase.formatQuery(t,s);e.getReq()&&e.getQuery().sql&&((0,P.fF)("sql:",r),(0,P.fF)("values:",o));return await this.getConnection(e).query(r,o)}static async queryResult(e,t,s=null){(0,P.fF)(re().blue("static PostgreSqlDatabase.queryResult"),t),BkSqlDatabase.checkParams(t,s);const{sql:r,values:o}=BkPostgreSqlDatabase.formatQuery(t,s);return await e.query(r,o)}async queryRows(e,t,s=null){return(await this.queryResult(e,t,s)).rows}async begin(e){if((0,P.fF)("PostgreSqlDatabase.begin",this.getName()),!e)throw new Error("no context");await this.getConnection(e).query("begin")}async commit(e){if((0,P.fF)("PostgreSqlDatabase.commit",this.getName()),!e)throw new Error("no context");await this.getConnection(e).query("commit")}async rollback(e,t){if((0,P.fF)(re().red("PostgreSqlDatabase.rollback: "),this.getName(),t.message),!e)throw new Error("no context");await this.getConnection(e).query("rollback")}static formatQuery(e,t){if(!t)return{sql:e,values:null};const s=BkSqlDatabase.getUsedParams(e),r=Object.keys(t).filter((e=>s.indexOf(e)>-1)),o=r.map((e=>t[e]));return{sql:e.replace(/\{([\w\.@]+)\}/g,((e,t)=>r.indexOf(t)>-1?`$${r.indexOf(t)+1}`:e)),values:o}}getDeleteQuery(e,t){return`delete from "${e}" where ${Object.keys(t).map((e=>`"${e}" = {${e}}`)).join(" and ")}`}getUpdateQuery(e,t,s){return BkPostgreSqlDatabase.getUpdateQuery(e,t,s)}static getUpdateQuery(e,t,s){const r=Object.keys(t),o=Object.keys(s);if(0===r.length)throw new Error("getUpdateQuery: no values");if(0===o.length)throw new Error("getUpdateQuery: no where");return`update "${e}" set ${r.map((e=>`"${e}" = {val_${e}}`)).join(", ")} where ${o.map((e=>`"${e}" = {key_${e}}`)).join(" and ")}`}getInsertQuery(e,t){const s=Object.keys(t);if(!s.length)return`insert into "${e}" default values`;return`insert into "${e}"(${s.map((e=>`"${e}"`)).join(", ")}) values (${s.map((e=>`{${e}}`)).join(", ")})`}async getTableList(){(0,P.fF)("PostgreSqlDatabase.getTableList");return(await this.query("select \"table_name\" from information_schema.tables where table_schema = 'public'")).map((e=>e.table_name))}async getTableInfo(e){(0,P.fF)("PostgreSqlDatabase.getTableInfo");const t=await this.getTableKeyColumns(e);return(await this.query(`select * from INFORMATION_SCHEMA.COLUMNS where table_name = '${e}' order by ordinal_position`)).map((e=>({name:e.column_name,type:this.getColumnTypeByDataType(e.data_type),key:!!t.find((t=>t.attname===e.column_name)),auto:!(!e.column_default||"nextval"!==e.column_default.substr(0,7)),nullable:"YES"===e.is_nullable,comment:null,dbType:e.data_type})))}getColumnTypeByDataType(e){switch(e){case"integer":case"numeric":case"bigint":return"number";case"character varying":case"text":case"bytea":return"string";case"json":case"jsonb":case"ARRAY":return"object";case"boolean":return"boolean";case"timestamp with time zone":case"timestamp without time zone":return"date";default:return null}}async getTableKeyColumns(e){(0,P.fF)("PostgreSqlDatabase.getTableKeyColumns");return await this.query(`SELECT a.attname, format_type(a.atttypid, a.atttypmod) AS data_type\nFROM   pg_index i\nJOIN   pg_attribute a ON a.attrelid = i.indrelid AND a.attnum = ANY(i.indkey)\nWHERE  i.indrelid = '"${e}"'::regclass AND i.indisprimary;`)}async query(e){const t=this.getConfig(),s=new oe.Client(t);await s.connect();const r=await s.query(e);return await s.end(),r.rows}async queryAutoValues(e,t,s){(0,P.fF)("PostgreSqlDatabase.queryAutoValues",s);const r=Object.keys(s);if(!r.length)throw new Error("no auto columns");const o=r.map((e=>`select currval('"${t}_${e}_seq"')`)).join("; "),a=await this.queryResult(e,o);if(a instanceof Array)return r.reduce(((e,t,r)=>{const o=a[r];let[{currval:i}]=o.rows;if("number"===s[t]&&"string"==typeof i&&(i=Number(i)),typeof i!==s[t])throw new Error(`wrong type of auto value: ${typeof i}, should be ${s[t]}`);return e[t]=i,e}),{});{let[{currval:e}]=a.rows;const t=r[0];if("number"===s[t]&&"string"==typeof e&&(e=Number(e)),typeof e!==s[t])throw new Error(`wrong type of auto value: ${typeof e}, should be ${s[t]}`);return{[t]:e}}}async insertRow(e,t,s,r={}){(0,P.fF)(`PostgreSqlDatabase.insertRow ${t}`,s,r);const o=this.getInsertQuery(t,s);await this.queryResult(e,o,s);if(Object.keys(r).length>0){const o=await this.queryAutoValues(e,t,r);return(0,P.fF)("auto:",o),Object.assign(Object.assign({},o),s)}return Object.assign({},s)}async queryScalar(e,t,s){const r=(await this.queryRows(e,t,s))[0];if(!r)throw new Error("queryScalar must return one row");const[o]=Object.keys(r);if(!o)throw new Error("no column in result set");const a=r[o];if(void 0===a)throw new Error("scalar value undefined");return a}}class EventLog{constructor(e){this.pool=(null==e?void 0:e.db)&&BkPostgreSqlDatabase.createPool(e.db),this.url=null==e?void 0:e.url}async create(e){if(!this.pool)throw new Error("no pool");await BkPostgreSqlDatabase.queryResult(this.pool,"insert into log(created, type, source, message, stack, data, ip) values ({created}, {type}, {source}, {message}, {stack}, {data}, {ip})",{created:new Date,type:e.type,source:e.source,message:e.message&&e.message.substring(0,255),stack:e.stack||null,data:e.data||null,ip:e.ip||null})}async log(e){if(this.pool&&await this.create(e),this.url){return await this.logToEventLog(e)}}async logToEventLog(e){if(!this.url)throw new Error("no url");try{const{_id:t}=await a._.post(this.url,e);return t}catch(e){return null}}}class EmptyPromise extends Promise{static create(){let e,t;const s=new EmptyPromise(((s,r)=>{e=s,t=r}));return s.resolve=e,s.reject=t,s}}function ie(e){return function(t,s,r){const o=r.value;return r.value=async function(...t){return O[e](`${this.constructor.name}.${s}`),o.apply(this,t)},r}}function ne(e,t,s){const r=s.value;return s.value=async function(...e){const s=Date.now(),o=r.apply(this,e);return O.debug(`${this.constructor.name}.${t}: [${Date.now()-s} ms]`),o},s}var le=function(e,t,s,r){var o,a=arguments.length,i=a<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,s):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,s,r);else for(var n=e.length-1;n>=0;n--)(o=e[n])&&(i=(a<3?o(i):a>3?o(t,s,i):o(t,s))||i);return a>3&&i&&Object.defineProperty(t,s,i),i};const ce=s(598),de=w().join(__dirname,"backend"),he=process.env.APPS_DIR_PATH||"./apps",ue=process.env.LISTEN_HOST||"localhost",ge=process.env.LISTEN_PORT&&parseInt(process.env.LISTEN_PORT)||7e3;class BackHostApp{constructor(e={}){this.params=e,this.applications={},this.startTime=new Date,this.createAppQueue={},(0,P.fF)("BackHostApp.constructor",e)}async init(){this.checkNodeVersion(),this.initDirPaths(),this.checkApplicationFolder(),this.createTempDirsIfNotExistSync(),this.createEventLog(),this.initExpressServer(),await this.initModules(),this.createHttpServer()}async run(){await BackHostApp.runHttpServer(this.httpServer,this.getHost(),this.getPort()),this.httpServer.on("error",this.onHttpServerError.bind(this)),this.createWebSocketServer(),this.listenProcessEvents(),O.log(this.composeStartMessage(this.getHost(),this.getPort()))}getHost(){return this.params.host||ue}getPort(){const{port:e}=this.params;if(e&&"number"!=typeof e)throw new Error("getPort: type port error: "+typeof e);return e||ge}createHttpServer(){this.httpServer=l().createServer(this.express)}checkNodeVersion(){const[e]=process.versions.node.split(".");if(parseInt(e)<14)throw new Error(`min node version required 14, current ${e}`)}checkApplicationFolder(){if(!m().existsSync(this.appsDirPath))throw new Error(`Application folder '${this.appsDirPath}' doesn't exist`)}createTempDirsIfNotExistSync(){a._.createDirIfNotExistsSync(this.runtimeDirPath),a._.createDirIfNotExistsSync(this.sessionDirPath)}createEventLog(){this.eventLog=new EventLog(this.params.logger)}async initModules(){this.indexModule=new IndexModule(this),await this.indexModule.init(),this.monitorModule=new MonitorModule(this),await this.monitorModule.init(),this.viewerModule=new ViewerModule(this),await this.viewerModule.init(),this.editorModule=new EditorModule(this),await this.editorModule.init()}createWebSocketServer(){this.wsServer=new WebSocketServer({hostApp:this,httpServer:this.httpServer})}initDirPaths(){this.appsDirPath=w().resolve(this.params.appsDirPath||he),this.distDirPath=this.params.distDirPath||this.appsDirPath,this.backendDirPath=de,this.frontendDirPath=w().resolve(w().join(de,"../frontend")),this.runtimeDirPath=w().resolve(this.params.runtimeDirPath||"./runtime"),this.sessionDirPath=w().join(this.runtimeDirPath,"session")}composeStartMessage(e,t){let s="\n";return s+=`NODE_ENV=${process.env.NODE_ENV}\n`,s+=`QFORMS_LOG_LEVEL=${process.env.QFORMS_LOG_LEVEL}\n`,s+="\n",s+=`QForms server v${ce.version} listening on http://${e}:${t}${this.isDevelopment()?"/index2":""}\n`,s+=`\tcwd: ${process.cwd()}\n`,s+=`\tappsDirPath: ${this.appsDirPath}\n`,s+=`\tdistDirPath: ${this.distDirPath}\n`,s+=`\tbackendDirPath: ${this.backendDirPath}\n`,s+=`\tfrontendDirPath: ${this.frontendDirPath}\n`,s+=`\truntimeDirPath: ${this.runtimeDirPath}\n`,s+=`\tsessionDirPath: ${this.sessionDirPath}\n`,this.isDevelopment()&&(s+=`\tmonitor: http://${e}:${t}/monitor\n`),s+=`\tstarted at: ${(new Date).toISOString()}\n`,s}listenProcessEvents(){process.on("message",this.onProcessMessage.bind(this)),process.on("SIGINT",this.onProcessSIGINT.bind(this)),process.on("SIGTERM",this.onProcessSIGTERM.bind(this)),process.on("exit",this.onProcessExit.bind(this)),process.on("uncaughtException",this.onUncaughtException.bind(this)),process.on("unhandledRejection",this.onUnhandledRejection.bind(this))}getSecretSync(){const e=w().join(this.runtimeDirPath,"secret.txt");let t;return t=a._.getFileContentSync(e),t||(t=a._.getRandomString(20),a._.writeFileSync(e,t),t)}initExpressServer(){var e;this.express=d()(),this.express.set("handleException",null===(e=this.params.handleException)||void 0===e||e),this.express.enable("strict routing"),this.express.use(C().json({limit:"20mb",reviver:a._.dateTimeReviver})),this.express.use(C().urlencoded({extended:!1})),this.express.use(y()()),this.express.use(E()({store:new FileSessionStore(this.sessionDirPath),secret:this.getSecretSync(),key:"sid",resave:!1,saveUninitialized:!1})),this.express.options("/error",((e,t,s)=>{O.log("options /error"),t.header("Access-Control-Allow-Origin","*"),t.header("Access-Control-Allow-Headers","Content-Type, Content-Length"),t.end()})),this.express.post("/error",this.postError.bind(this)),this.isDevelopment()&&(this.express.get("/index2",this.indexGet.bind(this)),this.express.post("/index2",this.indexPost.bind(this))),this.express.get("/monitor",this.monitorGet.bind(this)),this.express.get("/:module/:appDirName/:appFileName/:env/:domain/",this.moduleGet.bind(this)),this.express.post("/:module/:appDirName/:appFileName/:env/:domain/",this.modulePost.bind(this)),this.express.patch("/:module/:appDirName/:appFileName/:env/:domain/",this.modulePatch.bind(this)),this.express.delete("/:module/:appDirName/:appFileName/:env/:domain/",this.moduleDelete.bind(this)),this.express.get("/:module/:appDirName/:appFileName/:env/:domain/*",this.moduleGetFile.bind(this)),this.express.use(d().static(this.frontendDirPath,{setHeaders:(e,t,s)=>{O.log(`static: /${w().relative(this.frontendDirPath,t)} ${e.statusCode}`)}})),this.initCustomRoutes(),this.express.use(this._e404.bind(this)),this.express.use(this._e500.bind(this))}async createApplicationIfNotExists(e){const t=e.getRoute(),s=this.applications[t];if(s)return s;if(Array.isArray(this.createAppQueue[t])){(0,P.fF)("application is creating:",t);const e=EmptyPromise.create();return this.createAppQueue[t].push(e),e}return await this.beginCreateApplication(e)}async beginCreateApplication(e){const t=e.getRoute();this.createAppQueue[t]=[];try{const s=this.applications[t]=await this.createApplication(e);(0,P.fF)("application created, start resolve loop",t,this.createAppQueue[t].length);for(const e of this.createAppQueue[t])e.resolve(s);return s}catch(e){(0,P.vU)("application not created, start reject loop",t,this.createAppQueue[t].length);for(const s of this.createAppQueue[t])s.reject(e);throw e}finally{this.createAppQueue[t]=null}}getApplication(e){const t=this.applications[e.getRoute()];if(!t)throw new Error(`no application for route: ${e.getRoute()}`);return t}getApplicationByRoute(e){return this.applications[e]}getSrcAppFilePath(e){return w().join(this.appsDirPath,e.getAppDirName(),e.getAppFileName()+".json")}getDistAppFilePath(e){return w().join(this.distDirPath,e.getAppDirName(),e.getAppFileName()+".json")}async createApplication(e){(0,P.fF)(`BackHostApp.createApplication: ${e.getRoute()}`);const t=this.getDistAppFilePath(e),s=await BkApplication.loadAppInfo(t),r=new(this.getApplicationClass(s))(s,this,e.getEnv());return await r.init(e),r}getApplicationClass(e){const t=i.g.getAttr(e.appFile.data,"modelClass");if(t){const e=global[t];if(!e)throw new Error(`no class ${t}`);return e}return BkApplication}async createAppInfos(e){const{folder:t,name:s}=e.body;if(!t)throw new Error(`folder required: ${t}`);if(!s)throw new Error(`name required: ${s}`);const r=w().join(this.appsDirPath,t),o=w().join(r,s+".json");await a._.createDirIfNotExists(r),await ApplicationEditor.createAppFile(o,{name:s});return await BkApplication.getAppInfos(this.appsDirPath)}composeContextData(e,t){const s=e instanceof HttpError&&e.context?e.context.getRoute():null;return{headers:t.headers,method:t.method,host:t.headers.host,originalUrl:t.originalUrl,uri:t.params[0],platformVersion:ce.version,appVersion:s?this.applications[s].getVersion():null,route:s,body:t.body,status:e instanceof HttpError&&e.status||null,data:e instanceof HttpError&&e.data||null}}async logError(e,t){O.log("BackHostApp.logError:",u().red(e.message));try{await this.eventLog.log({type:"error",source:"server",message:e.message,stack:e.stack,data:t&&JSON.stringify(this.composeContextData(e,t),null,4),ip:t&&Context.getIpFromReq(t)})}catch(e){(0,P.vU)(u().red(e))}}async logEvent(e,t,s){O.log("BackHostApp.logEvent",t);try{await this.eventLog.log({type:"log",source:"server",message:t,data:s&&JSON.stringify(s,null,4),ip:e.getIp()})}catch(e){O.error(u().red(e))}}async indexGet(e,t,s){O.log(u().magenta("indexGet"));try{const e=await this.indexModule.render();t.setHeader("Content-Type","text/html; charset=utf-8").end(e)}catch(e){s(e)}}async indexPost(e,t,s){O.log(u().magenta("indexPost"),e.params);try{const s=await this.createAppInfos(e);t.json({appInfos:s.map((e=>({fullName:e.fullName,envs:e.envs})))})}catch(e){s(e)}}async monitorGet(e,t,s){O.log(u().magenta("monitorGet"));try{if(!this.params.monitor)return void t.end("Please set monitor username/password in app params");if(this.monitorModule.authorize(e)){const e=this.monitorModule.render();t.end(e)}else t.setHeader("WWW-Authenticate",'Basic realm="My Realm"').status(401).end("Unauthorized")}catch(e){s(e)}}async moduleGet(e,t,s){O.log(u().magenta.underline("GET"),`${e.params.module}/${e.params.appDirName}/${e.params.appFileName}/${e.params.env}/${e.params.domain}`);let r=null;try{if("viewer"===e.params.module){r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});const o=await this.createApplicationIfNotExists(r);o.isAvailable()?await this.viewerModule.handleGet(r,o):s()}else"editor"===e.params.module&&this.isDevelopment()?(r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)}),await this.editorModule.handleEditorGet(e,t,r)):s()}catch(e){s(e)}finally{r&&r.destroy()}}async modulePost(e,t,s){(0,P.fF)(u().magenta.underline("BackHostApp.modulePost"),e.params,e.body),O.log(u().magenta.underline("POST"),`${e.params.module}/${e.params.appDirName}/${e.params.appFileName}/${e.params.env}/${e.params.domain}`,`${e.body.page}.${e.body.form}.${e.body.ds}.${e.body.action}`);let r=null;try{if("viewer"===e.params.module){r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});const s=await this.createApplicationIfNotExists(r);await this.viewerModule.handlePost(r,s)}else if("editor"===e.params.module)if(this.isDevelopment()){r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});await this.editorModule.handleEditorPost(e,t,r)}else s();else s()}catch(e){s(e)}finally{r&&r.destroy()}}async modulePatch(e,t,s){(0,P.fF)(u().magenta.underline("BackHostApp.modulePatch"),e.params,e.body),O.log(u().magenta.underline("PATCH"),`${e.params.module}/${e.params.appDirName}/${e.params.appFileName}/${e.params.env}/${e.params.domain}`,`${e.body.page}.${e.body.form}.${e.body.ds}.${e.body.action}`);let r=null;try{if("viewer"===e.params.module){r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});const s=await this.createApplicationIfNotExists(r);await this.viewerModule.handlePatch(r,s)}else s()}catch(e){s(e)}finally{r&&r.destroy()}}async moduleDelete(e,t,s){(0,P.fF)(u().magenta.underline("BackHostApp.moduleDelete"),e.params,e.body),O.log(u().magenta.underline("DELETE"),`${e.params.module}/${e.params.appDirName}/${e.params.appFileName}/${e.params.env}/${e.params.domain}`,`${e.body.page}.${e.body.form}.${e.body.ds}.${e.body.action}`);let r=null;try{if("viewer"===e.params.module){r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});const s=await this.createApplicationIfNotExists(r);await this.viewerModule.handleDelete(r,s)}else s()}catch(e){s(e)}finally{r&&r.destroy()}}async moduleGetFile(e,t,s){if((0,P.fF)(u().magenta.underline("BackHostApp.moduleGetFile"),e.originalUrl),ie(u().magenta.underline("GET"),e.originalUrl),"viewer"===e.params.module){let r=null;try{r=new Context({req:e,res:t,domain:this.getDomainFromRequest(e)});const o=await this.createApplicationIfNotExists(r);await this.viewerModule.handleGetFile(r,o,s)}catch(e){e.message=`moduleGetFile error: ${e.message}`,s(e)}finally{r&&r.destroy()}}else s()}async _e404(e,t,s){(0,P.fF)(u().magenta(e.method),"error/404",e.originalUrl),s(new HttpError({message:`${e.method} ${e.originalUrl} not found`,status:404}))}async _e500(e,t,s,r){(0,P.fF)(u().magenta("module.exports.e500:"),t.method,t.originalUrl,e),O.log(u().red(e.message));const o="string"==typeof e?new HttpError({message:e}):e;if(s.status(o.status||500),t.headers["content-type"]&&-1!==t.headers["content-type"].indexOf("application/json"))s.end(this.isDevelopment()||404===o.status?o.message:"Internal Software Error");else{const e=o.status||500,t=this.isDevelopment()||404===o.status?o.message:"Internal Software Error",r=this.isDevelopment()&&404!==o.status?o.stack:"";s.end(function(e,t,s){return`<!DOCTYPE html>\n<html>\n<title>${e} ${t}</title>\n    <body>\n        <h1>${t}</h1>\n        <h2>${e}</h2>\n        <pre>${s}</pre>\n    </body>\n</html>`}(e,t,r))}await this.logError(o,t)}static runHttpServer(e,t,s){return new Promise(((r,o)=>{try{const a=t=>{(0,P.vU)("tempErrorHandler",t),e.off("error",a),o(t)};e.on("error",a),e.listen(s,t,(()=>{e.off("error",a),r()}))}catch(e){o(e)}}))}async onProcessMessage(e){if("shutdown"===e){try{await this.shutdown()}catch(e){(0,P.vU)("shutdown error:",e.message)}process.exit(0)}}async onProcessSIGINT(){(0,P.fF)("\nBackHostApp.onProcessSIGINT"),O.log("Received INT signal (Ctrl+C), shutting down gracefully...");try{await this.shutdown(),process.exit(0)}catch(e){(0,P.vU)("shutdown error:",e.message),process.exit(1)}}async onProcessSIGTERM(){O.log("Received SIGTERM (kill) signal, shutting down forcefully.");try{await this.shutdown(),process.exit(0)}catch(e){(0,P.vU)("shutdown error:",e.message),process.exit(1)}}onProcessExit(e){(0,P.fF)("BackHostApp.onProcessExit:",e),O.log("exit:",e)}async onUncaughtException(e,t){(0,P.vU)(u().red("BackHostApp.onUncaughtException"),e),e.message=`uncaughtException: ${e.message}`,await this.logError(e)}async onUnhandledRejection(e,t){(0,P.vU)(u().red("BackHostApp.onUnhandledRejection"),e),e.message=`unhandledRejection: ${e.message}`,await this.logError(e)}async shutdown(){const e=Object.keys(this.applications);for(let t=0;t<e.length;t++){const s=e[t],r=this.applications[s];await r.deinit()}}onHttpServerError(e){(0,P.vU)(u().red("BackHostApp.onHttpServerError"),e.code,e.message)}getDomainFromRequest(e){if(!e)throw new Error("need req param");const t=e.headers.host;if(!t)throw new Error("no host");const[s,r]=t.split(":"),[o]=s.split(".");if(!o)throw new Error("trouble getting a domain");return o}async postError(e,t,s){(0,P.fF)(u().blue("BackHostApp.postError"),e.body.message);const r=e.body;O.log("client error:",u().red(r.message));try{const s=JSON.stringify({headers:e.headers,domain:this.getDomainFromRequest(e)},null,4);await this.eventLog.log({type:r.type,source:r.source,message:r.message,stack:r.stack,data:`${r.data}\n${s}`,ip:r.ip||Context.getIpFromReq(e)}),t.header("Access-Control-Allow-Origin","*"),t.end("ok")}catch(e){s(e)}}getFrontendDirPath(){return this.frontendDirPath}initCustomRoutes(){}alias(e,t,[s,r,o,a,i],n,l){this.express[e](t,(async(e,t,c)=>{if(e.params.module=s,e.params.appDirName=r,e.params.appFileName=o,a&&(e.params.env=a),i&&(e.params.domain=i),l){const t=BackHostApp.getQueryFromParams(e,l);for(const s in t)e.query[s]||(e.query[s]=t[s])}await this[n](e,t,c)}))}static getQueryFromParams(e,t){return Object.keys(t).reduce(((s,r)=>{const o=t[r];return s[r]=null===o?e.params[r]:e.params[o]||o,s}),{})}getPostAlias(e,t,s){this.alias("get",e,t,"moduleGet",s),this.alias("post",e,t,"modulePost",s),this.alias("patch",e,t,"modulePatch",s),this.alias("delete",e,t,"moduleDelete",s)}getNodeEnv(){return process.env.NODE_ENV||null}isDevelopment(){return"dev"===this.getNodeEnv()}isProduction(){return!this.isDevelopment()}getParams(){return this.params}broadcastResult(e,t,s){(0,P.fF)("BackHostApp.broadcastResult");for(const r in this.applications)if(t.getRoute()===r&&this.applications[r]===e)e.broadcastDomesticResultToClients(t,s);else{this.applications[r].broadcastForeignResultToClients(t,s)}}static test(){}getLogger(){return this.eventLog}getFrontLogUrl(){return this.params.frontLogUrl}getHttpServer(){return this.httpServer}}le([ie(B.debug),ne],BackHostApp.prototype,"init",null),le([ie(B.debug),ne],BackHostApp.prototype,"run",null),le([ie(B.debug)],BackHostApp.prototype,"createAppInfos",null),le([ie(B.debug)],BackHostApp.prototype,"onProcessMessage",null),le([ie(B.debug)],BackHostApp.prototype,"onProcessSIGTERM",null),le([ie(B.debug)],BackHostApp.prototype,"shutdown",null),le([ie(B.debug)],BackHostApp,"test",null);const me=w().join(__dirname,"backend");class Converter{static async reformat(e){(0,P.fF)("Convert.reformat",e);const t=new JsonFile(e);await t.read();const s=new ApplicationEditor(t,w().join(me,"editor"));s.reformat(),await s.save();const r=s.getData().pageLinks.map((e=>i.g.getName(e)));for(const e of r){const t=await s.getPage(e);t.reformat(),await t.save()}}}const pe=require("mysql");class BkMySqlDatabase extends BkSqlDatabase{constructor(){super(...arguments),this.pool=null}async deinit(){(0,P.fF)(`MySqlDatabase.deinit: ${this.getName()}`),await super.deinit(),null!==this.pool&&(await new Promise((e=>{this.pool.end((()=>{e()}))})),this.pool=null)}getPool(){return this.pool||(this.pool=(0,pe.createPool)(this.getConfig())),this.pool}getConfig(){return(0,P.fF)("MySqlDatabase.getConfig"),Object.assign(Object.assign({},super.getConfig()),{queryFormat:BkMySqlDatabase.queryFormat})}static async Pool_getConnection(e){return new Promise(((t,s)=>{e.getConnection(((e,r)=>{e?s(e):t(r)}))}))}async queryRows(e,t,s=null){(0,P.fF)("MySqlDatabase.queryRows",t,s),BkSqlDatabase.checkParams(t,s);const r=await this.getConnection(e);return new Promise(((e,o)=>{r.query({sql:t,typeCast:BkMySqlDatabase.typeCast,nestTables:true},s,((t,s,r)=>{if(t)o(t);else{const t=this._getRows(s,r);e(t)}}))}))}async queryResult(e,t,s=null){(0,P.fF)("MySqlDatabase.queryResult",t,s),BkSqlDatabase.checkParams(t,s);const r=await this.getConnection(e);return new Promise(((e,o)=>{r.query({sql:t,typeCast:BkMySqlDatabase.typeCast,nestTables:false},s,((t,s,r)=>{t?o(t):e(s)}))}))}_getRows(e,t){const s={};for(let e=0;e<t.length;e++){const r=t[e];s[r.name]||(s[r.name]=0),s[r.name]++,r.numb=s[r.name]-1}const r=[];for(let s=0;s<e.length;s++){const o=e[s],a={};for(let e=0;e<t.length;e++){const s=t[e];a[s.name+(s.numb>0?s.numb:"")]=o[s.table][s.name]}r.push(a)}return r}begin(e){(0,P.fF)("MySqlDatabase.begin");const t=this.getConnection(e);return new Promise(((e,s)=>{t.beginTransaction((t=>{t?s(t):e()}))}))}commit(e){(0,P.fF)("MySqlDatabase.commit");const t=this.getConnection(e);return new Promise(((e,s)=>{t.commit((t=>{t?s(t):e()}))}))}rollback(e,t){(0,P.fF)("MySqlDatabase.rollback:",this.getName(),t.message);const s=this.getConnection(e);return new Promise(((e,t)=>{s.rollback((()=>{e()}))}))}static queryFormat(e,t={}){(0,P.fF)("MySqlDatabase.queryFormat",e,t);const s=e.replace(/\{([\w\.@]+)\}/g,((e,s)=>{if(t.hasOwnProperty(s))return(0,pe.escape)(t[s]);throw new Error(`no query param: ${s}`)}));return(0,P.fF)("real db sql: "+s),s}static typeCast(e,t){return["DATE","DATETIME","TIME","TIMESTAMP"].includes(e.type)?e.string():t()}async getTableList(){(0,P.fF)("MySqlDatabase.getTableList");const e=this.getConfig();return new Promise(((t,s)=>{const r=(0,pe.createConnection)(e);r.connect(),r.query("show tables",((e,o,a)=>{if(r.end(),e)s(e);else{const e=o.map((e=>e[a[0].name]));(0,P.fF)("tables:",e),t(e)}}))}))}async getTableInfo(e){(0,P.fF)("MySqlDatabase.getTableInfo:",e);const t=this.getConfig();return new Promise(((s,r)=>{const o=(0,pe.createConnection)(t);o.connect();const a=`SELECT COLUMN_NAME, COLUMN_TYPE, IS_NULLABLE, COLUMN_KEY, COLUMN_DEFAULT, EXTRA, COLUMN_COMMENT FROM information_schema.columns WHERE table_schema = '${t.database}' and table_name = '${e}'`;o.query(a,((e,t)=>{if(o.end(),e)r(e);else{const e=t.map((e=>({name:e.COLUMN_NAME,type:this.getColumnTypeByDataType(e.COLUMN_TYPE),key:"PRI"===e.COLUMN_KEY,auto:"auto_increment"===e.EXTRA,nullable:"YES"===e.IS_NULLABLE,comment:e.COLUMN_COMMENT,dbType:e.COLUMN_TYPE})));(0,P.fF)("tableInfo:",e),s(e)}}))}))}getColumnTypeByDataType(e){switch(e){case"int(10) unsigned":case"int unsigned":return"number";case"varchar(255)":case"varchar(15)":case"text":return"string";case"datetime":return"date";default:return null}}async insertRow(e,t,s,r={}){(0,P.fF)(`MySqlDatabase.insertRow ${t}`,s,r);const o=Object.keys(r);if(o.length>1)throw new Error("mysql does not support more than one auto increment column");const a=this.getInsertQuery(t,s),i=await this.queryResult(e,a,s);if(1===o.length){if(!i.insertId)throw new Error("no insertId");return Object.assign({[o[0]]:i.insertId},s)}return Object.assign({},s)}async connect(e){if((0,P.fF)("MySqlDatabase.connect",this.getName()),!e)throw new Error("no context");this.checkDeinited();const t=this.getName();if(e.connections[t])throw new Error(`already connected: ${t}`);e.connections[t]=await BkMySqlDatabase.Pool_getConnection(this.getPool())}async release(e){if((0,P.fF)("MySqlDatabase.release",this.getName()),!e)throw new Error("no context");this.getConnection(e).release(),e.connections[this.getName()]=null}}var we=s(537);class BkPage extends N.U{constructor(){super(...arguments),this.dataSources=[],this.actions=[],this.forms=[]}async init(e){await this.createColItems("dataSources",e),await this.createColItems("actions",e),await this.createColItems("forms",e)}getDirPath(){return w().join(this.getParent().getDirPath(),"pages",this.getName())}fillAttributes(e){e.name=this.getAttr("name"),e.caption=this.getAttr("caption"),e.cssBlock=this.getAttr("cssBlock"),e.viewClass=this.getAttr("viewClass"),e.ctrlClass=this.getAttr("ctrlClass"),this.isAttr("formInTab")&&(e.formInTab=this.getAttr("formInTab"))}async fill(e){const t=await super.fill(e);return await this.fillCollection(t,"dataSources",e),await this.fillCollection(t,"actions",e),await this.fillCollection(t,"forms",e),t.newMode=BkPage.getNewModeFromContext(e),t}static getNewModeFromContext(e){const t=e.getAction(),s=e.getQuery();if("page"===t&&void 0!==s.newMode){if(["true","false"].includes(s.newMode))return a._.decodeValue(s.newMode);throw new Error("getNewModeFromContext: newMode required")}return!!e.getBody().newMode}async rpc(e,t){if((0,P.fF)("BkPage.rpc",e,t.getBody()),this[e])return await this[e](t);throw new HttpError({message:`no remote proc ${this.constructor.name}.${e}`,data:{method:`${this.constructor.name}.rpc`},context:t})}getApp(){return this.getParent()}findForm(e){return this.forms.find((t=>t.getName()===e))}getForm(e){const t=this.findForm(e);if(!t)throw new Error(`${this.getName()}: no form ${e}`);return t}findDataSource(e){return this.dataSources.find((t=>t.getName()===e))}getDataSource(e){const t=this.findDataSource(e);if(!t)throw new Error(`${this.getName()}: no form ${e}`);return t}}class BkForm extends N.U{constructor(e,t){super(e,t),this.dataSources=[],this.actions=[],this.fields=[],this.fillCollections=["dataSources","actions","fields"]}async init(e){await this.createColItems("dataSources",e),await this.createColItems("actions",e),await this.createColItems("fields",e)}getDirPath(){return w().join(this.getParent().getDirPath(),"forms",this.getName())}fillAttributes(e){e.class=this.getClassName(),e.name=this.getAttr("name"),e.caption=this.getAttr("caption"),e.visible=this.getAttr("visible"),e.cssBlock=this.getAttr("cssBlock"),e.viewClass=this.getAttr("viewClass"),e.ctrlClass=this.getAttr("ctrlClass")}async fill(e){if(this.findDataSource("default"))return await super.fill(e);const t=this._getSurrogateDataSourceResponse(e);this.dumpRowToParams(t.rows[0],e);const s=await super.fill(e);return s.dataSources.push(t),s}_getSurrogateDataSourceResponse(e){const t={id:"[1]"};for(const s of this.fields)s.fillDefaultValue(e,t);return{class:"DataSource",name:"default",keyColumns:["id"],rows:[t]}}dumpRowToParams(e,t){for(const s of this.fields)s.isParam()&&s.dumpRowValueToParams(e,t)}replaceThis(e,t){return t.replace(/\{([@\w.]+)\}/g,((e,t)=>{if(-1!==t.indexOf(".")){const e=t.split(".");return"this"===e[0]&&(e[0]=this.getPage().getName()),"{"+e.join(".")+"}"}return e})).replace(/\[([@\w.]+)\]/g,((e,t)=>{if(-1!==t.indexOf(".")){const e=t.split(".");return"this"===e[0]&&(e[0]=this.getPage().getName()),"["+e.join(".")+"]"}return e}))}async rpc(e,t){if((0,P.fF)("BkForm.rpc",e,t.getBody()),this[e])return await this[e](t);throw new HttpError({message:`no remote proc ${this.constructor.name}.${e}`,data:{method:`${this.constructor.name}.rpc`},context:t})}getApp(){return this.getParent().getParent()}getPage(){return this.getParent()}getFullName(){return`${this.getPage().getName()}.${this.getName()}`}isNewMode(e){return BkPage.getNewModeFromContext(e)}findField(e){return this.fields.find((t=>t.getName()===e))}getField(e){const t=this.findField(e);if(!t)throw new Error(`${this.getFullName()}: no field ${e}`);return t}findDataSource(e){return this.dataSources.find((t=>t.getName()===e))}getDataSource(e){const t=this.findDataSource(e);if(!t)throw new Error(`${this.getFullName()}: no data source ${e}`);return t}}class BkRowForm extends BkForm{isNewMode(e){if(this.isAttr("newMode")){const e=this.getAttr("newMode");if("true"===e)return!0;if("false"===e)return!1}return super.isNewMode(e)}fillAttributes(e){super.fillAttributes(e),e.newMode=this.getAttr("newMode"),e.refreshButton=this.getAttr("refreshButton")}}class BkTableForm extends BkForm{fillAttributes(e){super.fillAttributes(e),e.editMethod=this.getAttr("editMethod"),e.itemEditPage=this.getAttr("itemEditPage"),e.itemCreatePage=this.getAttr("itemCreatePage"),e.newRowMode=this.getAttr("newRowMode"),e.deleteRowMode=this.getAttr("deleteRowMode"),e.refreshButton=this.getAttr("refreshButton")}}var fe=s(855);class BkDataSource extends N.U{constructor(){super(...arguments),this.keyColumns=[],this.rows=[]}getDirPath(){return w().join(this.getParent().getDirPath(),"dataSources",this.getName())}getJsonFilePath(){return w().join(this.getDirPath(),`${this.getName()}.json`)}async init(e){await super.init(e),this.keyColumns=this.getKeyColumns();const t=this.getJsonFilePath();if(await a._.exists2(t)){const e=await a._.readTextFile(t);this.rows=JSON.parse(e)}}getKeyColumns(){const e=this.getItemNames("keyColumns");if(!e.length)throw new Error(`${this.getFullName()}: DataSource without table must have at least one key column`);return e}checkKeyColumns(e){for(const t of this.keyColumns)if(!e.hasOwnProperty(t))throw new Error(`${this.getFullName()}: no key column '${t}' in result set`)}checkKeyFields(){const e=this.getForm().fields.map((e=>e.getAttr("column")));for(const t of this.keyColumns)if(!e.includes(t))throw new Error(`[${this.getFullName()}]: no field with key column: ${t}`)}checkRow(e){this.checkKeyColumns(e),this.isDefaultOnForm()&&this.checkFields(e)}checkRows(e){e[0]&&this.checkRow(e[0])}checkNotUsedColumns(e){const t=Object.keys(e),s=this.getForm().fields.map((e=>e.getAttr("column"))).filter((e=>!!e));for(const r of t)if(!s.includes(r))throw(0,P.fF)("rowColumns:",t),(0,P.fF)("formColumns:",s),(0,P.fF)("row:",e),new Error(`${this.getFullName()}: not used column "${r}" in result set`)}checkFields(e){for(const t of this.getForm().fields){const s=t.getAttr("column");if(s){if(!e.hasOwnProperty(s))throw new Error(`[${t.getFullName()}]: no column '${s}' in result set`)}else if(!t.getAttr("value"))throw new Error(`[${t.getFullName()}]: no column and no value attr for calculation`)}}encodeRows(e){return e.map((e=>this.encodeRow(e)))}encodeRow(e){if(!e)throw new Error("encodeRow: need row");const t={};if(this.isDefaultOnForm())for(const s of this.getForm().fields){const r=s.getAttr("column");if(t[r]=s.valueToRaw(e[r]),s.isAttr("displayColumn")){const r=s.getAttr("displayColumn");t[r]=s.valueToRaw(e[r])}}else for(const s in e)t[s]=a._.encodeValue(e[s]);return t}getApp(){return this.getParent().getApp()}getKeyValuesFromKey(e){const t=(0,fe.mV)(e);if(t.length!==this.keyColumns.length)throw new Error(`key length mismatch: ${t.length} of ${this.keyColumns.length}`);const s={};for(let e=0;e<this.keyColumns.length;e++){s[this.keyColumns[e]]=t[e]}return s}getKeyFromValues(e){const t=[];for(let s=0;s<this.keyColumns.length;s++){const r=this.keyColumns[s],o=e[r];if(null==o)throw new Error(`getKeyFromValues: no value of ${r} column`);t.push(o)}return JSON.stringify(t)}getFullName(){return this.isOnForm()?[this.getParent().getPage().getName(),this.getParent().getName(),this.getName()].join("."):this.getParent()instanceof BkPage?[this.getParent().getName(),this.getName()].join("."):this.getName()}static keyToParams(e,t="key"){if("string"!=typeof e)throw new Error("key not string");const s={},r=(0,fe.mV)(e);if(1===r.length)s[t]=r[0];else{if(!(r.length>1))throw new Error(`invalid key: ${e}`);for(let e=0;e<r.length;e++)s[`${t}${e+1}`]=r[e]}return s}calcNewKeyValues(e,t){return this.keyColumns.reduce(((s,r)=>{if(void 0===e[r])throw new Error(`no key column in values: ${r}`);return s[r]=void 0!==t[r]?t[r]:e[r],s}),{})}calcNewKey(e,t){const s=this.getKeyValuesFromKey(e),r=this.calcNewKeyValues(s,t);return this.getKeyFromValues(r)}fillAttributes(e){e.class=this.getClassName(),e.name=this.getAttr("name"),this.isAttr("database")&&(e.database=this.getAttr("database")),this.isAttr("table")&&(e.table=this.getAttr("table"))}async fill(e){const t=await super.fill(e);return t.keyColumns=this.keyColumns,t.rows=await this.getRows(),t}async getRows(){return this.rows}isOnForm(){return this.getParent()instanceof BkForm}isDefaultOnForm(){return"default"===this.getName()&&this.isOnForm()}isDefaultOnRowForm(){return"default"===this.getName()&&this.getParent()instanceof BkRowForm}isDefaultOnTableForm(){return"default"===this.getName()&&this.getParent()instanceof BkTableForm}async read(e){throw new Error(`${this.constructor.name}.select not implemented`)}async create(e,t=null){throw new Error(`${this.constructor.name}.create not implemented`)}async update(e){throw new Error(`${this.constructor.name}.update not implemented`)}async delete(e){throw new Error(`${this.constructor.name}.delete not implemented`)}getForm(){if(!this.isOnForm())throw new Error(`${this.getFullName()}: not form data source`);return this.getParent()}getAccess(e){return{create:!0,read:!0,update:!0,delete:!0}}getDatabase(){throw new Error(`${this.constructor.name}.getDatabase not implemented`)}getLimit(){return""!==this.getAttr("limit")?parseInt(this.getAttr("limit")):null}}class BkPersistentDataSource extends BkDataSource{constructor(e,t){super(e,t),this.table=null,this.getAttr("table")&&(this.table=this.getDatabase().getTable(this.getAttr("table")))}getChanges(e){const t=e.getBody();return this.decodeChanges(t.changes)}decodeChanges(e){const t={};for(const s in e)t[s]=this.decodeRow(e[s]);return t}decodeRow(e){const t=this.getForm();if(!t)throw new Error("not form ds");const s={};for(const r of t.fields){const t=r.getAttr("column");if(Object.prototype.hasOwnProperty.call(e,t)){const o=r.rawToValue(e[t]);s[t]=r.valueToDbValue(o)}}return s}getDatabase(){const e=this.getAttr("database");if(!e)throw new Error(`${this.getFullName()}: no database name`);return this.getApp().getDatabase(e)}getTable(){if(!this.table)throw new Error(`${this.getFullName()}: no table`);return this.table}}class BkSqlDataSource extends BkPersistentDataSource{async fill(e){const t=await super.fill(e);if(this.isDefaultOnForm()&&this.checkKeyFields(),this.isDefaultOnForm()&&this.getParent().isNewMode(e)){const e=this.getLimit();return e&&(t.limit=e),t.rows=[],t.count=0,t}this.getLimit()&&!e.getParam("frame")&&e.setParam("frame",1);try{const[s,r]=await this.read(e);t.rows=s,t.count=r}catch(e){throw e.message=`read error of ${this.getFullName()}: ${e.message}`,e}return this.isDefaultOnRowForm()&&t.rows[0]&&this.getParent().dumpRowToParams(t.rows[0],e),this.getLimit()&&(t.limit=e.getParam("limit")),t}getKeyColumns(){return this.table?this.table.getKeyColumns():super.getKeyColumns()}getCountQuery(e){let t=this.getAttr("countQuery");if(!t)throw new Error(`${this.getFullName()}: no countQuery`);return this.isOnForm()&&(t=this.getParent().replaceThis(e,t)),t=this.templateQuery(e,t),t}getSingleQuery(e){let t=this.getAttr("singleQuery");if(!t)throw new Error(`no singleQuery: ${this.getFullName()}`);return this.isOnForm()&&(t=this.getParent().replaceThis(e,t)),t=this.templateQuery(e,t),t}getMultipleQuery(e){let t=this.getAttr("multipleQuery");if(!t)throw new Error(`no multipleQuery: ${this.getFullName()}`);return this.isOnForm()&&(t=this.getParent().replaceThis(e,t)),t=this.templateQuery(e,t),t}templateQuery(e,t){const s=this.getSelectParams(e);let r=t;return r=t.replace(/\[([\w.@]+)\]/g,((e,t)=>s[t]?s[t]:e)),r}getSelectParams(e){return e.getAllParams()}async read(e){if(!0!==this.getAccess(e).read)throw new Error(`[${this.getFullName()}]: access denied`);const t=this.getLimit();if(t){const s=e.getParam("frame");if(!s)throw new Error("no frame param");e.setParam("offset",(s-1)*t),e.setParam("limit",t)}const s=this.isDefaultOnRowForm()?this.getSingleQuery(e):this.getMultipleQuery(e),r=this.getSelectParams(e),o=await this.getDatabase().queryRows(e,s,r);this.checkRows(o);const a=this.encodeRows(o);let i=null;if(this.isDefaultOnTableForm()&&this.getLimit())try{const t=await this.getDatabase().queryScalar(e,this.getCountQuery(e),r);i=parseInt(t,10)}catch(e){throw e.message=`${this.getFullName()}: ${e.message}`,e}return[a,i]}async create(e,t=null){if((0,P.fF)("SqlDataSource.create"),!0!==this.getAccess(e).create)throw new Error(`[${this.getFullName()}]: access denied.`);if(!this.table)throw new Error(`${this.getFullName()}: no link to table object: ${this.getAttr("table")}`);const s=this.getAttr("database"),r=this.getAttr("table"),o=e.getBody(),a=t||this.decodeRow(o.row),i=this.getAutoColumnTypes(),n=await this.getDatabase().insertRow(e,r,a,i);(0,P.fF)("newRow:",n);const l=this.getKeyFromValues(n);if(!l)throw new Error("insert: cannot calc row key");(0,P.fF)("key:",l);const c=BkDataSource.keyToParams(l),d=this.getSingleQuery(e),[h]=await this.getDatabase().queryRows(e,d,c);if(!h)throw new Error("singleQuery does not return row");this.checkRow(h);const u=this.encodeRow(h),g=new _.x4;return _.x4.addInsertToResult(g,s,r,l),_.x4.addInsertExToResult(g,s,r,l,u),g}async update(e){if((0,P.fF)("SqlDataSource.update"),!0!==this.getAccess(e).update)throw new Error(`[${this.getFullName()}]: access denied.`);if(!this.table)throw new Error(`no database table desc: ${this.getAttr("table")}`);const t=this.getAttr("database"),s=this.getAttr("table"),r=this.getChanges(e),[o]=Object.keys(r),i=this.getKeyValuesFromKey(o),n=r[o],l=this.getDatabase().getUpdateQuery(s,n,i),c=a._.mapObject(n,((e,t)=>[`val_${e}`,t])),d=a._.mapObject(i,((e,t)=>[`key_${e}`,t])),h=Object.assign(Object.assign({},c),d);await this.getDatabase().queryResult(e,l,h);const u=this.calcNewKey(o,n),g=BkDataSource.keyToParams(u);(0,P.fF)("key:",o),(0,P.fF)("newKey:",u),(0,P.fF)("newKeyParams:",g);const m=this.getSingleQuery(e),[p]=await this.getDatabase().queryRows(e,m,g);if(!p)throw new Error("singleQuery does not return row");this.checkRow(p);const w=this.encodeRow(p),f=new _.x4;return _.x4.addUpdateToResult(f,t,s,o,u),_.x4.addUpdateExToResult(f,t,s,o,w),f}async delete(e){if(!0!==this.getAccess(e).delete)throw new Error(`${this.getFullName()}: access denied`);const t=e.getParam("key"),s=this.getKeyValuesFromKey(t),r=this.getAttr("database"),o=this.getAttr("table"),a=this.getDatabase().getDeleteQuery(o,s);await this.getDatabase().queryResult(e,a,s);const i=new _.x4;return _.x4.addDeleteToResult(i,r,o,t),i}fillAttributes(e){e.class=this.getClassName(),e.name=this.getAttr("name"),e.database=this.getAttr("database"),e.table=this.getAttr("table")}getAutoColumns(){if(!this.table)throw new Error("getAutoColumns: no table");const e=this.table;return this.keyColumns.filter((t=>e.getColumn(t).isAuto()))}getAutoColumnTypes(){if(!this.table)throw new Error("getAutoColumnTypes: no table");const e=this.table;return this.getAutoColumns().reduce(((t,s)=>(t[s]=e.getColumn(s).getAttr("type"),t)),{})}}class BkNoSqlDataSource extends BkPersistentDataSource{constructor(e,t){super(e,t),this.table=this.getAttr("table")?this.getDatabase().getTable(this.getAttr("table")):null}async fill(e){const t=await super.fill(e);if(this.isDefaultOnForm()&&this.checkKeyFields(),this.isDefaultOnForm()&&this.getParent().isNewMode(e)){const e=this.getLimit();return e&&(t.limit=e),t.rows=[],t.count=0,t}this.getLimit()&&!e.getParam("frame")&&e.setParam("frame",1);try{const[s,r]=await this.read(e);t.rows=s,t.count=r}catch(e){throw e.message=`select error of ${this.getFullName()}: ${e.message}`,e}return this.isDefaultOnRowForm()&&t.rows[0]&&this.getParent().dumpRowToParams(t.rows[0],e),this.getLimit()&&(t.limit=e.getParam("limit")),t}async read(e){if(!0!==this.getAccess(e).read)throw new Error(`[${this.getFullName()}]: access denied`);const t=this.getLimit();if(t){const s=e.getParam("frame");if(!s)throw new Error("no frame param");e.setParam("skip",(s-1)*t),e.setParam("limit",t)}const s=Date.now(),r=await this.getDatabase().queryRows(e,this.getSelectQuery(e),this.getSelectParams(e));(0,P.fF)("rows query time:",Date.now()-s),this.checkRows(r);const o=this.encodeRows(r);let a=null;if(this.isDefaultOnTableForm()&&this.getLimit())try{const t=Date.now();a=await this.getDatabase().queryScalar(e,this.getCountQuery(e),this.getSelectParams(e)),(0,P.fF)("count query time:",Date.now()-t)}catch(e){throw e.message=`${this.getFullName()}: ${e.message}`,e}return[o,a]}async create(e,t=null){if((0,P.fF)("NoSqlDataSource.create"),!0!==this.getAccess(e).create)throw new Error(`[${this.getFullName()}]: access denied.`);if(!this.table)throw new Error(`${this.getFullName()}: no link to table object: ${this.getAttr("table")}`);const s=this.getAttr("database"),r=this.getAttr("table"),o=e.getBody(),a=t||this.decodeRow(o.row);(0,P.fF)("values",a);const i=await this.getDatabase().insertOne(e,r,a);(0,P.fF)("insertResult:",i);const n={_id:i.insertedId},l=this.getKeyFromValues(n);if(!l)throw new Error("create: cannot calc row key");(0,P.fF)("key:",l);const c=BkDataSource.keyToParams(l),[d]=await this.getDatabase().queryRows(e,this.getSelectQuery(e),c);if(!d)throw new Error("select query does not return row");this.checkRow(d);const h=this.encodeRow(d),u=new _.x4;return _.x4.addInsertToResult(u,s,r,l),_.x4.addInsertExToResult(u,s,r,l,h),u}async update(e){if((0,P.fF)("NoSqlDataSource.update"),!0!==this.getAccess(e).update)throw new Error(`[${this.getFullName()}]: access denied.`);if(!this.table)throw new Error(`no database table desc: ${this.getAttr("table")}`);const t=this.getAttr("database"),s=this.getAttr("table"),r=e.getBody(),o=this.decodeChanges(r.changes),a=Object.keys(o)[0];(0,P.fF)("key:",a);const i=this.getKeyValuesFromKey(a),n=o[a],l=await this.getDatabase().updateOne(e,s,i,{$set:n});(0,P.fF)("updateResult",l);const c=this.calcNewKey(a,n),d=BkDataSource.keyToParams(c);(0,P.fF)("newKey:",c);const[h]=await this.getDatabase().queryRows(e,this.getSelectQuery(e),d);if(!h)throw new Error("select query does not return row");this.checkRow(h);const u=this.encodeRow(h),g=new _.x4;return _.x4.addUpdateToResult(g,t,s,a,c),_.x4.addUpdateExToResult(g,t,s,a,u),g}async delete(e){if(!0!==this.getAccess(e).delete)throw new Error(`${this.getFullName()}: access denied`);const t=e.getParam("key"),s=this.getKeyValuesFromKey(t),r=await this.getDatabase().deleteOne(e,this.getAttr("table"),s);(0,P.fF)("updateResult",r);const o=new _.x4;return _.x4.addDeleteToResult(o,this.getAttr("database"),this.getAttr("table"),t),o}getSelectQuery(e){const t=this.getAttr("selectQuery");if(!t)throw new Error(`${this.getFullName()}: no selectQuery`);return t}getCountQuery(e){const t=this.getAttr("countQuery");if(!t)throw new Error(`${this.getFullName()}: no countQuery`);return t}getSelectParams(e){return e.getAllParams()}checkRow(e){this.checkKeyColumns(e),this.isDefaultOnForm()}encodeRow(e){if(!e)throw new Error("encodeRow: need row");const t={};if(this.isDefaultOnForm())for(const s of this.getForm().fields){const r=s.getAttr("column");if(t[r]=void 0!==e[r]?s.valueToRaw(e[r]):"null",s.isAttr("displayColumn")){const r=s.getAttr("displayColumn");t[r]=s.valueToRaw(e[r])}}else for(const s in e)t[s]=a._.encodeValue(e[s]);return t}}var Ce=s(679);class BkCheckBoxField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull")}}class BkCheckBoxListField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.dataSourceName=this.getAttr("dataSourceName"),e.valueColumn=this.getAttr("valueColumn"),e.displayColumn=this.getAttr("displayColumn")}}class BkComboBoxField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.placeholder=this.getAttr("placeholder"),e.dataSourceName=this.getAttr("dataSourceName"),e.valueColumn=this.getAttr("valueColumn"),e.displayColumn=this.getAttr("displayColumn"),e.newRowMode=this.getAttr("newRowMode"),e.itemEditPage=this.getAttr("itemEditPage"),e.itemCreatePage=this.getAttr("itemCreatePage"),e.itemCreateForm=this.getAttr("itemCreateForm"),e.itemSelectPage=this.getAttr("itemSelectPage")}}class BkDateField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.format=this.getAttr("format"),e.timezone=this.getAttr("timezone"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur")}valueToRaw(e){let t;if(e&&!this.isTimezone()){const s=a._.cloneDate(e);a._.removeTimezoneOffset(s),t=a._.encodeValue(s)}else t=a._.encodeValue(e);return t}rawToValue(e){const t=a._.decodeValue(e);return t&&!this.isTimezone()&&a._.addTimezoneOffset(t),t}}class BkTimeField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur")}}class BkDateTimeField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.format=this.getAttr("format"),e.timezone=this.getAttr("timezone"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur")}valueToRaw(e){let t;if(e&&!this.isTimezone()){const s=a._.cloneDate(e);a._.removeTimezoneOffset(s),t=a._.encodeValue(s)}else t=a._.encodeValue(e);return t}rawToValue(e){const t=a._.decodeValue(e);return t&&!this.isTimezone()&&a._.addTimezoneOffset(t),t}}class BkFileField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull")}}class BkImageField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull")}}class BkLabelField extends Ce.a{}class BkLinkField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.notNull=this.getAttr("notNull"),e.page=this.getAttr("page"),e.displayColumn=this.getAttr("displayColumn")}}class BkTextAreaField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.rows=this.getAttr("rows"),e.cols=this.getAttr("cols"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur")}}class BkTextBoxField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur"),e.autocomplete=this.getAttr("autocomplete")}}class BkPhoneField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur"),e.autocomplete=this.getAttr("autocomplete")}}class BkPasswordField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.placeholder=this.getAttr("placeholder"),e.validateOnChange=this.getAttr("validateOnChange"),e.validateOnBlur=this.getAttr("validateOnBlur"),e.autocomplete=this.getAttr("autocomplete")}}class BkRadioField extends Ce.a{fillAttributes(e){super.fillAttributes(e),e.readOnly=this.getAttr("readOnly"),e.notNull=this.getAttr("notNull"),e.dataSourceName=this.getAttr("dataSourceName"),e.valueColumn=this.getAttr("valueColumn"),e.displayColumn=this.getAttr("displayColumn")}}class BkColumn extends N.U{fillAttributes(e){e.name=this.getAttr("name"),e.caption=this.getAttr("caption"),e.type=this.getAttr("type")}isKey(){return"true"===this.getAttr("key")}isAuto(){return"true"===this.getAttr("auto")}getApp(){return this.getParent().getParent().getParent()}}class BkTable extends N.U{constructor(e,t){super(e,t),this.columns=[],this.fillCollections=["columns"]}async init(e){await this.createColItems("columns",e)}getKeyColumns(){const e=this.columns.filter((e=>e.isKey())).map((e=>e.getName()));if(0===e.length)throw new Error(`no key columns in table: ${this.getName()}`);return e}getApp(){return this.getParent().getParent()}getColumn(e){const t=this.columns.find((t=>t.getName()===e));if(!t)throw new Error(`no column ${e}`);return t}fillAttributes(e){e.name=this.getAttr("name")}}var be=s(718);class BkAction extends N.U{fillAttributes(e){e.name=this.getAttr("name"),e.caption=this.getAttr("caption")}}class ActionEditor extends Editor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"Action","@attributes":{name:e.name,caption:e.caption||e.name}}}getColName(){return"actions"}}class DataSourceEditor extends Editor{static createData(e){return{"@class":"DataSource","@attributes":Object.assign({},DataSourceEditor.createAttributes(e)),keyColumns:[...e.keyColumns?e.keyColumns.map(Editor.createItemData):[]]}}static createAttributes(e){if(!e.name)throw new Error("no name");return{name:e.name,database:e.database||"default",table:e.table||"",modelClass:void 0!==e.modelClass?e.modelClass:""}}async getCollectionDirPath(){const e=await this.getParent().getCustomDirPath();return w().join(e,"dataSources")}async createModelBackJs(e){const t=w().join(await this.getCustomDirPath(),"Model.back.ts"),s=w().join(this.getEditorPath(),"Editor/DataSourceEditor/Model.back.ts.ejs");return await this.createFileByParams(t,s,{_class:this.getClassName(),page:e.page?e.page:"",form:e.form?e.form:"",dataSource:this.getName()})}getColName(){return"dataSources"}async save(){this.getParent()instanceof ApplicationEditor?await this.getParent().getAppFile().save():this.getParent()instanceof PageEditor?await this.getParent().pageFile.save():await this.getParent().getParent().pageFile.save()}}class SqlDataSourceEditor extends DataSourceEditor{static createData(e){return{"@class":"SqlDataSource","@attributes":Object.assign(Object.assign({},DataSourceEditor.createAttributes(e)),{singleQuery:e.singleQuery?e.singleQuery:"",multipleQuery:e.multipleQuery?e.multipleQuery:"",countQuery:e.countQuery?e.countQuery:"",limit:e.limit?e.limit:""}),keyColumns:[...e.keyColumns?e.keyColumns.map(Editor.createItemData):[]]}}}class NoSqlDataSourceEditor extends DataSourceEditor{static createData(e){return{"@class":"NoSqlDataSource","@attributes":Object.assign(Object.assign({},DataSourceEditor.createAttributes(e)),{selectQuery:e.selectQuery?e.selectQuery:"",countQuery:e.countQuery?e.countQuery:"",limit:e.limit?e.limit:""}),keyColumns:[...e.keyColumns?e.keyColumns.map(Editor.createItemData):[]]}}}class FieldEditor extends Editor{static createAttributes(e){if(!e.name)throw new Error("no name");return{name:e.name,caption:void 0!==e.caption?e.caption:e.name,column:void 0!==e.column?e.column:e.name,defaultValue:void 0!==e.defaultValue?e.defaultValue:"",value:void 0!==e.value?e.value:"",param:void 0!==e.param?e.param:"false",visible:void 0!==e.visible?e.visible:"true",type:void 0!==e.type?e.type:"",width:void 0!==e.width?e.width:"",cssBlock:void 0!==e.cssBlock?e.cssBlock:"",viewClass:void 0!==e.viewClass?e.viewClass:"",ctrlClass:void 0!==e.ctrlClass?e.ctrlClass:"",autoFocus:void 0!==e.autoFocus?e.autoFocus:"false"}}changeClass(e){const t=o[`${e}Editor`].createData(this.attributes());return this.setColData(this.getColName(),t),t}async createJs(e){const t=w().join(this.getEditorPath(),"Editor/FieldEditor/Field.js.ejs"),s=await this.getCustomFilePath("js");return await this.createFileByParams(s,t,{page:this.getParent().getParent().getName(),form:this.getParent().getName(),field:this.getName(),formClass:this.getParent().constructor.name.replace("Editor",""),_class:this.constructor.name.replace("Editor","")})}async createJsx(e){const t=w().join(this.getEditorPath(),"Editor/FieldEditor/View.jsx.ejs"),s=await this.getCustomFilePath("jsx");return await this.createFileByParams(s,t,{page:this.getParent().getParent().getName(),form:this.getParent().getName(),field:this.getName(),formClass:this.getParent().constructor.name.replace("Editor",""),_class:this.constructor.name.replace("Editor","")})}async createLess(e){const t=w().join(this.getEditorPath(),"Editor/FieldEditor/View.less.ejs"),s=await this.getCustomFilePath("less");return await this.createFileByParams(s,t,{page:this.getParent().getParent().getName(),form:this.getParent().getName(),field:this.getName(),formClass:this.getParent().constructor.name.replace("Editor",""),_class:this.constructor.name.replace("Editor","")})}async getCollectionDirPath(){const e=await this.getParent().getCustomDirPath();return w().join(e,"fields")}getColName(){return"fields"}}class CheckBoxFieldEditor extends FieldEditor{static createData(e){return{"@class":"CheckBoxField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false"})}}}class CheckBoxListFieldEditor extends FieldEditor{static createData(e){return{"@class":"CheckBoxListField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",dataSourceName:e.dataSourceName?e.dataSourceName:"",valueColumn:e.valueColumn?e.valueColumn:"",displayColumn:e.displayColumn?e.displayColumn:""})}}}class ComboBoxFieldEditor extends FieldEditor{static createData(e){return{"@class":"ComboBoxField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",placeholder:e.placeholder?e.placeholder:"",dataSourceName:e.dataSourceName?e.dataSourceName:"",valueColumn:e.valueColumn?e.valueColumn:"",displayColumn:e.displayColumn?e.displayColumn:"",newRowMode:e.newRowMode?e.newRowMode:"disabled",itemEditPage:e.itemEditPage?e.itemEditPage:"",itemCreatePage:e.itemCreatePage?e.itemCreatePage:"",itemCreateForm:e.itemCreateForm?e.itemCreateForm:"",itemSelectPage:e.itemSelectPage?e.itemSelectPage:""})}}}class DateFieldEditor extends FieldEditor{static createData(e){return{"@class":"DateField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",format:e.format?e.format:"{DD}.{MM}.{YYYY} {hh}:{mm}:{ss}",timezone:e.timezone?e.timezone:"true",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false"})}}}class TimeFieldEditor extends FieldEditor{static createData(e){return{"@class":"TimeField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false"})}}}class DateTimeFieldEditor extends FieldEditor{static createData(e){return{"@class":"DateTimeField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",format:e.format?e.format:"{DD}.{MM}.{YYYY}",timezone:e.timezone?e.timezone:"true",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false"})}}}class FileFieldEditor extends FieldEditor{static createData(e){return{"@class":"FileField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false"})}}}class ImageFieldEditor extends FieldEditor{static createData(e){return{"@class":"ImageField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false"})}}}class LabelFieldEditor extends FieldEditor{static createData(e){return{"@class":"LabelField","@attributes":Object.assign({},FieldEditor.createAttributes(e))}}}class LinkFieldEditor extends FieldEditor{static createData(e){return{"@class":"LinkField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{notNull:e.notNull?e.notNull:"false",page:e.page?e.page:"",displayColumn:e.displayColumn?e.displayColumn:""})}}}class TextAreaFieldEditor extends FieldEditor{static createData(e){return{"@class":"TextAreaField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",rows:e.rows?e.rows:"",cols:e.cols?e.cols:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false"})}}}class TextBoxFieldEditor extends FieldEditor{static createData(e){return{"@class":"TextBoxField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false",autocomplete:e.autocomplete?e.autocomplete:""})}}}class PhoneFieldEditor extends FieldEditor{static createData(e){return{"@class":"PhoneField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false",autocomplete:e.autocomplete?e.autocomplete:""})}}}class PasswordFieldEditor extends FieldEditor{static createData(e){return{"@class":"PasswordField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",placeholder:e.placeholder?e.placeholder:"",validateOnChange:e.validateOnChange?e.validateOnChange:"true",validateOnBlur:e.validateOnBlur?e.validateOnBlur:"false",autocomplete:e.autocomplete?e.autocomplete:""})}}}class RadioFieldEditor extends FieldEditor{static createData(e){return{"@class":"RadioField","@attributes":Object.assign(Object.assign({},FieldEditor.createAttributes(e)),{readOnly:e.readOnly?e.readOnly:"false",notNull:e.notNull?e.notNull:"false",dataSourceName:e.dataSourceName?e.dataSourceName:"",valueColumn:e.valueColumn?e.valueColumn:"",displayColumn:e.displayColumn?e.displayColumn:""})}}}class FormEditor extends Editor{static createAttributes(e){if(!e.name)throw new Error("no name");return{name:e.name,caption:void 0!==e.caption?e.caption:e.name,visible:void 0!==e.visible?e.visible:"true",cssBlock:void 0!==e.cssBlock?e.cssBlock:"",viewClass:void 0!==e.viewClass?e.viewClass:"",ctrlClass:void 0!==e.ctrlClass?e.ctrlClass:"",modelClass:void 0!==e.modelClass?e.modelClass:""}}static createData(e){return(0,P.fF)("FormEditor.createData",e),{"@class":"Form","@attributes":Object.assign({},FormEditor.createAttributes(e)),dataSources:[...e.dataSources?e.dataSources.map(Editor.createItemData):[]],actions:[...e.actions?e.actions.map(Editor.createItemData):[]],fields:[...e.fields?e.fields.map(Editor.createItemData):[]]}}async createJs(e){const t=w().join(this.getEditorPath(),"Editor/FormEditor/Form.js.ejs"),s=await this.getCustomFilePath("js");return await this.createFileByParams(s,t,{page:this.getParent().getName(),form:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createJsx(e){const t=w().join(this.getEditorPath(),"Editor/FormEditor/Form.jsx.ejs"),s=await this.getCustomFilePath("jsx");return await this.createFileByParams(s,t,{page:this.getParent().getName(),form:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createLess(e){const t=w().join(this.getEditorPath(),"Editor/FormEditor/Form.less.ejs"),s=await this.getCustomFilePath("less");return await this.createFileByParams(s,t,{page:this.getParent().getName(),form:this.getName(),_class:this.constructor.name.replace("Editor","")})}async createModelBackJs(e){const t=w().join(await this.getCustomDirPath(),"Model.back.ts"),s=w().join(this.getEditorPath(),"Editor/FormEditor/Model.back.ts.ejs");return await this.createFileByParams(t,s,{page:this.getParent().getName(),form:this.getName(),_class:this.getClassName()})}async getCollectionDirPath(){const e=await this.getParent().getCustomDirPath();return w().join(e,"forms")}getColName(){return"forms"}}class RowFormEditor extends FormEditor{static createData(e){return{"@class":"RowForm","@attributes":Object.assign(Object.assign({},FormEditor.createAttributes(e)),{newMode:e.newMode?e.newMode:"",backOnly:e.backOnly?e.backOnly:"false",refreshButton:e.refreshButton||"true"}),dataSources:[...e.dataSources?e.dataSources.map(Editor.createItemData):[]],actions:[...e.actions?e.actions.map(Editor.createItemData):[]],fields:[...e.fields?e.fields.map(Editor.createItemData):[]]}}}class TableFormEditor extends FormEditor{static createData(e){return{"@class":"TableForm","@attributes":Object.assign(Object.assign({},FormEditor.createAttributes(e)),{editMethod:e.editMethod||"disabled",itemEditPage:e.itemEditPage||"",itemCreatePage:e.itemCreatePage||"",newRowMode:e.newRowMode||"disabled",deleteRowMode:e.deleteRowMode||"disabled",refreshButton:e.refreshButton||"true"}),dataSources:[...e.dataSources?e.dataSources.map(Editor.createItemData):[]],actions:[...e.actions?e.actions.map(Editor.createItemData):[]],fields:[...e.fields?e.fields.map(Editor.createItemData):[]]}}}class PageLinkEditor extends Editor{static createData(e){return{"@class":"PageLink","@attributes":{name:e.name,fileName:e.fileName||`pages/${e.name}/${e.name}.json`,menu:e.menu||("true"===e.startup?"Menu":""),startup:e.startup||"false"}}}getColName(){return"pageLinks"}}class KeyColumnEditor extends Editor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"KeyColumn","@attributes":{name:e.name}}}getColName(){return"keyColumns"}}class DatabaseEditor extends Editor{static createData(e){throw new Error("DatabaseEditor.createData not implemented")}static createAttributes(e){if(!e.name)throw new Error("no name");return{name:e.name,modelClass:void 0!==e.modelClass?e.modelClass:""}}getColName(){return"databases"}}class MySqlDatabaseEditor extends DatabaseEditor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"MySqlDatabase","@attributes":Object.assign({},DatabaseEditor.createAttributes(e)),params:[...e.params?e.params.map(Editor.createItemData):[]],tables:[...e.tables?e.tables.map(Editor.createItemData):[]]}}}class PostgreSqlDatabaseEditor extends DatabaseEditor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"PostgreSqlDatabase","@attributes":Object.assign({},DatabaseEditor.createAttributes(e)),params:[...e.params?e.params.map(Editor.createItemData):[]],tables:[...e.tables?e.tables.map(Editor.createItemData):[]]}}}class MongoDbDatabaseEditor extends DatabaseEditor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"MongoDbDatabase","@attributes":Object.assign({},DatabaseEditor.createAttributes(e)),params:[...e.params?e.params.map(Editor.createItemData):[]],tables:[...e.tables?e.tables.map(Editor.createItemData):[]]}}}class TableEditor extends Editor{static createData(e){return{"@class":"Table","@attributes":{name:e.name},columns:[...e.columns?e.columns.map(Editor.createItemData):[]]}}getColName(){return"tables"}}class ParamEditor extends Editor{static createData(e){if(!e.name)throw new Error("no name");return{"@class":"Param","@attributes":{name:e.name,value:`"${e.value||""}"`}}}getColName(){return"params"}}class ColumnEditor extends Editor{static createData(e){if(!e.name)throw new Error("no name");if(void 0!==e.key&&"string"!=typeof e.key)throw new Error("key not string");if(void 0!==e.auto&&"string"!=typeof e.auto)throw new Error("auto not string");if(void 0!==e.nullable&&"string"!=typeof e.nullable)throw new Error("nullable not string");return{"@class":"Column","@attributes":{name:e.name,caption:e.caption||e.name,type:e.type||"",dbType:e.dbType||"",key:e.key||"false",auto:e.auto||"false",nullable:e.nullable||"true"}}}getColName(){return"columns"}}class EditorController{constructor(e,t){this.appInfo=e,this.hostApp=t}async init(e){}async getView(e){return(0,P.fF)("EditorController.getView"),{data:{}}}createApplicationEditor(){return(0,P.fF)("EditorController.createApplicationEditor"),new ApplicationEditor(this.appInfo.appFile,w().join(this.hostApp.backendDirPath,"editor"))}}class ActionEditorController extends EditorController{async _new(e){(0,P.fF)("ActionEditorController._new");const t=this.createApplicationEditor();let s;if(e.pageFileName){const r=await t.createPageEditor(e.pageFileName);if(e.form){const t=r.createItemEditor("forms",e.form);s=await t.newItemData("Action","actions",e)}else s=await r.newItemData("Action","actions",e);await r.save()}else s=await t.newItemData("Action","actions",e),await t.save();return s}async save(e){const t=this.createApplicationEditor();if(e.pageFileName){const s=await t.createPageEditor(e.pageFileName);if(e.form){s.createItemEditor("forms",e.form).createItemEditor("actions",e.action).setAttr(e.attr,e.value)}else{s.createItemEditor("actions",e.action).setAttr(e.attr,e.value)}await s.save()}else{t.createItemEditor("actions",e.action).setAttr(e.attr,e.value),await t.save()}return null}async delete(e){const t=this.createApplicationEditor();let s;if(e.pageFileName){const r=await t.createPageEditor(e.pageFileName);if(e.form){s=r.createItemEditor("forms",e.form).removeColData("actions",e.action)}else s=r.removeColData("actions",e.action);await r.save()}else s=t.removeColData("actions",e.action),await t.save();return s}async moveUp(e){const t=this.createApplicationEditor();if(e.pageFileName){const s=await t.createPageEditor(e.pageFileName);if(e.form){s.createItemEditor("forms",e.form).moveItemUp("actions",e.action),await s.save()}else s.moveItemUp("actions",e.action),await s.save()}else t.moveItemUp("actions",e.action),await t.save();return null}async moveDown(e){const t=this.createApplicationEditor();if(e.pageFileName){const s=await t.createPageEditor(e.pageFileName);if(e.form){s.createItemEditor("forms",e.form).moveItemDown("actions",e.action),await s.save()}else s.moveItemDown("actions",e.action),await s.save()}else t.moveItemDown("actions",e.action),await t.save();return null}}class DatabaseEditorController extends EditorController{constructor(){super(...arguments),this.application=null}async init(e){await super.init(e),this.application=await this.hostApp.createApplication(e)}async _new(e){const t=this.createApplicationEditor(),s=t.newItemData(e.class,"databases",e);return await t.save(),s}async save(e){(0,P.fF)("DatabaseEditorController.save");const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).setAttr(e.attr,e.value),await t.save(),"ok"}async delete(e){const t=this.createApplicationEditor(),s=t.removeColData("databases",e.database);return await t.save(),s}async getView(e){const t=await super.getView(e);if("DatabaseView/DatabaseView.html"===e.view){const s=this.application.getDatabase(e.database);t.data.tables=await s.getTableList()}return t}async getTableInfo(e){const t=this.application.getDatabase(e.database);return{tableInfo:await t.getTableInfo(e.table)}}async moveUp(e){const t=this.createApplicationEditor();return t.moveItemUp("databases",e.database),await t.save(),"ok"}async moveDown(e){const t=this.createApplicationEditor();return t.moveItemDown("databases",e.database),await t.save(),"ok"}}class DataSourceEditorController extends EditorController{async createDataSourceEditor(e){let t=this.createApplicationEditor();return e.pageFileName&&(t=await t.createPageEditor(e.pageFileName),e.form&&(t=t.createItemEditor("forms",e.form))),t.createItemEditor("dataSources",e.dataSource)}async _new(e){const t=this.createApplicationEditor();let s;if(e.page){const r=await t.createPageEditor(e.page);if(e.form){s=r.createItemEditor("forms",e.form).newItemData(e.class,"dataSources",e)}else s=r.newItemData(e.class,"dataSources",e);await r.save()}else s=t.newItemData(e.class,"dataSources",e),await t.save();return s}async delete(e){const t=this.createApplicationEditor();let s;if(e.page){const r=await t.createPageEditor(e.page);if(e.form){s=r.createItemEditor("forms",e.form).removeColData("dataSources",e.dataSource)}else s=r.removeColData("dataSources",e.dataSource);await r.save()}else s=t.removeColData("dataSources",e.dataSource),await t.save();return s}async moveUp(e){const t=this.createApplicationEditor();if(e.page){const s=await t.createPageEditor(e.page);if(e.form){return s.createItemEditor("forms",e.form).moveItemUp("dataSources",e.dataSource),await s.save(),null}return s.moveItemUp("dataSources",e.dataSource),await s.save(),null}return t.moveItemUp("dataSources",e.dataSource),await t.save(),null}async moveDown(e){const t=this.createApplicationEditor();if(e.page){const s=await t.createPageEditor(e.page);if(e.form){return s.createItemEditor("forms",e.form).moveItemDown("dataSources",e.dataSource),await s.save(),null}return s.moveItemDown("dataSources",e.dataSource),await s.save(),null}return t.moveItemDown("dataSources",e.dataSource),await t.save(),null}async save(e){(0,P.fF)("DataSourceEditorController.save");const t=await this.createDataSourceEditor(e);return t.setAttr(e.attr,e.value),await t.save(),null}async createModelBackJs(e){const t=await this.createDataSourceEditor(e);return{js:await t.createModelBackJs(e)}}async getView(e){const t=await super.getView(e);return e.view,t}}class KeyColumnEditorController extends EditorController{async _new(e){const t=this.createApplicationEditor();if(e.page){const s=await t.createPageEditor(e.page);if(e.form){const t=s.createItemEditor("forms",e.form).createItemEditor("dataSources",e.dataSource).newItemData("KeyColumn","keyColumns",e);return await s.save(),t}{const t=s.createItemEditor("dataSources",e.dataSource).newItemData("KeyColumn","keyColumns",e);return await s.save(),t}}{const s=t.createItemEditor("dataSources",e.dataSource).newItemData("KeyColumn","keyColumns",e);return await t.save(),s}}async save(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.createItemEditor("forms",e.form).createItemEditor("dataSources",e.dataSource).createItemEditor("keyColumns",e.keyColumn).setAttr(e.attr,e.value),await s.save(),null}async delete(e){const t=this.createApplicationEditor();let s,r;if(e.page)if(r=await t.createPageEditor(e.page),e.form){s=r.createItemEditor("forms",e.form).createItemEditor("dataSources",e.dataSource)}else s=r.createItemEditor("dataSources",e.dataSource);else s=t.createItemEditor("dataSources",e.dataSource);const o=s.removeColData("keyColumns",e.keyColumn);return r?await r.save():await t.save(),o}}class PageLinkEditorController extends EditorController{async save(e){const t=this.createApplicationEditor();return t.createItemEditor("pageLinks",e.pageLink).setAttr(e.attr,e.value),await t.save(),null}async moveUp(e){const t=this.createApplicationEditor();return t.moveItemUp("pageLinks",e.page),await t.save(),"ok"}async moveDown(e){const t=this.createApplicationEditor();return t.moveItemDown("pageLinks",e.page),await t.save(),"ok"}}class ParamEditorController extends EditorController{async _new(e){(0,P.fF)("ParamEditorController._new");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).newItemData("Param","params",e);return await t.save(),s}async save(e){(0,P.fF)("ParamEditorController.save");const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).createItemEditor("params",e.param).setAttr(e.attr,e.value),await t.save(),null}async delete(e){(0,P.fF)("ParamEditorController.delete");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).removeColData("params",e.param);return await t.save(),s}}class TableEditorController extends EditorController{async _new(e){(0,P.fF)("TableEditorController._new");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).newItemData("Table","tables",e);return await t.save(),s}async delete(e){(0,P.fF)("TableEditorController.delete");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).removeColData("tables",e.table);return await t.save(),s}async moveUp(e){const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).moveItemUp("tables",e.table),await t.save(),"ok"}async moveDown(e){const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).moveItemDown("tables",e.table),await t.save(),"ok"}async save(e){(0,P.fF)("TableEditorController.save");const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).createItemEditor("tables",e.table).setAttr(e.attr,e.value),await t.save(),null}}class ColumnEditorController extends EditorController{async save(e){(0,P.fF)("ColumnEditorController.save");const t=this.createApplicationEditor();return t.createItemEditor("databases",e.database).createItemEditor("tables",e.table).createItemEditor("columns",e.column).setAttr(e.attr,e.value),await t.save(),"ok"}async _new(e){(0,P.fF)("ColumnEditorController._new");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).createItemEditor("tables",e.table).newItemData("Column","columns",e);return await t.save(),s}async delete(e){(0,P.fF)("ColumnEditorController.delete");const t=this.createApplicationEditor(),s=t.createItemEditor("databases",e.database).createItemEditor("tables",e.table).removeColData("columns",e.column);return await t.save(),s}}class VisualEditorController extends EditorController{}class ApplicationEditorController extends VisualEditorController{async save(e){const t=this.createApplicationEditor();return t.setAttr(e.attr,e.value),await t.save(),null}async getView(e){const t=await super.getView(e);if("VisualView.html"===e.view){const e=this.createApplicationEditor();t.data.js=await e.getCustomFile("js")}return t}async createController(e){const t=this.createApplicationEditor();return{js:await t.createJs(e)}}async createModelBackJs(e){const t=this.createApplicationEditor();return{js:await t.createModelBackJs(e)}}async saveController(e){const t=this.createApplicationEditor();return await t.saveCustomFile("js",e.text),{js:e.text}}}class FieldEditorController extends VisualEditorController{async _new(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName),r=s.createItemEditor("forms",e.form).newItemData(e.class,"fields",e);return await s.save(),r}async save(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.createItemEditor("forms",e.form).createItemEditor("fields",e.field).setAttr(e.attr,e.value),await s.save(),null}async delete(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName),r=s.createItemEditor("forms",e.form).removeColData("fields",e.field);return await s.save(),r}async changeClass(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page),r=s.createItemEditor("forms",e.form).createItemEditor("fields",e.field).changeClass(e.class);return await s.save(),r}async getView(e){const t=await super.getView(e);if("VisualView.html"===e.view){const s=this.createApplicationEditor(),r=(await s.getPage(e.page)).createItemEditor("forms",e.form).createItemEditor("fields",e.field);return t.data.js=await r.getCustomFile("js"),t.data.jsx=await r.getCustomFile("jsx"),t.data.less=await r.getCustomFile("less"),t}return t}async createController(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form).createItemEditor("fields",e.field);return{js:await s.createJs(e)}}async createView(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form).createItemEditor("fields",e.field);return{jsx:await s.createJsx(e)}}async createStyle(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form).createItemEditor("fields",e.field);return{less:await s.createLess(e)}}async saveController(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form).createItemEditor("fields",e.field);return await s.saveCustomFile("js",e.text),{js:e.text}}async moveUp(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.createItemEditor("forms",e.form).moveItemUp("fields",e.field),await s.save(),"ok"}async moveDown(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.createItemEditor("forms",e.form).moveItemDown("fields",e.field),await s.save(),"ok"}}class FormEditorController extends VisualEditorController{async _new(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName),r=await s.newItemData(e.class,"forms",e);return await s.save(),r}async save(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.createItemEditor("forms",e.form).setAttr(e.attr,e.value),await s.save(),null}async delete(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName),r=s.removeColData("forms",e.form);return await s.save(),r}async moveUp(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.moveItemUp("forms",e.form),await s.save(),"ok"}async moveDown(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.pageFileName);return s.moveItemDown("forms",e.form),await s.save(),"ok"}async getView(e){(0,P.fF)("FormEditorController.getView");const t=await super.getView(e);if("VisualView.html"===e.view){const s=this.createApplicationEditor(),r=(await s.getPage(e.page)).createItemEditor("forms",e.form);return t.data.js=await r.getCustomFile("js"),t.data.jsx=await r.getCustomFile("jsx"),t.data.less=await r.getCustomFile("less"),t}return t}async createController(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form);return{js:await s.createJs(e)}}async createView(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form);return{jsx:await s.createJsx(e)}}async createStyle(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form);return{less:await s.createLess(e)}}async saveController(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form);return await s.saveCustomFile("js",e.text),{js:e.text}}async createModelBackJs(e){const t=this.createApplicationEditor(),s=(await t.getPage(e.page)).createItemEditor("forms",e.form);return{js:await s.createModelBackJs(e)}}}class PageEditorController extends VisualEditorController{async get(e){const t=w().join(this.appInfo.dirPath,e.fileName),s=await a._.readTextFile(t);return JSON.parse(s)}async save(e){const t=this.createApplicationEditor(),s=await t.createPageEditor(e.fileName);return s.setAttr(e.attr,e.value),await s.save(),null}async _new(e){const t=this.createApplicationEditor(),s=await t.newPageAndPageLinkData(e);return await t.save(),s}async delete(e){const t=this.createApplicationEditor();await t.removePageFile(e.page);const s=t.removeColData("pageLinks",e.page);return await t.save(),s}async getView(e){const t=await super.getView(e);if("VisualView.html"===e.view){const s=this.createApplicationEditor(),r=await s.getPage(e.page);return t.data.js=await r.getCustomFile("js"),t.data.jsx=await r.getCustomFile("jsx"),t.data.less=await r.getCustomFile("less"),t}return t}async createController(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page);return{js:await s.createJs(e)}}async createView(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page);return{jsx:await s.createJsx(e)}}async createStyle(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page);return{less:await s.createLess(e)}}async saveController(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page);return await s.saveCustomFile("js",e.text),{js:e.text}}async createModelBackJs(e){const t=this.createApplicationEditor(),s=await t.getPage(e.page);return{js:await s.createModelBackJs(e)}}}},688:(e,t,s)=>{s.d(t,{P:()=>BkDatabase});var r=s(484);class BkDatabase extends r.U{constructor(){super(...arguments),this.tables=[],this.params=[],this.fillCollections=["tables"]}async init(e){await this.createColItems("tables",e),await this.createColItems("params",e)}fillAttributes(e){e.name=this.getAttr("name")}async connect(e){throw new Error(`${this.constructor.name}.connect not implemented`)}isConnected(e){return!!e.connections[this.getName()]}getConnection(e){if(!e)throw new Error("no context");const t=this.getName();if(!e.connections[t])throw new Error(`not connected: ${t}`);return e.connections[t]}async release(e){throw new Error(`${this.constructor.name}.release not implemented`)}async queryResult(e,t,s=null){throw new Error(`${this.constructor.name}.queryResult not implemented`)}async queryRows(e,t,s=null){throw new Error(`${this.constructor.name}.queryRows not implemented`)}async queryScalar(e,t,s=null){throw new Error(`${this.constructor.name}.queryScalar not implemented`)}async begin(e){throw new Error(`${this.constructor.name}.begin not implemented`)}async commit(e){throw new Error(`${this.constructor.name}.commit not implemented`)}async rollback(e,t){throw new Error(`${this.constructor.name}.rollback not implemented`)}getDatabaseName(e){return this.getParam("database").getValue()}getConfig(e){const t={host:this.getParam("host").getValue(),database:this.getDatabaseName(e),user:this.getParam("user").getValue(),password:this.getParam("password").getValue()};return this.isData("params","port")&&(t.port=this.getParam("port").getValue()),t}getDefaultPort(){throw new Error(`${this.constructor.name}.getDefaultPort not implemented`)}getApp(){return this.getParent()}findTable(e){return this.tables.find((t=>t.getName()===e))}findParam(e){return this.params.find((t=>t.getName()===e))}getTable(e){if(!e)throw new Error("getTable: no name");const t=this.findTable(e);if(!t)throw new Error(`no table with name: ${e}`);return t}getParam(e){if(!e)throw new Error("getParam: no name");const t=this.findParam(e);if(!t)throw new Error(`no param with name: ${e}`);return t}async insertRow(e,t,s,r={}){throw new Error(`${this.constructor.name}.insertRow not implemented`)}async getTableList(){throw new Error(`${this.constructor.name}.getTableList not implemented`)}async getTableInfo(e){throw new Error(`${this.constructor.name}.getTableInfo not implemented`)}async transaction(e,t){await this.begin(e);try{const s=await t();return await this.commit(e),s}catch(t){throw await this.rollback(e,t),t}}async use(e,t){await this.connect(e);try{return await t(this)}finally{await this.release(e)}}}},537:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{j:()=>BkMongoDbDatabase});var mongodb__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(13),mongodb__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(mongodb__WEBPACK_IMPORTED_MODULE_0__),_BkNoSqlDatabase__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(717),_console__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(978);class BkMongoDbDatabase extends _BkNoSqlDatabase__WEBPACK_IMPORTED_MODULE_1__.A{async connect(e){if((0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.connect",this.getName()),!e)throw new Error("no context");this.checkDeinited();const t=this.getName();if(e.connections[t])throw new Error(`already connected: ${t}`);const s=this.getUrl(),r=new mongodb__WEBPACK_IMPORTED_MODULE_0__.MongoClient(s);(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)(`MongoDbDatabase: connecting to ${s}`),await r.connect();const o=r.startSession();e.connections[t]={client:r,session:o}}getUrl(){const{host:e,user:t,password:s,port:r}=this.getConfig();return`mongodb://${t&&s?`${t}:${s}@`:""}${process.env.DB_HOST||e}:${r||this.getDefaultPort()}/?directConnection=true`}async release(e){if((0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.release",this.getName()),!e)throw new Error("no context");const{client:t,session:s}=this.getConnection(e);s.endSession(),await t.close(),e.connections[this.getName()]=null}async updateOne(e,t,s,r){const o=Object.keys(s).reduce(((e,t)=>(e[t]="_id"===t?new mongodb__WEBPACK_IMPORTED_MODULE_0__.ObjectId(s[t]):s[t],e)),{});return(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("colName",t),(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("_filter:",o),(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("update",r),await this.getDbLink(e).collection(t).updateOne(o,r)}async insertOne(e,t,s){return await this.getDbLink(e).collection(t).insertOne(s)}async deleteOne(e,t,s){const r=BkMongoDbDatabase.makeObjectIds(s);return await this.getDbLink(e).collection(t).deleteOne(r)}static makeObjectIds(e,t=["_id"]){return Object.keys(e).reduce(((s,r)=>(s[r]=t.includes(r)?new mongodb__WEBPACK_IMPORTED_MODULE_0__.ObjectId(e[r]):e[r],s)),{})}getDbLink(e){const t=this.getConnection(e).client,{database:s}=this.getConfig();return t.db(s)}async queryResult(context,query,params=null){const db=this.getDbLink(context),fn="async"===query.trim().substring(0,5)?eval(query):eval(`(db, params, ObjectId) => (${query})`),result=await fn(db,params,mongodb__WEBPACK_IMPORTED_MODULE_0__.ObjectId);return result}async queryRows(e,t,s=null){(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.query",t,s);const r=await this.queryResult(e,t,s);return r instanceof mongodb__WEBPACK_IMPORTED_MODULE_0__.FindCursor||r instanceof mongodb__WEBPACK_IMPORTED_MODULE_0__.AggregationCursor?await r.toArray():[r]}async queryScalar(e,t,s=null){const r=await this.queryResult(e,t,s);if(r instanceof mongodb__WEBPACK_IMPORTED_MODULE_0__.FindCursor||r instanceof mongodb__WEBPACK_IMPORTED_MODULE_0__.AggregationCursor){const e=await r.toArray(),[t]=e;if(!t)throw new Error("queryScalar: no first row");const s=Object.keys(t)[0];if(!s)throw new Error("queryScalar: no first field");return t[s]}return r}getDefaultPort(){return 27017}async begin(e){(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.begin"),this.getConnection(e).session.startTransaction()}async commit(e){(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.commit"),this.getConnection(e).session.commitTransaction()}async rollback(e,t){(0,_console__WEBPACK_IMPORTED_MODULE_2__.fF)("MongoDbDatabase.rollback"),this.getConnection(e).session.abortTransaction()}}},717:(e,t,s)=>{s.d(t,{A:()=>BkNoSqlDatabase});var r=s(688);class BkNoSqlDatabase extends r.P{async updateOne(e,t,s,r){throw new Error(`${this.constructor.name}.updateOne not implemented`)}async insertOne(e,t,s){throw new Error(`${this.constructor.name}.insertOne not implemented`)}async deleteOne(e,t,s){throw new Error(`${this.constructor.name}.deleteOne not implemented`)}}},679:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{a:()=>BkField});var path__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(17),path__WEBPACK_IMPORTED_MODULE_0___default=__webpack_require__.n(path__WEBPACK_IMPORTED_MODULE_0__),_BkModel__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(484),_BkHelper__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(686);class BkField extends _BkModel__WEBPACK_IMPORTED_MODULE_1__.U{fillAttributes(e){e.class=this.getClassName(),e.name=this.getAttr("name"),e.caption=this.getAttr("caption"),e.column=this.getAttr("column"),e.defaultValue=this.getAttr("defaultValue"),e.value=this.getAttr("value"),e.param=this.getAttr("param"),e.visible=this.getAttr("visible"),e.type=this.getAttr("type"),e.width=this.getAttr("width"),e.cssBlock=this.getAttr("cssBlock"),e.viewClass=this.getAttr("viewClass"),e.ctrlClass=this.getAttr("ctrlClass"),e.autoFocus=this.getAttr("autoFocus")}getDirPath(){return path__WEBPACK_IMPORTED_MODULE_0___default().join(this.getParent().getDirPath(),"fields",this.getName())}fillDefaultValue(context,row){const column=this.getAttr("column");if(!column)return;const defaultValue=this.getForm().replaceThis(context,this.getAttr("defaultValue")),params=context.getAllParams(),js=_BkHelper__WEBPACK_IMPORTED_MODULE_2__._.templateToJsString(defaultValue,params);let value;try{value=eval(js),void 0!==value&&(row[column]=this.valueToRaw(value))}catch(e){throw new Error(`[${this.getFullName()}] fillDefaultValue eval error: ${e.toString()}`)}}dumpRowValueToParams(e,t){const s=this.getFullName();try{const r=this.getAttr("column");if(!r)throw new Error("no column attr");const o=e[r],a=void 0!==o?this.rawToValue(o):null;t.setParam(s,a)}catch(e){throw e.message=`${s}: ${e.message}`,e}}getFullName(){return[this.getForm().getPage().getName(),this.getForm().getName(),this.getName()].join(".")}getApp(){return this.getParent().getParent().getParent()}getPage(){return this.getParent().getParent()}getForm(){return this.getParent()}isParam(){return this.isAttr("param")&&"true"===this.getAttr("param")}valueToRaw(e){return _BkHelper__WEBPACK_IMPORTED_MODULE_2__._.encodeValue(e)}rawToValue(e){return _BkHelper__WEBPACK_IMPORTED_MODULE_2__._.decodeValue(e)}isTimezone(){return"true"===this.getAttr("timezone")}getDatabaseTableColumn(){if(!this.getAttr("column"))throw new Error(`${this.getFullName()}: column attr is empty`);return this.getForm().getDataSource("default").getTable().getColumn(this.getAttr("column"))}getType(){if(this.getAttr("column"))return this.getDatabaseTableColumn().getAttr("type");if(this.getAttr("type"))return this.getAttr("type");throw new Error(`${this.getFullName()}: type attr is empty`)}getDbType(){return this.getDatabaseTableColumn().getAttr("dbType")}valueToDbValue(e){return"json"===this.getDbType()?JSON.stringify(e):e}}},484:(e,t,s)=>{s.d(t,{U:()=>BkModel});var r=s(491);class BkModel extends r.g{constructor(){super(...arguments),this.deinited=!1,this.fillCollections=[]}async init(e){}async deinit(){this.checkDeinited(),this.deinited=!0}checkDeinited(){if(this.deinited)throw new Error(`${this.getName()} is already deinited and cannot be used`)}async fill(e){const t={name:""};this.fillAttributes(t);for(const s of this.fillCollections)await this.fillCollection(t,s,e);return t}fillAttributes(e){throw new Error(`${this.constructor.name}.fillAttributes not implemented`)}isBackOnly(){return this.isAttr("backOnly")&&"true"===this.getAttr("backOnly")}async fillCollection(e,t,s){if(this[t]){e[t]=[];for(const r of this[t]){if(r.isBackOnly())continue;const o=await r.fill(s);e[t].push(o)}}}async createColItems(e,t){for(const s of this.getCol(e))await this.createColItem(e,s,t)}async createColItem(e,t,s){try{const r=await this.createChildModel(e,t);await r.init(s),this[e].push(r)}catch(e){const s=r.g.getName(t),o=r.g.getClassName(t);throw e.message=`${o}[${s}]: ${e.message}`,e}}async createChildModel(e,t){const o=r.g.getAttr(t,"modelClass");if(o){const e=global[o];if(!e)throw new Error(`no global class ${o}`);return new e(t,this)}const a=r.g.getClassName(t),i=s(450)[`Bk${a}`];if(!i)throw new Error(`no class backend.${a}`);return new i(t,this)}getDirPath(){return null}async rpc(e,t){throw new Error(`${this.constructor.name}.rpc not implemented`)}}},718:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{U:()=>BkParam});var _BkModel__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(484);class BkParam extends _BkModel__WEBPACK_IMPORTED_MODULE_0__.U{getValue(){const value=this.getAttr("value");try{return eval(value)}catch(e){throw e.message=`eval error: ${e.message}, ${this.getName()} = ${value}`,e}}getApp(){return this.getParent().getApp()}}},978:(e,t,s)=>{s.d(t,{cM:()=>n,fF:()=>i,vU:()=>l});const r=["debug","log","warn","error"];function o(){return r.indexOf(function(){if("object"==typeof window)return window.QFORMS_LOG_LEVEL||"debug";if("object"==typeof global)return process.env.QFORMS_LOG_LEVEL||("dev"===process.env.NODE_ENV?"debug":"log");return"debug"}())}function a(){return"undefined"!=typeof jest}function i(e,...t){o()<=r.indexOf("debug")&&(a()?process.stdout.write(`${[e,...t].join(" ")}\n`):console.debug(e,...t))}function n(e,...t){o()<=r.indexOf("log")&&(a()?process.stdout.write(`${[e,...t].join(" ")}\n`):console.log(e,...t))}function l(e,...t){a()?process.stderr.write(`${[e,...t].join(" ")}\n`):console.error(e,...t)}},920:(e,t,s)=>{s.d(t,{W:()=>Helper});var r=s(689),o=s.n(r),a=s(405),i=s.n(a),n=s(978);class Helper{static formatDate(e,t){const s=e.getFullYear(),r=e.getMonth()+1,o=e.getDate(),a=e.getHours(),i=e.getMinutes(),n=e.getSeconds(),l={YYYY:s,M:r,D:o,h:a,m:i,s:n,MM:r<10?`0${r}`:r,DD:o<10?`0${o}`:o,hh:a<10?`0${a}`:a,mm:i<10?`0${i}`:i,ss:n<10?`0${n}`:n};return t.replace(/\{([\w.]+)\}/g,((e,t)=>l[t]?l[t]:e))}static formatNumber(e){return new Intl.NumberFormat("ru-RU").format(e)}static today(){const e=new Date;return Helper.getStartOfDay(e)}static getStartOfDay(e){return new Date(e.getFullYear(),e.getMonth(),e.getDate())}static encodeObject(e){const t={};for(const s in e)t[s]=Helper.encodeValue(e[s]);return t}static encodeValue(e){return JSON.stringify(e)}static decodeObject(e){if(!e)throw new Error("Helper.decodeObject: no object");const t={};for(const s in e)t[s]=Helper.decodeValue(e[s]);return t}static decodeValue(e){return JSON.parse(e,Helper.dateTimeReviver)}static dateTimeReviver(e,t){if("string"==typeof t){if(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(\.\d{3})?(Z|([+-])(\d{2}):(\d{2}))?$/.exec(t))return new Date(t)}return t}static createReactComponent(e,t,s={},r){let a;const n=o().createElement(o().StrictMode,{},[o().createElement(t,Object.assign(Object.assign({},s),{onCreate:(e,t)=>{a=e}}),r)]);return i().render(n,e),a}static createReactComponent2(e,t,s={},r){let a;const n=o().createElement(o().StrictMode,{},[o().createElement(t,Object.assign(Object.assign({},s),{onCreate:(e,t)=>{a=e}}),r)]);return i().hydrate(n,e),a}static destroyReactComponent(e){i().unmountComponentAtNode(e)}static readFileAsDataURL(e){return new Promise((t=>{const s=new FileReader;s.onload=()=>t(s.result),s.readAsDataURL(e)}))}static templateToJsString(e,t){return e.replace(/\$\{([\w.@]+)\}/g,((e,s)=>t.hasOwnProperty(s)?`Helper.decodeValue('${Helper.encodeValue(t[s])}')`:"undefined"))}static moveArrItem(e,t,s){const r=e.indexOf(t);if(-1===r)throw new Error("cannot find element");const o=r+s;if(o<0)throw new Error("cannot up top element");if(o>e.length-1)throw new Error("cannot down bottom element");e.splice(o,0,e.splice(r,1)[0])}static formatTime(e){let t=e,s="";e<0&&(t=-t,s="-");let r=Math.floor(t/3600),o=Math.floor((t-3600*r)/60),a=Math.floor(t-3600*r-60*o);return r<10&&(r="0"+r),o<10&&(o="0"+o),a<10&&(a="0"+a),0===Math.floor(t/3600)?`${s}${o}:${a}`:`${s}${r}:${o}:${a}`}static formatTime2(e){let t=e,s="";e<0&&(t=-t,s="-");let r=Math.floor(t/3600),o=Math.floor((t-3600*r)/60),a=Math.floor(t-3600*r-60*o);return r<10&&(r="0"+r),o<10&&(o="0"+o),a<10&&(a="0"+a),0===Math.floor(t/3600)?`${s}${o}m:${a}s`:`${s}${r}h:${o}m:${a}s`}static SECOND(){return 1e3}static MINUTE(){return 60*Helper.SECOND()}static HOUR(){return 60*Helper.MINUTE()}static DAY(){return 24*Helper.HOUR()}static WEEK(){return 7*Helper.DAY()}static fallbackCopyTextToClipboard(e){const t=document.activeElement,s=document.createElement("textarea");s.value=e,s.style.top="0",s.style.left="0",s.style.position="fixed",document.body.appendChild(s),s.focus(),s.select(),document.execCommand("copy"),document.body.removeChild(s),t.focus()}static async copyTextToClipboard(e){(0,n.fF)("Helper.copyTextToClipboard",e),navigator.clipboard?await navigator.clipboard.writeText(e):Helper.fallbackCopyTextToClipboard(e)}static addMinutes(e,t){e.setMinutes(e.getMinutes()+t)}static removeTimezoneOffset(e){Helper.addMinutes(e,-e.getTimezoneOffset())}static addTimezoneOffset(e){Helper.addMinutes(e,e.getTimezoneOffset())}static cloneDate(e){return new Date(e.getTime())}static fillArray(e){return Array.from(Array(e).keys())}static setCookie(e,t,s){let r="";if(s){r="; expires="+new Date(s).toUTCString()}document.cookie=e+"="+(encodeURIComponent(t)||"")+r+"; path=/"}static getCookie(e){const t=e+"=",s=document.cookie.split(";");for(let e=0;e<s.length;e++){let r=s[e];for(;" "==r.charAt(0);)r=r.substring(1,r.length);if(0==r.indexOf(t))return decodeURIComponent(r.substring(t.length,r.length))}}static eraseCookie(e){document.cookie=e+"=; Path=/; Expires=Thu, 01 Jan 1970 00:00:01 GMT;"}static delay(e=1e3){return new Promise((t=>{setTimeout(t,e)}))}static registerGlobalClass(e){if("object"==typeof window){if(window[e.name])throw new Error(`window.${e.name} already used`);window[e.name]=e}else{if(global[e.name])throw new Error(`global.${e.name} already used`);global[e.name]=e}}static getGlobalClass(e){return"object"==typeof window?window[e]:global[e]}static addClassToDocumentElement(e){"object"==typeof document&&document.documentElement.classList.add(e)}static headersToRecord(e){return Array.from(e.entries()).reduce(((e,t)=>{const[s,r]=t;return e[s]=r,e}),{})}static queryToString(e){return Object.keys(e).filter((t=>void 0!==e[t])).map((t=>{const s=e[t];return"string"==typeof s?`${t}=${encodeURIComponent(s)}`:Helper.queryRecordToString(t,s)})).join("&")}static queryRecordToString(e,t){return Object.keys(t).filter((e=>void 0!==t[e])).map((s=>{const r=encodeURIComponent(t[s]).replace(/^%22/,'"').replace(/%22$/,'"').replace(/%20/g,"+");return`${e}[${s}]=${r}`})).join("&")}}Helper.registerGlobalClass(Helper)},587:(e,t,s)=>{s.d(t,{e0:()=>g,xu:()=>Box,zx:()=>Button,FB:()=>CancelIcon,Jg:()=>CheckBox,$:()=>CheckBoxList,Tw:()=>l,BX:()=>u,Ct:()=>ComboBox,IH:()=>DateIcon,Mt:()=>DatePicker,pJ:()=>DeleteIcon,qw:()=>DoneIcon_DoneIcon,KL:()=>DownIcon,PS:()=>DropdownButton,Ol:()=>DropdownDatePicker,dY:()=>EditIcon,M0:()=>Expand,Qh:()=>FrontHostApp,rj:()=>Grid,r8:()=>GridCell,Jn:()=>GridRow,Wt:()=>r.W,Ee:()=>Image,Ey:()=>c,_t:()=>LocationIcon,v2:()=>Menu,u_:()=>Modal,Yv:()=>MoreVertIcon,r$:()=>h,ro:()=>Password,CW:()=>PasswordIcon,Fg:()=>PhoneBox,qW:()=>PhoneIcon,Y8:()=>Radio,rN:()=>ReactComponent,m9:()=>d,ol:()=>Search,Ph:()=>Select,ew:()=>SettingsIcon,iR:()=>Slider,XW:()=>Statusbar,OK:()=>Tab,db:()=>Tab2,Kx:()=>TextArea,zC:()=>TextBox,DB:()=>TimeBox,jh:()=>TimeBox2,wZ:()=>TimeIcon,u:()=>Tooltip,K3:()=>VisibilityIcon,X0:()=>VisibilityOffIcon});var r=s(920);class Search{static getObj(){const e=new URLSearchParams(window.location.search),t={};for(const[s,r]of e)t[s]=r;return t}static objToString(e){const t=new URLSearchParams(e).toString();return t?`?${t}`:""}static filter(...e){const t=Search.getObj(),s={};for(const r of e)t.hasOwnProperty(r)&&(s[r]=t[r]);return Search.objToString(s)}}var o=s(978);class FrontHostApp{constructor(e){this.options=e,this.alertCtrl=null,this.documentTitle=""}init(){window.addEventListener("error",this.onWindowError.bind(this)),window.addEventListener("unhandledrejection",this.onWindowUnhandledrejection.bind(this)),window.addEventListener("popstate",this.onWindowPopState.bind(this))}async run(){throw new Error("FrontHostApp.run not implemented")}async onWindowUnhandledrejection(e){(0,o.fF)("FrontHostApp.onWindowUnhandledrejection");try{e.preventDefault();const t=e instanceof Error?e:e.reason||e.detail.reason;this.logError(t),await this.alert({title:"Unhandled Rejection",message:t.message})}catch(e){console.error(`onWindowUnhandledrejection error: ${e.message}`)}}async onWindowError(e){(0,o.fF)("FrontHostApp.onWindowError",e);try{e.preventDefault();const t=e.error;this.logError(t)}catch(e){console.error(`onWindowError error: ${e.message}`)}}logError(e){console.error("FrontHostApp.logError",e)}static async doHttpRequest(e){console.warn("FrontHostApp.doHttpRequest","POST",window.location.href,e);const[,t]=await FrontHostApp.fetchJson("POST",window.location.href,e);return console.warn(`body ${FrontHostApp.composeHandlerName(e)}:`,t),t}static async doHttpRequest2(e,t,s){console.warn("FrontHostApp.doHttpRequest2",e,t,s);const[r,o]=await FrontHostApp.fetchJson(e,t,s);return s?console.warn(`body ${FrontHostApp.composeHandlerName(s)}:`,o):console.warn(o),[r,o]}static composeHandlerName(e){return"rpc"===e.action?e.form?`${e.page}.${e.form}.${e.name}.${e.action}`:e.page?`${e.page}.${e.name}.${e.action}`:`${e.name}.${e.action}`:`${e.page}.${e.form}.${e.ds}.${e.action}`}static async fetchJson(e,t,s){return await FrontHostApp.fetch(e,t,s?JSON.stringify(s):void 0,"application/json")}static async fetch(e,t,s,o){try{FrontHostApp.startWait();const a=await fetch(t,Object.assign({method:e,body:s},o?{headers:{"Content-Type":o}}:{}));if(a.ok){const e=r.W.headersToRecord(a.headers);return[e,await a.json()]}throw new Error(`${a.status} ${a.statusText}: ${await a.text()}`)}finally{FrontHostApp.stopWait()}}static startWait(){document.querySelector("html").classList.add("wait")}static stopWait(){document.querySelector("html").classList.remove("wait")}async onWindowPopState(e){(0,o.fF)("FrontHostApp.onWindowPopState",e.state)}async alert(e){(0,o.fF)("FrontHostApp.alert",e),alert(e.message)}async confirm(e){return(0,o.fF)("FrontHostApp.confirm",e),confirm(e.message)}setDocumentTitle(e){"object"==typeof document?document.title=e:this.documentTitle=e}getDocumentTitle(){return"object"==typeof document?document.title:this.documentTitle}isDebugMode(){return"object"==typeof window?"1"===Search.getObj().debug:this.getOptions().debug}createLink(e=null){const t="object"==typeof window?window.location.pathname:this.getOptions().url.pathname;return e?[t,[...this.isDebugMode()?["debug=1"]:[],...Object.keys(e).map((t=>`${t}=${encodeURI(e[t])}`))].join("&")].join("?"):t}getOptions(){if(!this.options)throw new Error("no options");return this.options}filterSearch(...e){if("object"==typeof window)return Search.filter(...e);const t={},s=this.getOptions().url.searchParams;for(const r of e)s.hasOwnProperty(r)&&(t[r]=s.get(r));return Search.objToString(t)}getSearchParams(){return"object"==typeof window?Search.getObj():Object.fromEntries(this.getOptions().url.searchParams)}getCookie(e){return"object"==typeof window?r.W.getCookie(e):this.getOptions().cookies[e]}getLocation(){return"object"==typeof window?window.location:this.getOptions().url}}var a=s(689),i=s.n(a);class ReactComponent extends a.Component{constructor(e){super(e),e.onCreate&&e.onCreate(this,this.props.name),this.allowRerender=!0}getElement(){return this.el.current}getParent(){return this.props.parent}checkParent(){if(!this.props.parent)throw new Error(`${this.constructor.name}: no parent`)}getClassList(){return[this.getCssBlockName(),...this.props.classList||[],...this.state&&this.state.classList?this.state.classList:[]]}addCssClass(e){-1===this.state.classList.indexOf(e)&&this.state.classList.push(e)}removeCssClass(e){this.state.classList.splice(this.state.classList.indexOf(e),1)}getCssBlockName(){return this.constructor.name}getCssClassNames(){return this.getClassList().join(" ")}rerender(e=!0){return this.canRerender()?new Promise((t=>{const s=Date.now();this.forceUpdate((()=>{e&&console.debug(`${this.constructor.name}.rerender time:`,Date.now()-s),t()}))})):Promise.resolve()}canRerender(){return!!this.allowRerender&&(!this.props.parent||this.props.parent.canRerender())}disableRerender(){console.debug(`${this.constructor.name}.disableRerender`),this.allowRerender=!1}enableRerender(){console.debug(`${this.constructor.name}.enableRerender`),this.allowRerender=!0}componentWillUnmount(){this.props.onUnmount&&this.props.onUnmount(this,this.props.name)}isEnabled(){return!this.isDisabled()}isDisabled(){return this.state&&void 0!==this.state.disabled?this.state.disabled:void 0!==this.props.disabled?this.props.disabled:void 0!==this.props.enabled&&!this.props.enabled}disable(){if(!this.state)throw new Error("no state");this.setState({disabled:!0})}enable(){if(!this.state)throw new Error("no state");this.setState({disabled:void 0})}}"object"==typeof window&&(window.ReactComponent=ReactComponent);var n=s(997);const l=e=>(0,n.jsxs)("svg",Object.assign({width:"10px",height:"10px",viewBox:"0 0 10 10"},{children:[(0,n.jsx)("line",{x1:"2",y1:"2",x2:"8",y2:"8",stroke:"#aaa",strokeWidth:1,strokeMiterlimit:"10"}),(0,n.jsx)("line",{x1:"8",y1:"2",x2:"2",y2:"8",stroke:"#aaa",strokeWidth:1,strokeMiterlimit:"10"})]}));"object"==typeof window&&(window.CloseIcon=l);const c=e=>{const t=e.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:t,width:t,viewBox:"0 0 24 24",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M15.61 7.41L14.2 6l-6 6 6 6 1.41-1.41L11.03 12l4.58-4.59z"})]}))};"object"==typeof window&&(window.LeftIcon=c);const d=e=>{const t=e.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:t,width:t,viewBox:"0 0 24 24",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"})]}))};"object"==typeof window&&(window.RightIcon=d);const h=()=>(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"})]}));"object"==typeof window&&(window.OpenInNewIcon=h);class MoreVertIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"})]}))}}"object"==typeof window&&(window.MoreVertIcon=MoreVertIcon);const u=e=>{const t=e.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",width:t,height:t,viewBox:"0 0 24 24"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"})]}))};"object"==typeof window&&(window.CloseIcon2=u);class VisibilityIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M12 6c3.79 0 7.17 2.13 8.82 5.5C19.17 14.87 15.79 17 12 17s-7.17-2.13-8.82-5.5C4.83 8.13 8.21 6 12 6m0-2C7 4 2.73 7.11 1 11.5 2.73 15.89 7 19 12 19s9.27-3.11 11-7.5C21.27 7.11 17 4 12 4zm0 5c1.38 0 2.5 1.12 2.5 2.5S13.38 14 12 14s-2.5-1.12-2.5-2.5S10.62 9 12 9m0-2c-2.48 0-4.5 2.02-4.5 4.5S9.52 16 12 16s4.5-2.02 4.5-4.5S14.48 7 12 7z"})]}))}}"object"==typeof window&&(window.VisibilityIcon=VisibilityIcon);class VisibilityOffIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0zm0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M12 6c3.79 0 7.17 2.13 8.82 5.5-.59 1.22-1.42 2.27-2.41 3.12l1.41 1.41c1.39-1.23 2.49-2.77 3.18-4.53C21.27 7.11 17 4 12 4c-1.27 0-2.49.2-3.64.57l1.65 1.65C10.66 6.09 11.32 6 12 6zm-1.07 1.14L13 9.21c.57.25 1.03.71 1.28 1.28l2.07 2.07c.08-.34.14-.7.14-1.07C16.5 9.01 14.48 7 12 7c-.37 0-.72.05-1.07.14zM2.01 3.87l2.68 2.68C3.06 7.83 1.77 9.53 1 11.5 2.73 15.89 7 19 12 19c1.52 0 2.98-.29 4.32-.82l3.42 3.42 1.41-1.41L3.42 2.45 2.01 3.87zm7.5 7.5l2.61 2.61c-.04.01-.08.02-.12.02-1.38 0-2.5-1.12-2.5-2.5 0-.05.01-.08.01-.13zm-3.4-3.4l1.75 1.75c-.23.55-.36 1.15-.36 1.78 0 2.48 2.02 4.5 4.5 4.5.63 0 1.23-.13 1.77-.36l.98.98c-.88.24-1.8.38-2.75.38-3.79 0-7.17-2.13-8.82-5.5.7-1.43 1.72-2.61 2.93-3.53z"})]}))}}"object"==typeof window&&(window.VisibilityOffIcon=VisibilityOffIcon);class LocationIcon extends a.Component{render(){const e=this.props.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",width:e,height:e,viewBox:"0 0 24 24"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zM7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 2.88-2.88 7.19-5 9.88C9.92 16.21 7 11.85 7 9z"}),(0,n.jsx)("circle",{cx:"12",cy:"9",r:"2.5"})]}))}}"object"==typeof window&&(window.LocationIcon=LocationIcon);class SettingsIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M19.43 12.98c.04-.32.07-.64.07-.98 0-.34-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.09-.16-.26-.25-.44-.25-.06 0-.12.01-.17.03l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.06-.02-.12-.03-.18-.03-.17 0-.34.09-.43.25l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98 0 .33.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.09.16.26.25.44.25.06 0 .12-.01.17-.03l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.06.02.12.03.18.03.17 0 .34-.09.43-.25l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zm-1.98-1.71c.04.31.05.52.05.73 0 .21-.02.43-.05.73l-.14 1.13.89.7 1.08.84-.7 1.21-1.27-.51-1.04-.42-.9.68c-.43.32-.84.56-1.25.73l-1.06.43-.16 1.13-.2 1.35h-1.4l-.19-1.35-.16-1.13-1.06-.43c-.43-.18-.83-.41-1.23-.71l-.91-.7-1.06.43-1.27.51-.7-1.21 1.08-.84.89-.7-.14-1.13c-.03-.31-.05-.54-.05-.74s.02-.43.05-.73l.14-1.13-.89-.7-1.08-.84.7-1.21 1.27.51 1.04.42.9-.68c.43-.32.84-.56 1.25-.73l1.06-.43.16-1.13.2-1.35h1.39l.19 1.35.16 1.13 1.06.43c.43.18.83.41 1.23.71l.91.7 1.06-.43 1.27-.51.7 1.21-1.07.85-.89.7.14 1.13zM12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"})]}))}}"object"==typeof window&&(window.SettingsIcon=SettingsIcon);class DoneIcon_DoneIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"})]}))}}"object"==typeof window&&(window.DoneIcon=DoneIcon_DoneIcon);class CancelIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none",opacity:".87"}),(0,n.jsx)("path",{d:"M12 2C6.47 2 2 6.47 2 12s4.47 10 10 10 10-4.47 10-10S17.53 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm3.59-13L12 10.59 8.41 7 7 8.41 10.59 12 7 15.59 8.41 17 12 13.41 15.59 17 17 15.59 13.41 12 17 8.41z"})]}))}}"object"==typeof window&&(window.CancelIcon=CancelIcon);class PhoneIcon extends a.Component{render(){const e=this.props.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:e,width:e,viewBox:"0 0 24 24"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M6.54 5c.06.89.21 1.76.45 2.59l-1.2 1.2c-.41-1.2-.67-2.47-.76-3.79h1.51m9.86 12.02c.85.24 1.72.39 2.6.45v1.49c-1.32-.09-2.59-.35-3.8-.75l1.2-1.19M7.5 3H4c-.55 0-1 .45-1 1 0 9.39 7.61 17 17 17 .55 0 1-.45 1-1v-3.49c0-.55-.45-1-1-1-1.24 0-2.45-.2-3.57-.57-.1-.04-.21-.05-.31-.05-.26 0-.51.1-.71.29l-2.2 2.2c-2.83-1.45-5.15-3.76-6.59-6.59l2.2-2.2c.28-.28.36-.67.25-1.02C8.7 6.45 8.5 5.25 8.5 4c0-.55-.45-1-1-1z"})]}))}}"object"==typeof window&&(window.PhoneIcon=PhoneIcon);class PasswordIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",enableBackground:"new 0 0 24 24",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("g",{children:(0,n.jsx)("path",{d:"M0,0h24v24H0V0z",fill:"none"})}),(0,n.jsx)("g",{children:(0,n.jsx)("g",{children:(0,n.jsx)("path",{d:"M2,17h20v2H2V17z M3.15,12.95L4,11.47l0.85,1.48l1.3-0.75L5.3,10.72H7v-1.5H5.3l0.85-1.47L4.85,7L4,8.47L3.15,7l-1.3,0.75 L2.7,9.22H1v1.5h1.7L1.85,12.2L3.15,12.95z M9.85,12.2l1.3,0.75L12,11.47l0.85,1.48l1.3-0.75l-0.85-1.48H15v-1.5h-1.7l0.85-1.47 L12.85,7L12,8.47L11.15,7l-1.3,0.75l0.85,1.47H9v1.5h1.7L9.85,12.2z M23,9.22h-1.7l0.85-1.47L20.85,7L20,8.47L19.15,7l-1.3,0.75 l0.85,1.47H17v1.5h1.7l-0.85,1.48l1.3,0.75L20,11.47l0.85,1.48l1.3-0.75l-0.85-1.48H23V9.22z"})})})]}))}}"object"==typeof window&&(window.PasswordIcon=PasswordIcon);class DeleteIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM8 9h8v10H8V9zm7.5-5l-1-1h-5l-1 1H5v2h14V4h-3.5z"})]}))}}"object"==typeof window&&(window.DeleteIcon=DeleteIcon);class EditIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"24px",viewBox:"0 0 24 24",width:"24px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M14.06 9.02l.92.92L5.92 19H5v-.92l9.06-9.06M17.66 3c-.25 0-.51.1-.7.29l-1.83 1.83 3.75 3.75 1.83-1.83c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.2-.2-.45-.29-.71-.29zm-3.6 3.19L3 17.25V21h3.75L17.81 9.94l-3.75-3.75z"})]}))}}"object"==typeof window&&(window.EditIcon=EditIcon);const g=e=>(0,n.jsx)("svg",Object.assign({width:"10px",height:"6px",viewBox:"0 0 10 6"},{children:(0,n.jsx)("path",{d:"M1.429.253a.819.819 0 0 0-1.184 0 .883.883 0 0 0 0 1.22l4.142 4.274A.821.821 0 0 0 5 6a.821.821 0 0 0 .612-.253l4.143-4.273a.883.883 0 0 0 0-1.221.819.819 0 0 0-1.184 0L5 3.937 1.429.253z"})}));"object"==typeof window&&(window.ArrowIcon=g);class DownIcon extends a.Component{render(){const e=this.props.size||24;return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:e,width:e,viewBox:"0 0 24 24"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"})]}))}}"object"==typeof window&&(window.DoneIcon=DoneIcon);class DateIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",height:"18px",viewBox:"0 0 24 24",width:"18px",fill:"#000000"},{children:[(0,n.jsx)("path",{d:"M0 0h24v24H0V0z",fill:"none"}),(0,n.jsx)("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V10h16v11zm0-13H4V5h16v3z"})]}))}}"object"==typeof window&&(window.DateIcon=DateIcon);class TimeIcon extends a.Component{render(){return(0,n.jsxs)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",enableBackground:"new 0 0 24 24",height:"18px",viewBox:"0 0 24 24",width:"18px",fill:"#000000"},{children:[(0,n.jsx)("g",{children:(0,n.jsx)("rect",{fill:"none",height:"24",width:"24",x:"0"})}),(0,n.jsx)("g",{children:(0,n.jsx)("g",{children:(0,n.jsx)("path",{d:"M12,2C6.5,2,2,6.5,2,12s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z M12,20c-4.41,0-8-3.59-8-8s3.59-8,8-8s8,3.59,8,8 S16.41,20,12,20z M12.5,7H11v6l5.2,3.2l0.8-1.3l-4.5-2.7V7z"})})})]}))}}"object"==typeof window&&(window.TimeIcon=TimeIcon);class Button extends ReactComponent{constructor(e){super(e),this.state={disabled:void 0},this.el=(0,a.createRef)()}isVisible(){return void 0===this.props.visible||this.props.visible}getStyle(){return{display:this.isVisible()?void 0:"none",width:this.props.width}}render(){return(0,n.jsx)("button",Object.assign({className:this.getCssClassNames(),ref:this.el,id:this.props.id,type:this.props.type,name:this.props.name,disabled:this.isDisabled(),onClick:this.props.onClick,onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:this.props.onKeyDown,style:this.getStyle()},{children:this.props.title||this.props.children}))}}"object"==typeof window&&(window.Button=Button);class Box extends ReactComponent{constructor(e){super(e),this.update=()=>{console.debug("Box.update"),this.setState({backgroundColor:"green"})},this.state={backgroundColor:"purple"}}componentDidMount(){console.debug("Box.componentDidMount")}componentWillUnmount(){console.debug("Box.componentWillUnmount")}shouldComponentUpdate(e,t){return console.debug("Box.shouldComponentUpdate",e,t),!0}componentDidUpdate(){console.debug("Box.componentDidUpdate")}render(){return console.debug("Box.render"),(0,n.jsxs)("div",Object.assign({className:"Box"},{children:[(0,n.jsx)(Button,{name:"one"}),(0,n.jsx)(Button,{name:"two"}),(0,n.jsx)(Button,{name:"three"})]}))}}"object"==typeof window&&(window.Box=Box);class CheckBox extends ReactComponent{constructor(e){if(super(e),this.onChange=e=>{this.props.readOnly||this.setState((t=>(this.props.onChange&&this.props.onChange(!t.checked,e),{checked:!t.checked})))},this.onClick=e=>{this.props.readOnly||(this.props.onChange&&this.props.onChange(!0),this.setState({checked:!0}))},void 0!==this.props.checked&&null!==this.props.checked&&"boolean"!=typeof this.props.checked)throw new Error(`wrong checked prop: ${this.props.checked}`);this.state={checked:"boolean"==typeof this.props.checked?this.props.checked:null}}getValue(){return this.state.checked}shouldComponentUpdate(e,t){return this.state.checked="boolean"==typeof e.checked?e.checked:null,!0}render(){return null===this.state.checked?(0,n.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ${this.isDisabled()?"disabled":""}`,onClick:this.onClick},{children:"?"})):(0,n.jsx)("input",{className:this.getCssClassNames(),type:"checkbox",id:this.props.id,checked:this.state.checked,readOnly:this.props.readOnly,disabled:this.props.disabled,"data-tag":this.props.tag,onChange:this.onChange})}}"object"==typeof window&&(window.CheckBox=CheckBox);class ComboBox extends ReactComponent{constructor(e){if(super(e),this.onChange=async e=>{this.setState({value:e.target.value}),this.props.onChange&&await this.props.onChange(e.target.value)},this.onMouseDown=async e=>{this.props.onMouseDown&&await this.props.onMouseDown(e)},!e.items)throw new Error("no ComboBox items");this.state={value:this.getInitialValue()}}getInitialValue(){let e=null;if(void 0!==this.props.value&&null!==this.props.value){e=this.props.value;this.props.items.find((e=>e.value===this.props.value))||this.props.nullable&&""===e||(console.error("ComboBox: no item for value:",JSON.stringify(this.props.value)),console.debug("items:",this.props.items))}else e=this.props.items.length?this.props.items[0].value:"";if(null===e)throw new Error("null is wrong value for ComboBox");return e}getValue(){return this.state.value}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}render(){return(0,n.jsxs)("select",Object.assign({className:this.getCssClassNames(),onChange:this.onChange,value:this.state.value,disabled:this.props.readOnly,size:this.props.size,style:this.props.style,id:this.props.id,onDoubleClick:this.props.onDoubleClick,onMouseDown:this.onMouseDown},{children:[this.props.nullable&&(0,n.jsx)("option",Object.assign({value:""},{children:this.props.placeholder})),this.props.items&&this.props.items.map((e=>(0,n.jsx)("option",Object.assign({value:e.value},{children:e.title||e.value}),e.value)))]}))}}"object"==typeof window&&(window.ComboBox=ComboBox);class Tab extends ReactComponent{constructor(e){super(e),this.onLiMouseDown=e=>{if(e.target.classList.contains("close"))return;const t=parseInt(e.currentTarget.dataset.i);this.props.getActive?this.props.onTabMouseDown&&this.props.onTabMouseDown(t):t!==this.getActive()&&this.selectTab(t)},this.onLiClick=e=>{if(e.target.classList.contains("close")){const t=parseInt(e.currentTarget.dataset.i);this.props.onTabClose&&this.props.onTabClose(t)}},this.state={active:0}}getActive(){return this.props.getActive?this.props.getActive():this.state.active}selectTab(e){if(e===this.getActive())return;const t=Date.now();this.setState({active:e},(()=>console.debug("selectTab time:",Date.now()-t)))}renderTitles(){return this.props.tabs.map(((e,t)=>(0,n.jsxs)("li",Object.assign({className:t===this.getActive()?"active":void 0,onMouseDown:this.onLiMouseDown,onClick:this.onLiClick,"data-i":t},{children:[(0,n.jsx)("span",{children:e.title}),this.props.canClose&&(0,n.jsx)("span",Object.assign({className:"close"},{children:"×"}))]}),e.name)))}renderContents(){return this.props.tabs.map(((e,t)=>(0,n.jsx)("div",Object.assign({className:t===this.getActive()?"active":void 0},{children:e.content}),e.name)))}render(){return(0,n.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[(0,n.jsx)("ul",{children:this.props.tabs&&this.renderTitles()}),(0,n.jsx)("div",{children:this.props.tabs&&this.renderContents()})]}))}}"object"==typeof window&&(window.Tab=Tab);class DropdownButton extends ReactComponent{constructor(e){super(e),this.onButtonClick=e=>{this.setState((e=>({open:!e.open})))},this.onButtonBlur=e=>{this.state.open&&this.setState({open:!1})},this.onKeyDown=e=>{"Escape"===e.key&&this.state.open&&(this.setState({open:!1}),e.stopPropagation())},this.onUlMouseDown=e=>{e.preventDefault()},this.onLiClick=async e=>{const t=e.currentTarget;this.setState({open:!1},(()=>{this.props.onClick&&this.props.onClick(t)}))},this.state={open:!1,disabled:!1}}isEnabled(){return void 0!==this.props.enabled?this.props.enabled:!this.state.disabled}render(){return(0,n.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} ${this.state.open&&"show"}`},{children:[(0,n.jsx)(Button,Object.assign({classList:[`${this.getCssBlockName()}__button`],onClick:this.onButtonClick,onBlur:this.onButtonBlur,enabled:this.isEnabled(),onKeyDown:this.onKeyDown},{children:this.props.title||this.props.children})),(0,n.jsx)("ul",Object.assign({className:`${this.getCssBlockName()}__dropdown`,onMouseDown:this.onUlMouseDown},{children:this.props.actions&&this.props.actions.map((e=>(0,n.jsx)("li",Object.assign({className:`${this.getCssBlockName()}__item ${!1===e.enabled?"disabled":""}`,"data-action":e.name,onClick:!1!==e.enabled?this.onLiClick:void 0},{children:e.title}),e.name)))}))]}))}}r.W.registerGlobalClass(DropdownButton);class TextBox extends ReactComponent{constructor(e){super(e),this.onChange=e=>{this._setValue(e.target.value)},this.el=(0,a.createRef)(),this.state={value:this.props.value||""}}getValue(){return this.state.value}_setValue(e){this.state.value=e,this.forceUpdate(),this.props.onChange&&this.props.onChange(e)}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}render(){return(0,n.jsx)("input",{ref:this.el,className:this.getCssClassNames(),type:this.props.type||"text",id:this.props.id,name:this.props.name,readOnly:this.props.readOnly,disabled:this.isDisabled(),placeholder:this.props.placeholder,autoFocus:this.props.autoFocus,spellCheck:this.props.spellCheck,autoComplete:this.props.autocomplete,required:this.props.required,value:this.state.value,onFocus:this.props.onFocus,onBlur:this.props.onBlur,onChange:this.onChange})}}"object"==typeof window&&(window.TextBox=TextBox);class GridRow extends ReactComponent{isCellActive(e){return this.props.active&&this.props.activeColumn===e}shouldComponentUpdate(e,t){return!this.props.updated||(!!(e.updated-this.props.updated)||(!!(e.resized-this.props.resized)||(this.props.active!==e.active||!(!this.props.active||this.props.activeColumn===e.activeColumn))))}render(){const e=this.props.grid,t=this.props.row,s=this.props.i,r=this.props.rowKey,o=e.props.createLinkCallback?e.props.createLinkCallback(r):null;return(0,n.jsxs)("a",Object.assign({className:`${e.getCssBlockName()}__tr ${this.props.active?"active":""}`,"data-key":r,href:o,onClick:e.onLinkClick},{children:[e.props.columns.map(((o,a)=>(0,n.jsx)("div",Object.assign({className:`${e.getCssBlockName()}__td ${this.isCellActive(a)?"active":""}`,style:{width:e.getColumnWidth(a)},"data-rc":`[${s},${a}]`,"data-row":r,onMouseDown:e.onCellMouseDown,onDoubleClick:e.onCellDoubleClick},{children:e.renderCell(t,o)}),o.name))),!!e.props.extraColumn&&(0,n.jsx)("div",{className:`${e.getCssBlockName()}__td`,"data-r":s,"data-row":r,onMouseDown:e.onRowMouseDown,onDoubleClick:e.onRowDoubleClick})]}))}}"object"==typeof window&&(window.GridRow=GridRow);class GridCell extends ReactComponent{constructor(e){super(e),this.span=a.createRef()}getSpanOffsetWidth(){return this.span.current?this.span.current.offsetWidth:0}renderCellValue(e){const t=this.props.grid.props.decodeValue?r.W.decodeValue(e):e;return"boolean"==typeof t?t.toString():t}render(){const e=this.props.row,t=this.props.column;return(0,n.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`},{children:(0,n.jsx)("span",Object.assign({ref:this.span},{children:this.renderCellValue(e[t.name])}))}))}}"object"==typeof window&&(window.GridCell=GridCell);class Grid extends ReactComponent{constructor(e){super(e),this.onCellMouseDown=async e=>{if(console.debug("Grid.onCellMouseDown",this.isLink()),e.preventDefault(),this.isDisabled())return;this.getElement().focus();const t=e.button,[s,r]=JSON.parse(e.currentTarget.dataset.rc),o=this.props.rows[s],a=e.currentTarget.dataset.row;await this.selectCell(a,r),0===t&&this.props.onClick&&this.props.onClick(o,a)},this.onRowMouseDown=async e=>{console.debug("Grid.onRowMouseDown",this.isLink());const t=e.currentTarget.dataset.row;await this.selectRow(t)},this.onCellDoubleClick=async e=>{const t=e.button,[s,r]=JSON.parse(e.currentTarget.dataset.rc),o=this.props.rows[s],a=e.currentTarget.dataset.row;0===t&&this.props.onDoubleClick&&await this.props.onDoubleClick(o,a)},this.onRowDoubleClick=async e=>{const t=parseInt(e.currentTarget.dataset.r),s=this.props.rows[t],r=e.currentTarget.dataset.row;this.props.onDoubleClick&&await this.props.onDoubleClick(s,r)},this.onKeyDown=async e=>{if(!this.isDisabled())switch(e.keyCode){case 37:e.preventDefault(),await this.onLeft();break;case 38:e.preventDefault(),await this.onUp();break;case 39:e.preventDefault(),await this.onRight();break;case 40:e.preventDefault(),await this.onDown();break;case 13:e.preventDefault(),await this.onEnter();break;case 46:e.preventDefault(),await this.onDelete();break;case 67:e.ctrlKey&&(e.preventDefault(),await this.onCopy())}},this.onResizeDoubleClick=async e=>{console.debug("Grid.onResizeDoubleClick",e.target);const t=parseInt(e.target.dataset.i),s=this.props.columns[t];this.state.columnWidth[s.name]!==this.getMaxColumnWidth(s)&&(this.state.columnWidth[s.name]=this.getMaxColumnWidth(s),this.state.resized=Date.now(),await this.rerender())},this.onCellViewCreate=e=>{const t=e.props.column.name;void 0===this.columns[t]&&(this.columns[t]=[]),this.columns[t].push(e)},this.onCellViewUnmount=e=>{const t=e.props.column.name,s=this.columns[t].indexOf(e);if(-1===s)throw new Error("cannot find FieldView in Grid.columns");this.columns[t].splice(s,1)},this.onBodyScroll=async e=>{this.head.current.scrollLeft=e.target.scrollLeft},this.onLinkClick=async e=>{console.debug("Grid.onLinkClick",e.ctrlKey),e.ctrlKey||e.preventDefault()},this.state={key:this.props.selectedKey||null,column:this.props.selectedKey&&this.props.columns&&this.props.columns.length?0:null,columnWidth:{},resized:Date.now()},this.columns={},this.el=a.createRef(),this.head=a.createRef()}getActiveColumn(){return this.state.column}setActiveColumn(e){this.state.column=e}getActiveRowKey(){return this.state.key}setActiveRowKey(e){this.state.key=e}isRowActive(e,t){return this.getActiveRowKey()===t}async onCopy(){console.debug("Grid.onCopy");const e=this.findRow(this.getActiveRowKey())[this.props.columns[this.getActiveColumn()].name];await r.W.copyTextToClipboard(e)}findRow(e){return this.props.rows.find((t=>this.getRowKey(t)===e))}async onLeft(){console.debug("Grid.onLeft");const e=this.getActiveColumn();e-1>=0&&(this.setActiveColumn(e-1),await this.rerender())}async onUp(){console.debug("Grid.onUp");const e=this.getActiveRowKey(),t=this.findRow(e),s=this.props.rows.indexOf(t);if(s-1>=0){const e=this.props.rows[s-1],t=this.getRowKey(e);this.setActiveRowKey(t),await this.rerender()}}async onRight(){console.debug("Grid.onRight");const e=this.getActiveColumn();e+1<=this.props.columns.length-1&&(this.setActiveColumn(e+1),await this.rerender())}async onDown(){console.debug("Grid.onDown");const e=this.getActiveRowKey(),t=this.findRow(e),s=this.props.rows.indexOf(t);if(s+1<=this.props.rows.length-1){const e=this.props.rows[s+1],t=this.getRowKey(e);this.setActiveRowKey(t),await this.rerender()}}async onEnter(){console.debug("Grid.onEnter");const e=this.getActiveRowKey(),t=this.findRow(e);this.props.onDoubleClick&&await this.props.onDoubleClick(t,e)}async onDelete(){console.debug("Grid.onDelete");const e=this.getActiveRowKey(),t=this.findRow(e);this.props.onDeleteKeyDown&&await this.props.onDeleteKeyDown(t,e)}async selectCell(e,t){this.getActiveRowKey()===e&&this.getActiveColumn()===t||(this.setActiveRowKey(e),this.setActiveColumn(t),this.props.onSelectionChange?await this.props.onSelectionChange(e):await this.rerender())}async selectRow(e){this.getActiveRowKey()!==e&&(this.setActiveRowKey(e),this.props.onSelectionChange?await this.props.onSelectionChange(e):await this.rerender())}getMaxColumnWidth(e){return Math.max(...this.columns[e.name].map((e=>e.getSpanOffsetWidth())))+10+2}getColumnWidth(e){const t=this.props.columns[e];return void 0!==this.state.columnWidth[t.name]?this.state.columnWidth[t.name]:t.width}renderColumns(){return this.props.columns.map(((e,t)=>(0,n.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__th`,style:{width:this.getColumnWidth(t)}},{children:[(0,n.jsx)("div",Object.assign({className:"ellipsis",style:{textAlign:e.align}},{children:e.title||e.name})),(0,n.jsx)("span",{className:"Grid__resize","data-i":t,onDoubleClick:this.onResizeDoubleClick})]}),e.name)))}renderRows(){return this.props.rows.map(((e,t)=>{const s=this.getRowKey(e);return(0,n.jsx)(GridRow,{rowKey:s,grid:this,row:e,i:t,active:this.isRowActive(t,s),activeColumn:this.getActiveColumn(),updated:this.props.updated,resized:this.state.resized},s)}))}getRowKey(e){return this.props.getRowKey?this.props.getRowKey(e):this.props.rows.indexOf(e).toString()}renderCell(e,t){let s;return this.props.renderGridCellView&&(s=this.props.renderGridCellView(e,t,this.onCellViewCreate,this.onCellViewUnmount)),s||(0,n.jsx)(GridCell,{grid:this,row:e,column:t,onCreate:this.onCellViewCreate,onUnmount:this.onCellViewUnmount})}shouldComponentUpdate(e,t){return!this.props.updated||!!(e.updated-this.props.updated)}render(){return(0,n.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} ${this.isDisabled()?"disabled":""}`,ref:this.el,tabIndex:0,onKeyDown:this.onKeyDown},{children:[(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__head`,ref:this.head},{children:(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__table`},{children:(0,n.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__tr`},{children:[this.props.columns&&this.renderColumns(),!!this.props.extraColumn&&(0,n.jsx)("div",{className:`${this.getCssBlockName()}__th`})]}))}))})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__body`,onScroll:this.onBodyScroll},{children:(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__table`},{children:this.props.rows&&this.renderRows()}))}))]}))}isLink(){return!!this.props.createLinkCallback}}"object"==typeof window&&(window.Grid=Grid);class Modal extends ReactComponent{render(){return(0,n.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__container`},{children:this.props.children}))}))}}"object"==typeof window&&(window.Modal=Modal);class Password extends ReactComponent{constructor(e){super(e),this.onChange=e=>{this._setValue(e.target.value)},this.onCloseClick=e=>{this._setValue(""),this.getInputElement().focus()},this.onIconClick=e=>{this.setState((e=>({type:"password"===e.type?"text":"password"}))),this.getInputElement().focus()},this.el=a.createRef(),this.inputEl=a.createRef(),this.state={value:this.props.value||"",type:"password"}}getInputElement(){return this.inputEl.current}getValue(){return this.state.value}_setValue(e){this.state.value=e,this.forceUpdate(),this.props.onChange&&this.props.onChange(e)}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}isCloseVisible(){return""!==this.state.value}render(){return(0,n.jsxs)("div",Object.assign({ref:this.el,className:this.getCssClassNames()},{children:[(0,n.jsx)("input",{ref:this.inputEl,className:`${this.getCssBlockName()}__input`,type:this.state.type,id:this.props.id,name:this.props.name,readOnly:this.props.readOnly,disabled:this.props.disabled,placeholder:this.props.placeholder,autoFocus:this.props.autoFocus,spellCheck:this.props.spellCheck,autoComplete:this.props.autocomplete,value:this.state.value,onFocus:this.props.onFocus,onBlur:this.props.onBlur,onChange:this.onChange}),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${this.isCloseVisible()?"visible":""}`,onClick:this.onCloseClick},{children:(0,n.jsx)(l,{})})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon`,onClick:this.onIconClick},{children:"password"===this.state.type?(0,n.jsx)(VisibilityIcon,{}):(0,n.jsx)(VisibilityOffIcon,{})}))]}))}}"object"==typeof window&&(window.Password=Password);class Menu extends ReactComponent{constructor(e){super(e),this.onMenuClick=async e=>{await this.toggleMenu(e.currentTarget.dataset.menu)},this.onBlur=async e=>{await this.closeMenu(e.currentTarget.dataset.menu)},this.onMouseDown=e=>{e.preventDefault()},this.onMenuItemClick=async e=>{e.persist();const{menu:t,type:s,name:r}=e.target.dataset;await this.closeMenu(t),this.props.onClick&&this.props.onClick(t,s,r)},this.state={}}toggleMenu(e){return new Promise((t=>{this.setState((t=>({[e]:!t[e]})),t)}))}closeMenu(e){return new Promise((t=>this.setState({[e]:!1},t)))}render(){return(0,n.jsx)("div",Object.assign({className:"Menu"},{children:this.props.items&&this.props.items.map((e=>(0,n.jsxs)("div",Object.assign({className:this.state[e.name]?"active":void 0},{children:[(0,n.jsx)("button",Object.assign({"data-menu":e.name,onClick:this.onMenuClick,onBlur:this.onBlur},{children:e.title})),(0,n.jsx)("div",Object.assign({onMouseDown:this.onMouseDown,onClick:this.onMenuItemClick},{children:e.items.map((t=>(0,n.jsx)("a",Object.assign({"data-menu":e.name,"data-type":t.type,"data-name":t.name},{children:t.title}),t.name)))}))]}),e.name)))}))}}"object"==typeof window&&(window.Menu=Menu);class Statusbar extends ReactComponent{constructor(e){super(e),this.state={}}setLastQueryTime(e){this.setState({lastQueryTime:e})}render(){return(0,n.jsx)("div",Object.assign({className:"Statusbar"},{children:(0,n.jsxs)("div",{children:["Last query time:"," ",this.state.lastQueryTime?`${this.state.lastQueryTime} ms`:"-"]})}))}}"object"==typeof window&&(window.Statusbar=Statusbar);class Tooltip extends ReactComponent{render(){return(0,n.jsxs)("div",Object.assign({className:`Tooltip ${this.props.type} ${this.props.hidden?"hidden":""}`},{children:["alert"!==this.props.type&&(0,n.jsx)("div",{children:"tooltip"}),(0,n.jsx)("span",Object.assign({className:this.props.position},{children:this.props.tip||"tip"}))]}))}}"object"==typeof window&&(window.Tooltip=Tooltip);class DatePicker extends ReactComponent{constructor(e){if(super(e),this.onClick=e=>{if(console.debug("DatePicker.onClick",e.target),"TD"===e.target.nodeName&&e.target.classList.contains("selectable"))return this.onDateClick(e.target)},this.onMouseDown=e=>{if(this.props.onMouseDown)return this.props.onMouseDown(e)},this.onNextClick=e=>{this.setState((e=>{const t=new Date(e.selectedMonth[0],e.selectedMonth[1]);return t.setMonth(t.getMonth()+1),{selectedMonth:[t.getFullYear(),t.getMonth()]}}))},this.onPrevClick=e=>{this.setState((e=>{const t=new Date(e.selectedMonth[0],e.selectedMonth[1]);return t.setMonth(t.getMonth()-1),{selectedMonth:[t.getFullYear(),t.getMonth()]}}))},this.props.minDate&&!(this.props.minDate instanceof Array))throw new Error("minDate must be array");this.state={selectedMonth:this.calcSelectedMonth()},this.MONTH=["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"]}static createDateFromArr(e){return new Date(e[0],e[1],e[2])}isVisible(){return!1!==this.props.visible}calcSelectedMonth(){if(this.props.selectedDate)return[this.props.selectedDate[0],this.props.selectedDate[1]];if(this.props.highlightedDate)return[this.props.highlightedDate[0],this.props.highlightedDate[1]];{const e=[r.W.today().getTime()];this.props.minDate&&e.push(DatePicker.createDateFromArr(this.props.minDate).getTime());const t=new Date(Math.min(...e));return[t.getFullYear(),t.getMonth()]}}static getTodayArr(){return DatePicker.dateToArray(new Date)}static dateToArray(e){return[e.getFullYear(),e.getMonth(),e.getDate()]}static getDay(e){let t=e.getDay()-1;return-1===t&&(t=6),0===t&&(t=7),t}createSelectedDate(){if(!this.isDateSelected())throw new Error("date not selected");return new Date(...this.props.selectedDate)}isDateSelected(){return!!this.props.selectedDate}getFirstDateOfTable(){const e=new Date(this.state.selectedMonth[0],this.state.selectedMonth[1],1);return e.setDate(e.getDate()-DatePicker.getDay(e)),e}createMinDate(){if(!this.props.minDate)throw new Error("no min date");return new Date(this.props.minDate[0],this.props.minDate[1],this.props.minDate[2])}isMinDate(){return!!this.props.minDate}isPrevAllowed(){const e=new Date(this.state.selectedMonth[0],this.state.selectedMonth[1]);return e.setMonth(e.getMonth()-1),this.isMonthAllowed(e)}isMonthAllowed(e){if(this.isMinDate()){const t=new Date(this.props.minDate[0],this.props.minDate[1]);return e.getTime()>=t.getTime()}return!0}onDateClick(e){this.props.onDateSelected&&this.props.onDateSelected(JSON.parse(e.dataset.date))}render(){const e=this.getFirstDateOfTable(),t=r.W.today(),s=this.isMinDate()?this.createMinDate():null,o=this.isDateSelected()?this.createSelectedDate():null,a=this.props.highlightedDate?new Date(...this.props.highlightedDate):null;return(0,n.jsxs)("table",Object.assign({className:`${this.getCssClassNames()} ${this.isVisible()?"visible":""}`,onClick:this.onClick,onMouseDown:this.onMouseDown},{children:[(0,n.jsx)("caption",Object.assign({className:`${this.getCssBlockName()}__caption`},{children:(0,n.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__caption-content`},{children:[(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__caption-link ${this.isPrevAllowed()?"enabled":""}`,onClick:this.onPrevClick},{children:(0,n.jsx)(c,{size:18})})),(0,n.jsx)("span",Object.assign({className:`${this.getCssBlockName()}__caption-title`},{children:`${this.MONTH[this.state.selectedMonth[1]]}, ${this.state.selectedMonth[0]}`})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__caption-link enabled`,onClick:this.onNextClick},{children:(0,n.jsx)(d,{size:18})}))]}))})),(0,n.jsx)("thead",{children:(0,n.jsxs)("tr",{children:[(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th`},{children:"Пн"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th`},{children:"Вт"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th`},{children:"Ср"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th`},{children:"Чт"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th`},{children:"Пт"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th weekend`},{children:"Сб"})),(0,n.jsx)("th",Object.assign({className:`${this.getCssBlockName()}__th weekend`},{children:"Вс"}))]})}),(0,n.jsx)("tbody",{children:Array.from(Array(6).keys()).map((r=>(0,n.jsx)("tr",{children:Array.from(Array(7).keys()).map((r=>{const i=[];5!==r&&6!==r||i.push("weekend"),this.isSelectToday()&&e.getTime()===t.getTime()&&i.push("today"),e.getMonth()!==this.state.selectedMonth[1]&&i.push("out"),s?e.getTime()>=s.getTime()&&i.push("selectable"):i.push("selectable"),o&&e.getTime()===o.getTime()&&i.push("selected"),a&&a.getTime()===e.getTime()&&i.push("highlight");const l=e.getDate().toString(),c=JSON.stringify(DatePicker.dateToArray(e)),d=this.props.getDateStyle?this.props.getDateStyle(e):null;return e.setDate(e.getDate()+1),(0,n.jsx)("td",Object.assign({className:`${this.getCssBlockName()}__td  ${i.join(" ")}`,style:d,"data-date":c},{children:l}),l)}))},r)))})]}))}isSelectToday(){return!1!==this.props.selectToday}}"object"==typeof window&&(window.DatePicker=DatePicker);class DropdownDatePicker extends ReactComponent{constructor(e){if(super(e),this.onInputClick=e=>{this.props.readOnly||this.setState((e=>({open:!e.open})))},this.onInputKeyDown=e=>{"Escape"===e.key&&this.state.open&&(this.setState({open:!1}),e.stopPropagation())},this.onCloseDown=async e=>{this.setState({value:null}),this.props.onChange&&this.props.onChange(null)},this.onBlur=e=>{this.state.open&&this.setState({open:!1})},this.onDatePickerMouseDown=e=>{e.preventDefault()},this.onDatePickerDateSelected=e=>{const t=new Date(e[0],e[1],e[2]);this.setState({open:!1,value:t}),this.props.onChange&&this.props.onChange(t)},this.state={open:!1,value:e.value||null},e.value&&!(e.value instanceof Date))throw new Error("need Date type, got "+typeof e.value)}getFormat(){return this.props.format||"{DD}.{MM}.{YYYY} {hh}:{mm}:{ss}"}getStringValue(){const e=this.getValue();if(e){let t=this.getFormat();if(this.isDebugMode()){const s=r.W.formatDate(e,"{hh}:{mm}:{ss}");"{DD}.{MM}.{YYYY}"===t&&"00:00:00"!==s&&(t="{DD}.{MM}.{YYYY} {hh}:{mm}:{ss}")}return r.W.formatDate(e,t)}return""}getSelectedMonth(){return this.getValue()?[this.getValue().getFullYear(),this.getValue().getMonth()]:null}getSelectedDate(){return this.getValue()?[this.getValue().getFullYear(),this.getValue().getMonth(),this.getValue().getDate()]:null}getValue(){return this.state.value}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}getClassList(){return[...super.getClassList(),...this.props.readOnly?["read-only"]:[]]}renderInput(){return(0,n.jsx)("input",{className:`${this.getCssBlockName()}__input`,type:"text",readOnly:!0,onClick:this.onInputClick,onBlur:this.onBlur,value:this.getStringValue(),placeholder:this.props.placeholder,onKeyDown:this.onInputKeyDown})}renderCloseIcon(){return(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${""===this.getStringValue()||this.props.readOnly?"":"visible"}`,onMouseDown:this.onCloseDown},{children:(0,n.jsx)(l,{})}))}renderDateIcon(){return(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon`},{children:(0,n.jsx)(DateIcon,{})}))}renderDatePicker(){return(0,n.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__date-picker-container`},{children:[(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__date-picker-close`},{children:(0,n.jsx)(u,{})})),(0,n.jsx)(DatePicker,{minDate:this.props.minDate,selectedMonth:this.getSelectedMonth(),selectedDate:this.getSelectedDate(),onMouseDown:this.onDatePickerMouseDown,onDateSelected:this.onDatePickerDateSelected,selectToday:this.props.selectToday,highlightedDate:this.props.highlightedDate})]}))}render(){return(0,n.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[this.renderInput(),this.renderCloseIcon(),this.renderDateIcon(),this.state.open&&this.renderDatePicker()]}))}isDebugMode(){return!0===this.props.debug}}"object"==typeof window&&(window.DropdownDatePicker=DropdownDatePicker);class Select extends ReactComponent{constructor(e){super(e),this.onKeyDown=async e=>{this.isVisible()&&(this.setState({visible:!1}),e.stopPropagation())},this.onInputMouseDown=async e=>{if(console.debug("Select.onInputMouseDown"),!this.props.readOnly)if(this.props.onMouseDown)await this.props.onMouseDown(e);else{if(!this.isVisible()){const[e]=this.el.current.querySelectorAll("li.selected");if(e){const t=e.offsetTop-this.dropdown.current.getBoundingClientRect().height/2+e.getBoundingClientRect().height/2;console.debug("scrollTop:",t),this.dropdown.current.scrollTop=t,console.debug("this.dropdown.current.scrollTop",this.dropdown.current.scrollTop)}}this.setState((e=>({visible:!e.visible})))}},this.onInputBlur=async e=>{console.debug("Select.onInputBlur",e.target),this.setState({visible:!1})},this.onDropdownMouseDown=async e=>{e.preventDefault()},this.onDropdownClick=async e=>{console.debug("Select.onDropdownClick",e.target.offsetTop);const t=JSON.parse(e.target.dataset.value);this.setState({value:t,visible:!1},(async()=>{this.props.onChange&&await this.props.onChange(t.toString())}))},this.onCloseClick=async e=>{this.setState({value:""}),this.props.onChange&&await this.props.onChange(""),this.getElement()},this.el=i().createRef(),this.dropdown=i().createRef(),this.state={value:this.getInitialValue(),visible:!1}}isVisible(){return this.state.visible}getInitialValue(){let e=null;if(void 0!==this.props.value&&null!==this.props.value){e=this.props.value;this.getItems().find((e=>e.value===this.props.value))||this.isNullable()&&""===e||(console.error("Select: no item for value:",JSON.stringify(this.props.value)),console.debug("items:",this.getItems()))}else e=this.isNullable()?"":this.props.items.length?this.props.items[0].value:"";if(null===e)throw new Error("null is wrong value for Select");return e}getValue(){return this.state.value}isNullable(){return void 0===this.props.nullable||this.props.nullable}getVisibility(){return this.isVisible()?"visible":"hidden"}getDisplay(){return this.isVisible()?"block":"none"}getItems(){return this.props.items||[]}getValueTitle(e){if(""===e)return"";const t=this.getItems().find((t=>t.value===e));if(!t)throw new Error(`cannot find item by value: ${e}`);return t.title||t.value}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}isCloseVisible(){return!this.props.readOnly&&""!==this.state.value}renderInput(){return(0,n.jsx)("input",{className:`${this.getCssBlockName()}__input`,readOnly:!0,disabled:this.props.readOnly,placeholder:this.props.placeholder,onBlur:this.onInputBlur,value:this.getValueTitle(this.getValue()),onMouseDown:this.onInputMouseDown,onKeyDown:this.onKeyDown})}renderClose(){return(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${this.isCloseVisible()?"visible":""}`,onClick:this.onCloseClick},{children:(0,n.jsx)(l,{})}))}renderIcon(){return(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon ${this.isVisible()?"up":""}`},{children:(0,n.jsx)(g,{})}))}renderDropdown(){return(0,n.jsxs)("ul",Object.assign({ref:this.dropdown,className:`${this.getCssBlockName()}__dropdown`,style:{display:this.getDisplay()},onMouseDown:this.onDropdownMouseDown,onClick:this.onDropdownClick},{children:[this.isNullable()&&(0,n.jsx)("li",Object.assign({className:`${this.getCssBlockName()}__item`,"data-value":'""'},{children:" "})),this.getItems().map((e=>(0,n.jsx)("li",Object.assign({className:`${this.getCssBlockName()}__item ellipsis ${this.getValue()===e.value?"selected":""}`,"data-value":JSON.stringify(e.value)},{children:e.title||e.value}),e.value)))]}))}render(){return(0,n.jsxs)("div",Object.assign({ref:this.el,className:this.getCssClassNames()},{children:[this.renderInput(),this.isNullable()&&this.renderClose(),this.renderIcon(),this.renderDropdown()]}))}}"object"==typeof window&&(window.Select=Select);class TextArea extends ReactComponent{constructor(e){super(e),this.onChange=e=>{this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value)},this.state={value:this.props.value||""}}getValue(){return this.state.value}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}render(){return(0,n.jsx)("textarea",{className:this.getCssClassNames(),readOnly:this.props.readOnly,disabled:this.props.disabled,placeholder:this.props.placeholder,rows:this.props.rows,cols:this.props.cols,value:this.state.value,onChange:this.onChange,onFocus:this.props.onFocus,onBlur:this.props.onBlur})}}"object"==typeof window&&(window.TextArea=TextArea);class Tab2 extends ReactComponent{constructor(e){super(e),this.onLiMouseDown=e=>{if(e.target.classList.contains("close"))return;const t=parseInt(e.currentTarget.dataset.i);this.props.getActive?this.props.onTabMouseDown&&this.props.onTabMouseDown(t):t!==this.getActive()&&this.selectTab(t)},this.onLiClick=e=>{if(e.target.classList.contains("close")){const t=parseInt(e.currentTarget.dataset.i);this.props.onTabClose&&this.props.onTabClose(t)}},this.state={active:0}}getActive(){return this.props.getActive?this.props.getActive():this.state.active}selectTab(e){if(e===this.getActive())return;const t=Date.now();this.setState({active:e},(()=>console.debug("selectTab time:",Date.now()-t)))}renderTitles(){return this.props.tabs.map(((e,t)=>(0,n.jsxs)("li",Object.assign({className:`${this.getCssBlockName()}__button ${t===this.getActive()?"active":""}`,onMouseDown:this.onLiMouseDown,onClick:this.onLiClick,"data-i":t},{children:[(0,n.jsx)("span",{children:e.title}),this.props.canClose&&(0,n.jsx)("span",Object.assign({className:"close"},{children:"×"}))]}),e.name)))}renderContents(){return this.props.tabs.map(((e,t)=>(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__page full ${t===this.getActive()?"active":""}`},{children:e.content}),e.name)))}render(){return(0,n.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[(0,n.jsx)("ul",Object.assign({className:`${this.getCssBlockName()}__buttons`},{children:this.props.tabs&&this.renderTitles()})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__pages`},{children:this.props.tabs&&this.renderContents()}))]}))}}"object"==typeof window&&(window.Tab2=Tab2);class TimeBox extends ReactComponent{constructor(e){if(super(e),this.onKeyPress=e=>{["0","1","2","3","4","5","6","7","8","9"].includes(e.key)||(console.debug("cancel",e.key),e.preventDefault())},this.onChange=e=>{const t=e.target,s=t.selectionStart,r=t.selectionEnd;if(t.value.length>5)return;const o=s===r&&s===t.value.length,a=this.formatValue(t.value);this.setState({value:a},(()=>{if(o||(t.selectionStart=s,t.selectionEnd=r),this.props.onChange){let e;try{e=this.getValue()}catch(t){console.debug(t.message),e=NaN}this.props.onChange(e)}}))},this.onBlur=e=>{if(this.props.onBlur){let e;try{e=this.getValue()}catch(t){console.debug(t.message),e=NaN}this.props.onBlur(e)}},e.value&&"number"!=typeof e.value)throw new Error("need number type, got "+typeof e.value);this.state={value:TimeBox.getStringValue(e.value)},this.el=i().createRef()}formatValue(e){let t="",s="";const r=e.replace(":","");switch(r.length){case 0:break;case 1:case 2:t=r;break;case 3:t=r.substr(0,2),s=r.substr(2,1);break;case 4:t=r.substr(0,2),s=r.substr(2,2)}return[t,...s?[s]:[]].join(":")}getValue(){return TimeBox.getIntegerValue(this.state.value)}setValue(e){this.setState({value:TimeBox.getStringValue(e)})}static getStringValue(e){if(null===e)return"";if(void 0!==e){let t=Math.floor(e/60),s=Math.floor(e-60*t);return t<10&&(t="0"+t),s<10&&(s="0"+s),`${t}:${s}`}return""}static getIntegerValue(e){if(""===e)return null;const t=e.split(":");if(!t[0])throw new Error(`no hours: ${e}`);if(!t[1])throw new Error(`no minutes: ${e}`);if(2!==t[0].length)throw new Error(`hours incomplete: ${e}`);if(2!==t[1].length)throw new Error(`minutes incomplete: ${e}`);const s=parseInt(t[0]),r=parseInt(t[1]);if(s>23)throw new Error(`hours out of range: ${r}, ${e}`);if(r>59)throw new Error(`minutes out of range: ${r}, ${e}`);return 60*s+r}static splitTime(e){const t=Math.floor(e/60);return[t,e-60*t]}shouldComponentUpdate(e,t){return this.props.value!==e.value?(this.state.value=TimeBox.getStringValue(e.value),!0):this.props.readOnly!==e.readOnly||(this.props.placeholder!==e.placeholder||this.state.value!==t.value)}render(){return(0,n.jsx)("input",{ref:this.el,className:this.getCssClassNames(),type:"text",id:this.props.id,readOnly:this.props.readOnly,placeholder:this.props.placeholder,value:this.state.value,onChange:this.onChange,onKeyPress:this.onKeyPress,onBlur:this.onBlur})}}"object"==typeof window&&(window.TimeBox=TimeBox);class PhoneBox extends ReactComponent{constructor(e){super(e),this.onKeyPress=e=>{["+","0","1","2","3","4","5","6","7","8","9"].includes(e.key)||e.preventDefault(),"+"===e.key&&e.target.value.length&&Math.abs(e.target.selectionEnd-e.target.selectionStart)!==e.target.value.length&&e.preventDefault()},this.onChange=e=>{const t=e.target.selectionStart,s=e.target.selectionEnd,r=e.target.value.length;if(t!==s||t!==r)return;let o=PhoneBox.clearValue(e.target.value);o=PhoneBox.ifNoCodeAddRussianCode(o),this.state.value=PhoneBox.formatPhoneNumber(o),this.setState({value:this.state.value}),this.props.onChange&&this.props.onChange(o)},this.onBlur=e=>{let t=PhoneBox.clearValue(e.target.value);t=PhoneBox.ifNoCodeAddRussianCode(t),this.props.onBlur&&this.props.onBlur(t)},this.el=i().createRef(),this.state={value:PhoneBox.formatPhoneNumber(this.props.value||"")}}getValue(){return PhoneBox.clearValue(this.state.value)}shouldComponentUpdate(e,t){return void 0!==e.value&&(this.state.value=PhoneBox.formatPhoneNumber(e.value)),!0}render(){return(0,n.jsx)("input",{ref:this.el,className:this.getCssClassNames(),type:"text",id:this.props.id,name:this.props.name,readOnly:this.props.readOnly,disabled:this.props.disabled,placeholder:this.props.placeholder,autoFocus:this.props.autoFocus,spellCheck:this.props.spellCheck,autoComplete:this.props.autocomplete,value:this.state.value,onFocus:this.props.onFocus,onChange:this.onChange,onBlur:this.onBlur,onKeyPress:this.onKeyPress})}static clearValue(e){return e.replace(/[^\+0-9]/g,"")}static ifNoCodeAddRussianCode(e){if(""===e);else{if(e.match(/^8/))return e.replace(/^8/,"+7");if(e.match(/^7/))return`+${e}`;if("+"!==e[0])return`+7${e}`}return e}static formatPhoneNumber(e){const t=PhoneBox.clearValue(e),s=/(^\+7)(\d{0,3})(\d{0,3})(\d{0,2})(\d{0,2})/.exec(t);if(s){if(s[5])return`${s[1]} ${s[2]} ${s[3]}-${s[4]}-${s[5]}`;if(s[4])return`${s[1]} ${s[2]} ${s[3]}-${s[4]}`;if(s[3])return`${s[1]} ${s[2]} ${s[3]}`;if(s[2])return`${s[1]} ${s[2]}`;if(s[1])return`${s[1]}`}return t}}"object"==typeof window&&(window.PhoneBox=PhoneBox);class TimeBox2 extends TimeBox{constructor(e){super(e),this.onClear=e=>{this.setState({value:""},(()=>{this.props.onClear&&this.props.onClear()}))},this.inputEl=i().createRef()}isCloseVisible(){return!!this.state.value}getInputElement(){return this.inputEl.current}render(){return(0,n.jsxs)("div",Object.assign({ref:this.el,className:this.getCssClassNames()},{children:[(0,n.jsx)("input",{ref:this.inputEl,className:`${this.getCssBlockName()}__input`,type:"text",readOnly:this.props.readOnly,placeholder:this.props.placeholder,value:this.state.value,onChange:this.onChange,onKeyPress:this.onKeyPress,onBlur:this.onBlur}),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close-icon ${this.isCloseVisible()?"visible":""}`,onMouseDown:this.onClear},{children:(0,n.jsx)(l,{})})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__time-icon`},{children:(0,n.jsx)(TimeIcon,{})}))]}))}}class Image extends ReactComponent{constructor(e){super(e),this.onImgClick=async e=>{if(console.debug("Image.onImgClick"),this.props.onClick)return await this.props.onClick();this.setState((e=>e.classList?{classList:null}:{classList:["Image_full"]}))},this.img=i().createRef(),this.state={classList:null}}getNaturalSize(){return[this.img.current.naturalWidth,this.img.current.naturalHeight]}render(){return(0,n.jsx)("img",{className:this.getCssClassNames(),ref:this.img,src:this.props.src,onClick:this.onImgClick})}}"object"==typeof window&&(window.Image=Image);class CheckBoxList extends ReactComponent{constructor(e){if(super(e),this.onCheckBoxChange=e=>{const t=e.target.checked,s=e.target.dataset.value;this.setState((e=>{const r=[...e.value||[]];if(t){if(r.indexOf(s)>-1)throw console.debug("value:",s,t,r),new Error("CheckBoxList value error");r.push(s)}else{if(-1===r.indexOf(s))throw console.debug("value:",s,t,r),new Error("CheckBoxList value error");r.splice(r.indexOf(s),1)}return{value:r}}),(()=>{this.props.onChange&&this.props.onChange(this.getValue())}))},!this.props.name)throw new Error("no CheckBoxList name");this.state={value:this.props.value||[]}}getItems(){return this.props.items||[]}getValue(){return this.state.value||[]}isValueChecked(e){return this.getValue().indexOf(e)>-1}composeItemId(e){return`${this.props.name}.${e}`}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}render(){return(0,n.jsx)("ul",Object.assign({className:this.getCssClassNames()},{children:this.getItems().map((e=>{if(void 0===e.value)throw new Error("no item value");return(0,n.jsxs)("li",{children:[(0,n.jsx)("input",{type:"checkbox",id:this.composeItemId(e.value),checked:this.isValueChecked(e.value),onChange:this.onCheckBoxChange,"data-value":e.value,readOnly:this.props.readOnly}),(0,n.jsx)("label",Object.assign({htmlFor:this.composeItemId(e.value)},{children:e.title||e.value}))]},e.value)}))}))}}"object"==typeof window&&(window.CheckBoxList=CheckBoxList);class Slider extends ReactComponent{constructor(e){if(super(e),this.onPrevClick=e=>{this.setState((e=>{let t=e.image-1;return t<0&&(t=this.props.images.length-1),{image:t}}))},this.onNextClick=e=>{this.setState((e=>{let t=e.image+1;return t>this.props.images.length-1&&(t=0),{image:t}}))},this.onImageClick=e=>{console.debug("Slider.onImageClick"),this.state.classList?this.setState({classList:null}):this.setState({classList:["full"]})},this.onCloseClick=e=>{this.setState({classList:null})},!this.props.images)throw new Error("Slider: no images");this.state={image:0,classList:null}}render(){const e=this.props.images||[];return(0,n.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[(0,n.jsx)("img",{className:"Slider_image",src:e[this.state.image],onClick:this.onImageClick}),e.length>1&&(0,n.jsxs)("div",Object.assign({className:"Slider__label"},{children:[e.length>0?this.state.image+1:0," / ",e.length]})),e.length>1&&(0,n.jsx)("div",Object.assign({className:"Slider__arrow left",onClick:this.onPrevClick},{children:(0,n.jsx)(c,{})})),e.length>1&&(0,n.jsx)("div",Object.assign({className:"Slider__arrow right",onClick:this.onNextClick},{children:(0,n.jsx)(d,{})})),(0,n.jsx)("div",Object.assign({className:"Slider__close",onClick:this.onCloseClick},{children:(0,n.jsx)(u,{})}))]}))}}"object"==typeof window&&(window.Slider=Slider);class Expand extends ReactComponent{constructor(e){super(e),this.onTitleClick=e=>{console.debug("Expand.onTitleClick"),this.setState((e=>({opened:!e.opened})))},this.state={opened:void 0!==this.props.opened&&this.props.opened}}isOpened(){return this.state.opened}isHighlighted(){return!!this.props.highlighted}render(){return(0,n.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} ${this.isOpened()?"opened":""} ${this.isHighlighted()?"highlighted":""}`},{children:[(0,n.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__header`,onClick:this.onTitleClick},{children:[(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon`},{children:(0,n.jsx)(DownIcon,{})})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__title`},{children:this.props.title}))]})),(0,n.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__content`},{children:this.props.children}))]}))}}"object"==typeof window&&(window.Expand=Expand);class Radio extends ReactComponent{constructor(e){if(super(e),this.onChange=async e=>{this.setState({value:e.target.value}),this.props.onChange&&await this.props.onChange(e.target.value)},!e.name)throw new Error("no name");this.state={value:this.getInitialValue()},console.debug("value:",JSON.stringify(this.getValue()))}getInitialValue(){let e=null;if(void 0!==this.props.value&&null!==this.props.value){e=this.props.value;this.props.items.find((e=>e.value===this.props.value))||(console.error("Radio: no item for value:",JSON.stringify(this.props.value)),console.debug("items:",this.props.items))}return e}getValue(){return this.state.value}renderItem(e,t){return[(0,n.jsx)("input",{type:"radio",name:this.props.name,id:`${this.props.name}${t}`,value:e.value,onChange:this.onChange,checked:e.value===this.getValue(),readOnly:this.isReadOnly(),disabled:this.isReadOnly()}),(0,n.jsx)("label",Object.assign({htmlFor:`${this.props.name}${t}`},{children:e.title||e.value}))]}isReadOnly(){return void 0!==this.props.readOnly&&this.props.readOnly}shouldComponentUpdate(e,t){return this.state.value=e.value,!0}render(){const e=this.props.items||[];return(0,n.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:e.map(((e,t)=>this.renderItem(e,t)))}))}}},623:(e,t,s)=>{s.d(t,{Q:()=>Controller});var r=s(689),o=s.n(r),a=s(982);class Controller extends a.v{constructor(){super(...arguments),this.view=null,this.onViewCreate=e=>{this.view=e}}async rerender(){if(this.view)return await this.view.rerender();console.error(`${this.constructor.name}.rerender no view`)}getView(){if(!this.view)throw new Error("no view");return this.view}getViewClass(){throw new Error(`${this.constructor.name}.getViewClass not implemented`)}createElement(){return o().createElement(this.getViewClass(),{ctrl:this,onCreate:this.onViewCreate})}}},367:(e,t,s)=>{s.d(t,{_:()=>ApplicationController});var r=s(111),o=s(377),a=s(783);class WebSocketClient{constructor(e={}){if(this.options=e,!e.applicationController)throw new Error("no options.applicationController");if(!e.protocol)throw new Error("no options.protocol");this.url=`${e.protocol}://${window.location.host}/?${this.createUriParamsString(e)}`,this.webSocket=null,this.refreshTimeoutId=null,this.RECONNECT_TIMEOUT=10,this.REFRESH_TIMEOUT=3600}createUriParamsString(e){const t={route:e.route,uuid:e.uuid,userId:e.userId,version:this.getApp().getModel().getData().versions.app};return Object.keys(t).map((e=>`${e}=${encodeURIComponent(t[e])}`)).join("&")}connect(){return console.debug("WebSocketClient.connect",this.url),new Promise(((e,t)=>{this.webSocket=new WebSocket(this.url),this.webSocket.onclose=async e=>{this.webSocket=null,t(new Error(`Connection failed ${e.code}`))},this.webSocket.onopen=t=>{this.webSocket.onclose=this.onClose.bind(this),this.webSocket.onmessage=this.onMessage.bind(this),this.startRefreshTimeout(),e(t)}}))}async onRefreshTimeout(){this.refreshTimeoutId=null,this.send("ping"),this.startRefreshTimeout()}send(e){console.debug("WebSocketClient.send",e),this.webSocket.send(e)}startRefreshTimeout(){this.refreshTimeoutId=setTimeout(this.onRefreshTimeout.bind(this),1e3*this.REFRESH_TIMEOUT)}resetRefreshTimeout(){this.refreshTimeoutId&&(clearTimeout(this.refreshTimeoutId),this.refreshTimeoutId=null)}async reconnect(){console.debug("WebSocketClient.reconnect");try{await this.connect()}catch(e){console.error(e),console.debug(`waiting ${this.RECONNECT_TIMEOUT} sec for socket reconnect...`),setTimeout((async()=>await this.reconnect()),1e3*this.RECONNECT_TIMEOUT)}}async onClose(e){console.error("WebSocketClient.onClose",e),this.getApp().getHostApp().logError(new Error(`websocket close ${this.getApp().getModel().getDomain()}/${this.getApp().getModel().getName()}`)),this.resetRefreshTimeout(),this.webSocket.onclose=null,this.webSocket.onmessage=null,this.webSocket=null,await this.reconnect()}async onMessage(e){console.debug("WebSocketClient.onMessage",JSON.parse(e.data));const t=JSON.parse(e.data);"result"===t.type&&(this.getApp().getView().disableRerender(),await this.getApp().getModel().emitResult(t.data),this.getApp().getView().enableRerender(),this.getApp().getView().rerender())}getApp(){return this.options.applicationController}}var i=s(587),n=s(409);class ApplicationController extends r.K{constructor(e,t){super(e),this.frontHostApp=t,this.lastId=0,this.activePage=null,this.modals=[],this.statusbar=null,this.homePageName=null,this.webSocketClient=null,this.onRequest=async e=>{console.debug("onRequest",e),this.statusbar&&this.statusbar.setLastQueryTime(e.time),this.getModel().getData().versions.app&&this.getModel().getData().versions.app!==e.remoteAppVersion&&this.createVersionNotificationIfNotExists()},this.onStatusbarCreate=e=>{this.statusbar=e},this.onLogout=async()=>{console.debug("ApplicationController.onLogout");await this.getModel().request("POST",{action:"logout"});location.href=this.getRootPath()},this.onMenuItemClick=async(e,t,s)=>{if(console.debug("ApplicationController.onMenuItemClick",e,t,s),"page"===t)await this.openPage({name:s,modal:!1}),history.pushState({pageName:s},"",this.getHostApp().createLink({page:s}));else if("action"===t)try{if(!await this.onActionClick(s))throw new Error(`no handler for action '${s}'`)}catch(e){console.error(e),await this.alert({message:e.message})}else{if("custom"!==t||"logout"!==s)throw new Error(`unknown menu type/name: ${t}/${s}`);await this.onLogout()}},"object"==typeof window&&console.debug(`${this.constructor.name}.constructor`,e)}static create(e,t){const{ctrlClass:s}=e.getData();if(s){const r=i.Wt.getGlobalClass(s);if(!r)throw new Error(`no class ${s}`);return new r(e,t)}return new ApplicationController(e,t)}init(){super.init(),this.getModel().on("request",this.onRequest);const e=this.getModel().getData().pages[0];this.activePage=e?this.createPage(e,{modal:!1,params:this.getGlobalParams()}):null;const t=this.getActivePageName();this.homePageName=t||this.frontHostApp.getDocumentTitle()}deinit(){this.getModel().off("request",this.onRequest),super.deinit()}getViewClass(){return super.getViewClass()||a.S}createView(e){this.view=i.Wt.createReactComponent2(e,this.getViewClass(),{ctrl:this,key:this.getModel().getName()}),this.statusbar&&this.statusbar.setLastQueryTime(this.getModel().getAttr("time"))}createVersionNotificationIfNotExists(){if(!document.querySelector(".version-notification")){const e=document.createElement("div");e.innerHTML=this.getModel().getText().application.versionNotification,e.className="version-notification",document.querySelector(`.${this.getView().getCssBlockName()}__body`).append(e)}}getGlobalParams(){return{}}createPage(e,t){if(void 0===t.modal)throw new Error("no options.modal");const s=new o.T(e,this.getModel(),t);s.init();const r=n.v.create(s,this,`c${this.getNextId()}`);return r.init(),r}async openPage(e){if(console.debug("ApplicationController.openPage",e),!e.name)throw new Error("no name");const t=this.findPageControllerByPageNameAndKey(e.name,null);if(t)return this.onPageSelect(t),t;const s={action:"page",page:e.name,newMode:void 0!==e.newMode?i.Wt.encodeValue(e.newMode):void 0,params:e.params?i.Wt.encodeObject(e.params):void 0},{page:r}=await this.getModel().request2("GET",`${window.location.pathname}?${i.Wt.queryToString(s)}`);if(void 0===e.modal&&(e.modal=!0),!e.onClose){const t=document.activeElement;e.onClose=()=>{t&&t.focus()}}const o=this.createPage(r,e);return o.isModal()?this.addModal(o):this.addPage(o),await this.rerender(),o}addModal(e){this.modals.push(e)}removeModal(e){const t=this.modals.indexOf(e);if(-1===t)throw new Error(`cannot find modal: ${e.getId()}`);this.modals.splice(t,1)}getNextId(){return this.lastId++,this.lastId}getNewId(){return`c${this.getNextId()}`}addPage(e){this.activePage&&this.closePage(this.activePage),this.activePage=e,this.frontHostApp.setDocumentTitle(this.getTitle())}findPageControllerByPageNameAndKey(e,t){return this.activePage&&this.activePage.getModel().getName()===e&&this.activePage.getModel().getKey()===t?this.activePage:null}onPageSelect(e){console.debug("ApplicationController.onPageSelect",e.getModel().getName())}async closePage(e){if(console.debug("ApplicationController.closePage",e.getModel().getFullName()),this.modals.indexOf(e)>-1)this.modals.splice(this.modals.indexOf(e),1);else{if(this.activePage!==e)throw new Error("page not found");this.activePage=null,document.title=""}await this.rerender(),e.deinit(),e.getModel().deinit()}async onActionClick(e){console.debug("ApplicationController.onActionClick",e)}getMenuItemsProp(){return[...this.getModel().getData().menu?Object.keys(this.getModel().getData().menu).map((e=>({name:e,title:e,items:this.getModel().getData().menu[e].map((e=>({type:e.type,name:e.page||e.action,title:e.caption})))}))):[],...this.getModel().getUser()?[{name:"user",title:`${this.getModel().getDomain()}/${this.getModel().getUser().login}`,items:[{type:"custom",name:"logout",title:"Logout"}]}]:[]]}getActivePageName(){return this.activePage?this.activePage.getModel().getName():null}async onWindowPopState(e){console.debug("ApplicationController.onWindowPopState",e.state),await this.openPage({name:e.state?e.state.pageName:this.homePageName,modal:!1})}getTitle(){return this.activePage?`${this.activePage.getTitle()} - ${this.getModel().getCaption()}`:this.getModel().getCaption()}invalidate(){this.activePage&&this.activePage.invalidate(),this.modals.filter((e=>e instanceof n.v)).forEach((e=>e.invalidate()))}async alert(e){e.title||(e.title=this.getModel().getText().application.alert);const t=document.activeElement;try{return await this.frontHostApp.alert(e)}finally{t&&t.focus()}}async confirm(e){e.title||(e.title=this.getModel().getText().application.confirm),e.yesButton||(e.yesButton=this.getModel().getText().confirm.yes),e.noButton||(e.noButton=this.getModel().getText().confirm.no);const t=document.activeElement;try{return await this.frontHostApp.confirm(e)}finally{t&&t.focus()}}getRootPath(){return"/"}async openModal(e){this.addModal(e),await this.rerender()}async closeModal(e){this.removeModal(e),await this.rerender()}getHostApp(){return this.frontHostApp}async connect(){const e=this.getModel().getData();this.webSocketClient=new WebSocketClient({applicationController:this,protocol:"https:"===window.location.protocol?"wss":"ws",route:e.route,uuid:e.uuid,userId:e.user?e.user.id:null}),await this.webSocketClient.connect()}async rpc(e,t={}){return await this.getModel().rpc(e,t)}getDomain(){return this.getModel().getDomain()}getBaseUrl(){return`/${this.getDomain()}`}}i.Wt.registerGlobalClass(ApplicationController)},783:(e,t,s)=>{s.d(t,{S:()=>ApplicationView});var r=s(997),o=s(689),a=s.n(o),i=s(190),n=s(409),l=s(587),c=s(978);class ApplicationView extends i.H{renderActivePage(){const{ctrl:e}=this.props;return e.activePage?this.renderView(e.activePage):null}renderView(e,t={}){return a().createElement(e.getViewClass(),Object.assign({parent:this,ctrl:e,onCreate:e.onViewCreate},t))}renderModals(){return this.getCtrl().modals.map((e=>e instanceof n.v?(0,r.jsx)(l.u_,{children:this.renderView(e)},e.getId()):this.renderView(e,{key:e.getId()})))}renderHeader(){return(0,r.jsx)("header",Object.assign({className:`${this.getCssBlockName()}__header`},{children:(0,r.jsx)(l.v2,{items:this.getCtrl().getMenuItemsProp(),onClick:this.getCtrl().onMenuItemClick})}))}renderMain(){return(0,r.jsx)("main",Object.assign({className:`${this.getCssBlockName()}__main`},{children:this.renderActivePage()}))}renderFooter(){return(0,r.jsx)("footer",Object.assign({className:`${this.getCssBlockName()}__footer`},{children:(0,r.jsx)(l.XW,{onCreate:this.getCtrl().onStatusbarCreate})}))}render(){return(0,c.fF)(`${this.constructor.name}.render`,this.getCtrl().getModel().getFullName()),(0,r.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__container`,style:this.getStyle()},{children:[this.renderHeader(),this.renderMain(),this.renderFooter(),this.renderModals()]}))}}},534:(e,t,s)=>{s.d(t,{Z:()=>FieldController});var r=s(111),o=s(920);class FieldController extends r.K{static create(e,t){const{ctrlClass:s}=e.getData();if(s){const r=o.W.getGlobalClass(s);if(!r)throw new Error(`no global class ${s}`);return new r(e,t)}const r=`${t.getModel().getClassName()}${e.getClassName()}Controller`,a=o.W.getGlobalClass(r);if(!a)throw new Error(`no global class ${r}`);return new a(e,t)}valueToString(e){switch(typeof e){case"string":return e;case"object":return null===e?"":e instanceof Date?e.toISOString():JSON.stringify(e,null,4);case"number":case"boolean":return e.toString();case"undefined":return"";default:throw new Error(`${this.getModel().getFullName()}: unknown value type: ${typeof e}, value: ${e}`)}}stringToValue(e){const t=this.getModel().getType();if(""===e.trim())return null;if("object"===t||"boolean"===t)return JSON.parse(e);if("date"===t){const t=new Date(e);if("Invalid Date"===t.toString())throw new Error(`${this.getApp().getModel().getText().error.invalidDate}: ${e}`);return t}if("number"===t){const t=Number(e);if(isNaN(t))throw new Error(this.getApp().getModel().getText().error.notNumber);return t}return e}getViewStyle(e){}async openPage(e){return await this.getParent().openPage(e)}getForm(){return this.getParent()}getPage(){return this.getParent().getParent()}getApp(){return this.getParent().getParent().getParent()}isVisible(){return"true"===this.getModel().getAttr("visible")}isAutoFocus(){return"true"===this.getModel().getAttr("autoFocus")}getAutocomplete(){return this.getModel().getAttr("autocomplete")||null}getFormat(){return this.getModel().getAttr("format")}}},423:(e,t,s)=>{s.d(t,{z:()=>FormController});var r=s(111),o=s(587),a=s(534);class FormController extends r.K{static create(e,t){const{ctrlClass:s}=e.getData();if(s){const r=o.Wt.getGlobalClass(s);if(!r)throw new Error(`no class ${s}`);return new r(e,t)}return new(o.Wt.getGlobalClass(`${e.getClassName()}Controller`))(e,t)}constructor(e,t){super(e,t),this.fields={},"object"==typeof window&&console.debug(`${this.constructor.name}.constructor`,e)}init(){for(const e of this.getModel().fields){(this.fields[e.getName()]=a.Z.create(e,this)).init()}}deinit(){for(const e in this.fields)this.fields[e].deinit();super.deinit()}isValid(){return!0}async openPage(e){return await this.getPage().openPage(e)}getPage(){return this.getParent()}isChanged(){return!1}async onFieldChange(e){await this.getPage().onFormChange(e)}getUpdated(){return this.state.updated}invalidate(){this.state.updated=Date.now()}async onActionClick(e,t){console.debug("FormController.onActionClick",e,t)}getField(e){return this.fields[e]}getApp(){return this.getParent().getParent()}getSelectedRowKey(){return null}isAutoFocus(){for(const e in this.fields)if(this.fields[e].isAutoFocus())return!0;return!1}isVisible(){return"true"===this.getModel().getAttr("visible")}getActiveRow(){throw new Error("FormController.getActiveRow not implemented")}getRow(){throw new Error("FormController.getRow not implemented")}}},87:(e,t,s)=>{s.d(t,{m:()=>FormView});var r=s(190);class FormView extends r.H{constructor(e){super(e),this.onActionsClick=async e=>{const t=this.getCtrl(),s=e.dataset.action;try{if(!await t.onActionClick(s,t.getActiveRow()))throw new Error(`no handler for action '${s}'`)}catch(e){console.error(e),await this.getCtrl().getApp().alert({message:e.message})}},this.checkParent()}shouldComponentUpdate(e,t){return console.debug("FormView.shouldComponentUpdate",this.getCtrl().getModel().getFullName(),e.updated-this.props.updated),!!(e.updated-this.props.updated)}}},278:(e,t,s)=>{s.d(t,{i:()=>RowFormController});var r=s(423),o=s(157),a=s(920);class RowFormController extends r.z{constructor(){super(...arguments),this.fields={},this.state={updated:Date.now(),mode:"edit",hasNew:!1,changed:!1,valid:!0},this.onModelRefresh=async e=>{console.debug("RowFormController.onModelRefresh",this.getModel().getFullName()),this.view&&(this.refill(),this.invalidate(),this.rerender())},this.onModelInsert=async e=>{console.debug("RowFormController.onModelInsert",this.getModel().getFullName()),this.refill(),this.invalidate(),this.calcState(),this.getParent().onFormInsert(e)},this.onModelUpdate=async e=>{console.debug("RowFormController.onModelUpdate",this.getModel().getFullName(),e),this.refill(),this.invalidate(),this.calcState(),this.getParent().onFormUpdate(e)},this.onSaveClick=async()=>{if(console.debug("RowFormController.onSaveClick"),this.validate(),this.calcState(),this.isValid())try{this.getApp().getView().disableRerender(),await this.getModel().update(),this.state.mode="view",console.debug("form model updated",this.getModel().getFullName())}finally{this.getApp().getView().enableRerender(),await this.getApp().getView().rerender()}else console.error(`cannot update invalid row form: ${this.getModel().getFullName()}`),await this.rerender()},this.onDiscardClick=()=>{console.debug("RowFormController.onDiscardClick",this.getModel().getFullName());const e=[];for(const t in this.fields){const s=this.fields[t];!s.isChanged()&&s.isValid()||e.push(t)}this.getModel().discard(e),e.forEach((e=>{this.fields[e].refill()})),this.calcState(),this.getModel().hasDefaultPersistentDataSource()&&(this.state.mode="view"),this.rerender(),this.getParent().onFormDiscard(this)},this.onRefreshClick=async()=>{await this.getModel().refresh()},this.onEditClick=e=>{console.debug("RowFormController.onEditClick"),this.state.mode="edit",this.rerender()},this.onCancelClick=e=>{console.debug("RowFormController.onCancelClick"),this.state.mode="view",this.rerender()}}init(){super.init(),this.getModel().on("refresh",this.onModelRefresh),this.getModel().on("insert",this.onModelInsert),this.getModel().on("update",this.onModelUpdate),this.getModel().getDefaultDataSource().isPersistent()&&(this.state.mode="view"),this.calcState(),this.state.hasNew&&(this.state.mode="edit")}deinit(){this.getModel().off("refresh",this.onModelRefresh),this.getModel().off("insert",this.onModelInsert),this.getModel().off("update",this.onModelUpdate),super.deinit()}calcState(){this.state.hasNew=this.getModel().hasNew(),this.state.changed=this.isChanged(),this.state.valid=this.isValid()}refill(){console.debug("RowFormController.refill",this.getModel().getFullName());for(const e in this.fields)this.fields[e].refill()}isValid(){for(const e in this.fields){if(!this.fields[e].isValid())return!1}return!0}validate(){for(const e in this.fields)this.fields[e].validate();this.invalidate()}clearFieldsError(){for(const e in this.fields)this.fields[e].setError(null)}isChanged(){if(this.getModel().isChanged())return!0;for(const e in this.fields){if(this.fields[e].isChanged())return!0}return!1}async onFieldChange(e){this.calcState(),this.invalidate(),await super.onFieldChange(e)}getViewClass(){return super.getViewClass()||o.o}getActiveRow(){return this.getModel().getRow(!0)}getRow(){return this.getModel().getRow(!0)}getMode(){return this.state.mode}isActionEnabled(e){return this.isViewMode()}isEditMode(){return"edit"===this.getMode()}isViewMode(){return"view"===this.getMode()}getField(e){return this.fields[e]}}a.W.registerGlobalClass(RowFormController)},157:(e,t,s)=>{s.d(t,{o:()=>RowFormView});var r=s(997),o=s(87),a=s(587),i=s(978);class RowFormView extends o.m{renderToolbar(){const{ctrl:e}=this.props,t=e.getModel().getApp().getText();return(0,r.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__toolbar flex grid-gap-5`},{children:[e.getModel().hasDefaultPersistentDataSource()&&(0,r.jsx)(a.zx,Object.assign({classList:["toolbar-button"],onClick:e.onEditClick,visible:"view"===e.getMode()},{children:(0,r.jsx)("div",{children:t.form.edit})}),"edit"),e.getModel().hasDefaultPersistentDataSource()&&(0,r.jsx)(a.zx,Object.assign({classList:["toolbar-button"],enabled:(e.state.changed||e.state.hasNew)&&e.state.valid,onClick:e.onSaveClick,visible:"edit"===e.getMode()},{children:(0,r.jsx)("div",{children:t.form.save})}),"save"),e.getModel().hasDefaultPersistentDataSource()&&e.getModel().getKey()&&(0,r.jsx)(a.zx,Object.assign({classList:["toolbar-button"],visible:"edit"===e.getMode()&&!e.state.changed&&e.state.valid,onClick:e.onCancelClick},{children:(0,r.jsx)("div",{children:t.form.cancel})}),"cancel"),e.getModel().hasDefaultPersistentDataSource()&&e.getModel().getKey()&&(0,r.jsx)(a.zx,Object.assign({classList:["toolbar-button"],enabled:e.state.changed||!e.isValid(),onClick:e.onDiscardClick,visible:"edit"===e.getMode()&&(e.state.changed||!e.state.valid)},{children:(0,r.jsx)("div",{children:t.form.discard})}),"discard"),e.getModel().hasDefaultPersistentDataSource()&&"true"===e.getModel().getAttr("refreshButton")&&(0,r.jsx)(a.zx,Object.assign({classList:["toolbar-button"],enabled:!e.state.changed&&!e.state.hasNew,onClick:e.onRefreshClick,visible:"view"===e.getMode()},{children:(0,r.jsx)("div",{children:t.form.refresh})}),"refresh"),this.isActionsVisible()&&e.getModel().hasActions()&&(0,r.jsx)(a.PS,Object.assign({classList:["toolbar-dropdown-button"],actions:this.getActionsForDropdownButton(),onClick:this.onActionsClick,enabled:this.isActionsEnabled()},{children:(0,r.jsx)(a.Yv,{})}))]}))}isActionsEnabled(){return!0}isActionsVisible(){return!this.getCtrl().getModel().hasDefaultPersistentDataSource()||!!this.getCtrl().getModel().getKey()}renderLabel(e){const t=e.getModel(),s=t.getName();return(0,r.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__label`},{children:[t.getCaption(),":",t.isNotNull()&&(0,r.jsx)("span",Object.assign({style:{color:"red"}},{children:"*"}))]}),`label.${s}`)}renderField(e){const t=e.getModel().getName();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__field`},{children:this.renderFieldView(e)}),`field.${t}`)}renderFieldView(e){return RowFormView.renderFieldView(e)}static renderFieldView(e){return e.renderView()}renderError(e){const t=e.getModel().getName();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__error`},{children:(0,r.jsx)(a.u,{position:"left",type:"alert",hidden:null===e.getErrorMessage(),tip:e.getErrorMessage()})}),`tooltip.${t}`)}renderGroup(e){return[this.renderLabel(e),this.renderField(e),this.renderError(e)]}renderGroups(){const e=this.getCtrl();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__groups`},{children:Object.keys(e.fields).filter((t=>e.getField(t).isVisible())).map((t=>this.renderGroup(e.getField(t))))}))}render(){return(0,i.fF)("RowFormView.render",this.getCtrl().getModel().getFullName()),(0,r.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} flex-column grid-gap-5`,style:this.getStyle()},{children:[(this.getCtrl().getModel().hasDefaultPersistentDataSource()||this.getCtrl().getModel().hasActions())&&this.renderToolbar(),this.renderGroups()]}))}}},111:(e,t,s)=>{s.d(t,{K:()=>ModelController});var r=s(623),o=s(190),a=s(587);class ModelController extends r.Q{constructor(e,t){super(),this.model=e,this.parent=t,this.deinited=!1}init(){}deinit(){if(this.deinited)throw new Error(`${this.getModel().getFullName()}: controller already deinited`);this.deinited=!0}getModel(){return this.model}getParent(){if(!this.parent)throw new Error(`${this.getModel().getFullName()}: no controller parent`);return this.parent}getTitle(){return this.getModel().getCaption()}getViewClass(){const e=this.getModel();if(!e.isAttr("viewClass"))throw new Error(`${this.constructor.name} not supports view`);const t=e.getAttr("viewClass");if(t){const e=a.Wt.getGlobalClass(t);if(!e)throw new Error(`no class ${t}`);if(!(e.prototype instanceof o.H))throw new Error(`view class ${t} is not inherited from ModelView`);return e}return null}isActionEnabled(e){return!1}}},190:(e,t,s)=>{s.d(t,{H:()=>ModelView});var r=s(997),o=s(805),a=s(106);class ModelView extends o.G{constructor(){super(...arguments),this.renderActionIcon=void 0}getActionsForDropdownButton(){return this.getCtrl().getModel().getCol("actions").map((e=>{const t=a.H.getName(e);return{name:t,title:this.renderActionIcon?[(0,r.jsx)("div",{children:this.renderActionIcon(t)},"icon"),(0,r.jsx)("div",{children:a.H.getAttr(e,"caption")},"title")]:a.H.getAttr(e,"caption"),enabled:this.getCtrl().isActionEnabled(t)}}))}getCssBlockName(){const e=this.getCtrl().getModel();return e.isAttr("cssBlock")&&e.getAttr("cssBlock")?e.getAttr("cssBlock"):super.getCssBlockName()}getStyle(e){}}},409:(e,t,s)=>{s.d(t,{v:()=>PageController});var r=s(855),o=s(111),a=s(920),i=s(423),n=s(677),l=s(278),c=s(324);class PageController extends o.K{constructor(e,t,s){if(super(e,t),this.forms=[],this.onSaveAndCloseClick=async()=>{if(console.debug("PageController.onSaveAndCloseClick"),this.validate(),this.isValid()){try{this.getApp().getView().disableRerender(),await this.getModel().update(),console.debug("page model updated",this.getModel().getFullName())}finally{this.getApp().getView().enableRerender()}await this.getApp().closePage(this),this.getModel().getOptions().onClose&&this.getModel().getOptions().onClose()}else await this.rerender()},this.onClosePageClick=async e=>{console.debug("PageController.onClosePageClick",this.getModel().getFullName()),await this.close()},this.onOpenPageClick=async e=>{const t=this.getModel().getName(),s=this.getModel().getKey(),r=this.createOpenInNewLink(t,s);window.open(r,"_blank")},this.onKeyDown=async e=>{"Escape"===e.key&&this.isModal()&&await this.close()},this.onSelectClick=async e=>{console.debug("PageController.onSelectClick"),await this.selectRow(this.getSelectedRowKey())},this.onResetClick=async e=>{console.debug("PageController.onResetClick"),await this.selectRow(null)},"object"==typeof window&&console.debug(`${this.constructor.name}.constructor`,e,s),!s)throw new Error("no id");this.id=s}static create(e,t,s,r=null){const{ctrlClass:o}=e.getData();if(o){const i=a.W.getGlobalClass(o);if(!i)throw new Error(`no class ${o}`);return new i(e,t,s,r)}return new PageController(e,t,s,r)}init(){for(const e of this.getModel().forms){const t=i.z.create(e,this);t.init(),this.forms.push(t)}}deinit(){console.debug("PageController.deinit: "+this.getModel().getFullName());for(const e of this.forms)e.deinit();super.deinit()}createOpenInNewLink(e,t){return this.getApp().getHostApp().createLink(Object.assign({page:e},n.o.keyToParams(t)))}async close(){const e=this.isChanged();if(this.getModel().hasRowFormWithDefaultSqlDataSource()&&e){if(!await this.getApp().confirm({message:this.getModel().getApp().getText().form.areYouSure}))return}await this.getApp().closePage(this),this.getModel().getOptions().onClose&&this.getModel().getOptions().onClose()}validate(){for(const e of this.forms)e instanceof l.i&&e.validate()}isValid(){for(const e of this.forms)if(!e.isValid())return!1;return!0}async onFormChange(e){this.rerender()}onFormDiscard(e){console.debug("PageController.onFormDiscard",this.getModel().getFullName()),this.rerender()}onFormUpdate(e){console.debug("PageController.onFormUpdate:",this.getModel().getFullName(),e),this.rerender()}onFormInsert(e){console.debug("PageController.onFormInsert:",this.getModel().getFullName());for(const e of this.forms)e.invalidate();this.rerender()}async openPage(e){e.params||(e.params={});const t=this.getModel().getParams();for(const s in t)e.params[s]||(e.params[s]=t[s]);return await this.getApp().openPage(e)}isChanged(){for(const e of this.forms)if(e.isChanged())return!0;return!1}getApp(){return this.getParent()}getViewClass(){return super.getViewClass()||c.B}findForm(e){return this.forms.find((t=>t.getModel().getName()===e))}getForm(e){const t=this.findForm(e);if(!t)throw new Error(`${this.getModel().getFullName()}: no form controller ${e}`);return t}async onActionClick(e){console.debug("PageController.onActionClick",e)}getKeyPart(e){const t=(0,r.mV)(e);return 1===t.length&&"number"==typeof t[0]?`#${t[0]}`:`${e}`}getTitle(){const e=this.getModel(),t=e.getKey(),s=t?this.getKeyPart(t):null;return[e.getCaption(),...this.getApp().getHostApp().isDebugMode()?[`(${this.getId()})`]:[],...s?[s]:[]].join(" ")}getSelectedRowKey(){for(const e of this.forms){const t=e.getSelectedRowKey();if(t)return t}return null}async selectRow(e){console.debug("PageController.selectRow",e),await this.close(),await this.getModel().getOptions().onSelect(e)}invalidate(){this.forms.forEach((e=>e.invalidate()))}getId(){return this.id}isModal(){return this.getModel().isModal()}isAutoFocus(){for(const e of this.forms)if(e.isAutoFocus())return!0;return!1}}a.W.registerGlobalClass(PageController)},324:(e,t,s)=>{s.d(t,{B:()=>PageView});var r=s(997),o=s(689),a=s.n(o),i=s(190),n=s(587),l=s(978);class PageView extends i.H{constructor(e){super(e),this.onActionsClick=async e=>{const t=this.getCtrl(),s=e.dataset.action;try{if(!await t.onActionClick(s))throw new Error(`no handler for action '${s}'`)}catch(e){console.error(e),await this.getCtrl().getApp().alert({message:e.message})}},this.checkParent(),this.el=a().createRef()}isToolbar(){return this.getCtrl().getModel().hasActions()}getFormTabs(e){return e.map((e=>({name:e.getModel().getName(),title:e.getTitle(),content:this.renderForm(e)})))}getRowForms(){return this.getCtrl().forms.filter((e=>"RowForm"===e.getModel().getClassName())).filter((e=>e.isVisible()))}getTableForms(){return this.getCtrl().forms.filter((e=>"TableForm"===e.getModel().getClassName())).filter((e=>e.isVisible()))}renderForm(e,t={}){return a().createElement(e.getViewClass(),Object.assign({parent:this,key:e.getModel().getName(),ctrl:e,onCreate:e.onViewCreate,updated:e.getUpdated()},t))}renderRowForms(){return this.getRowForms().map((e=>this.renderForm(e)))}renderTitle(){const e=this.getCtrl(),t=e.getModel();return(0,r.jsxs)("h1",Object.assign({className:`${this.getCssBlockName()}__title`},{children:[e.getTitle(),t.hasRowFormWithDefaultSqlDataSource()&&(e.isChanged()||t.hasNew())&&[" ",(0,r.jsx)("span",Object.assign({className:`${this.getCssBlockName()}__star`},{children:"*"}),"star")]]}))}renderSelectButton(){const e=this.getCtrl(),t=e.getModel();return(0,r.jsx)(n.zx,Object.assign({classList:["toolbar-button","default"],onClick:e.onSelectClick,enabled:!!e.getSelectedRowKey()},{children:(0,r.jsx)("div",{children:t.getApp().getText().page.select})}))}renderSaveAndCloseButton(){const e=this.getCtrl(),t=e.getModel();return(0,r.jsx)(n.zx,Object.assign({classList:["toolbar-button","default"],onClick:e.onSaveAndCloseClick,enabled:e.isValid()&&(t.hasNew()||e.isChanged())},{children:(0,r.jsx)("div",{children:t.getApp().getText().page.saveAndClose})}))}renderCloseButton(){const e=this.getCtrl(),t=e.getModel();return(0,r.jsx)(n.zx,Object.assign({classList:["toolbar-button"],onClick:e.onClosePageClick},{children:(0,r.jsx)("div",{children:t.getApp().getText().page.close})}))}renderActionsDropdownButton(){return(0,r.jsx)(n.PS,Object.assign({classList:["toolbar-dropdown-button"],actions:this.getActionsForDropdownButton(),onClick:this.onActionsClick},{children:(0,r.jsx)(n.Yv,{})}))}renderToolbar(){const e=this.getCtrl().getModel();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__toolbar`},{children:e.hasActions()&&this.renderActionsDropdownButton()}))}renderTableForms(){const e=this.getTableForms();return 1===e.length?this.renderForm(e[0]):(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__table-forms flex-max frame`},{children:(0,r.jsx)("div",Object.assign({className:"frame__container"},{children:(0,r.jsx)(n.db,{tabs:this.getFormTabs(e),classList:["Tab-blue","full"]})}))}))}renderOpenPageHeaderButton(){const e=this.getCtrl();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__open`,onClick:e.onOpenPageClick},{children:(0,r.jsx)(n.r$,{})}),"open")}renderClosePageHeaderButton(){const e=this.getCtrl();return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close`,onClick:e.onClosePageClick},{children:(0,r.jsx)(n.BX,{})}),"close")}renderHeader(){const e=this.getCtrl().getModel();return(0,r.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__header`},{children:[this.renderTitle(),e.isModal()&&[...e.getKey()?[this.renderOpenPageHeaderButton()]:[],this.renderClosePageHeaderButton()]]}))}renderMain(){return(0,r.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__main flex-max frame`},{children:(0,r.jsxs)("div",Object.assign({className:"frame__container flex-column grid-gap-10"},{children:[this.isToolbar()&&this.renderToolbar(),this.getCtrl().getModel().isFormInTab()?this.renderForms2():this.renderForms()]}))}))}renderForms(){const e=this.getCtrl().getModel();return[...e.hasRowForm()?[this.renderRowForms()]:[],...e.hasTableForm()?[this.renderTableForms()]:[]]}renderForms2(){return(0,r.jsx)(n.db,{tabs:this.getFormTabs(this.getCtrl().forms.filter((e=>e.isVisible()))),classList:["Tab-blue","full"]})}renderFooter(){const e=this.getCtrl().getModel();return(0,r.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__footer`},{children:[this.renderCloseButton(),e.isModal()&&e.hasRowFormWithDefaultSqlDataSource()&&this.renderSaveAndCloseButton(),e.isSelectMode()&&this.renderSelectButton()]}))}render(){return(0,l.fF)("PageView.render",this.getCtrl().getModel().getFullName()),(0,r.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} ${this.getCtrl().isModal()?"":"full"} flex-column`,style:this.getStyle(),ref:this.el,tabIndex:0,onKeyDown:this.getCtrl().onKeyDown},{children:[this.renderHeader(),this.renderMain(),this.getCtrl().isModal()&&this.renderFooter()]}))}getStyle(){if(this.getCtrl().isModal())return{width:1e3,height:750}}componentDidMount(){this.getCtrl().isAutoFocus()&&!this.getCtrl().getModel().getKey()||this.focus()}focus(){this.getElement()?this.getElement().focus():console.error(`${this.getCtrl().getModel().getFullName()}: el is null (ref={this.el})`)}}},805:(e,t,s)=>{s.d(t,{G:()=>View});var r=s(587);class View extends r.rN{constructor(e){if(super(e),!e.ctrl)throw new Error(`${this.constructor.name}: no ctrl`)}getCtrl(){return this.props.ctrl}}},982:(e,t,s)=>{s.d(t,{v:()=>EventEmitter});class EventEmitter{constructor(){this.list={}}on(e,t){this.list[e]||(this.list[e]=[]),this.list[e].push(t)}off(e,t){const s=this.list[e].indexOf(t);if(-1===s)throw new Error(`cannot find cb for ${e}`);this.list[e].splice(s,1)}async emit(e,t){if(this.list[e]&&this.list[e].length){const s=await Promise.allSettled(this.list[e].map((e=>e(t))));for(const e of s)if("rejected"===e.status)throw e.reason}}}},274:(e,t,s)=>{s.d(t,{M:()=>Application});var r=s(106),o=s(954),a=s(587),i=s(920);class Application extends r.H{constructor(e){super(e),this.databases=[],this.dataSources=[]}init(){if(!this.getData().theme)throw new Error("no theme attr");this.createDatabases(),this.createDataSources()}createDatabases(){for(const e of this.getData().databases){const t=new o.v(e,this);t.init(),this.addDatabase(t)}}deinit(){this.deinitDataSources(),super.deinit()}addDatabase(e){this.databases.push(e)}async logout(){await this.request("POST",{action:"logout"});this.emit("logout",{source:this})}async request(e,t){const s=Date.now(),[r,o]=await a.Qh.doHttpRequest2(e,window.location.pathname,t);if(!r["qforms-platform-version"])throw new Error("no qforms-platform-version header");return this.emit("request",{time:Date.now()-s,remotePlatformVersion:r["qforms-platform-version"],remoteAppVersion:r["qforms-app-version"]||null}),o}async request2(e,t,s){const r=Date.now(),[o,i]=await a.Qh.doHttpRequest2(e,t,s);if(!o["qforms-platform-version"])throw new Error("no qforms-platform-version header");return this.emit("request",{time:Date.now()-r,remotePlatformVersion:o["qforms-platform-version"],remoteAppVersion:o["qforms-app-version"]||null}),i}findDatabase(e){return this.databases.find((t=>t.getName()===e))}getDatabase(e){const t=this.findDatabase(e);if(!t)throw new Error(`no database: ${e}`);return t}getText(){return this.getData().text}getUser(){return this.getData().user}getDomain(){return this.getAttr("domain")}getVirtualPath(){return this.getData().virtualPath}async rpc(e,t){if(console.debug("Application.rpc",this.getFullName(),e,t),!e)throw new Error("no name");const s={action:"rpc",name:e,uuid:this.getAttr("uuid"),params:t},r=await this.request("POST",s);if(r.errorMessage)throw new Error(r.errorMessage);return r}emitResult(e,t){console.debug("Application.emitResult",e,t);const s=[];for(const r in e)s.push(...this.getDatabase(r).emitResult(e[r],t));return Promise.allSettled(s)}getNodeEnv(){return this.getData().nodeEnv}isDevelopment(){return"dev"===this.getNodeEnv()}getRoute(){return this.getAttr("route")}}i.W.registerGlobalClass(Application)},340:(e,t,s)=>{s.d(t,{s:()=>Column});var r=s(106),o=s(920);class Column extends r.H{constructor(e,t){if(super(e,t),!this.getAttr("type"))throw new Error(`column ${this.getFullName()}: no type`);if(!["string","number","boolean","object","date"].includes(this.getAttr("type")))throw new Error(`${this.getFullName()}: wrong column type: ${this.getAttr("type")}`)}init(){}getType(){return this.getAttr("type")}}o.W.registerGlobalClass(Column)},677:(e,t,s)=>{s.d(t,{o:()=>DataSource});var r=s(106),o=s(2),a=s(377),i=s(274),n=s(587),l=s(855),c=s(518),d=s(978);class DataSource extends r.H{constructor(e,t){super(e,t),this.rows=null,this.rowsByKey=null,this.news=[],this.changes=new Map,this.frame=1,this.count=null,this.lastFrame=1,this.onTableInsert=async e=>{if(this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableUpdate`);if(e.source!==this){if(console.debug("DataSource.onTableInsert",this.getFullName(),e),!e.inserts.length)throw new Error(`${this.getFullName()}: no inserts`);for(const t of e.inserts){if(this.getRow(t))throw console.debug("rows:",this.rows),console.debug("rowsByKey:",this.rowsByKey),new Error(`${this.getFullName()}: row already in this data source: ${t}`);const s=e.source.getRow(t),r={};DataSource.copyNewValues(r,s),this.addRow(r)}this.getParent()instanceof o.l&&this.getForm().onDataSourceInsert(e),this.emit("insert",e)}},this.onTableUpdate=async e=>{if(this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableUpdate`);if(e.source!==this){if(console.debug("DataSource.onTableUpdate",this.getFullName(),e),!Object.keys(e.updates).length)throw new Error(`${this.getFullName()}: no updates`);for(const t in e.updates)if(this.getRow(t)){const s=e.updates[t],r=e.source.getRow(s);this.updateRow(t,r)}this.getParent()instanceof o.l&&this.getForm().onDataSourceUpdate(e),this.emit("update",e)}},this.onTableDelete=async e=>{if(this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableDelete`);if(e.source!==this){if(console.debug("DataSource.onTableDelete",this.getFullName(),e),!e.deletes.length)throw new Error(`${this.getFullName()}: no deletes`);for(const t of e.deletes)this.getRow(t)&&this.removeRow(t);this.getParent()instanceof o.l&&this.getForm().onDataSourceDelete(e),this.emit("delete",e)}},this.onTableRefresh=async e=>{throw new Error("DataSource.onTableRefresh: not implemented")},void 0!==e.count&&(this.count=e.count)}init(){if(this.setRows(this.getData().rows),this.getAttr("table")){const e=this.getTable();e.on("insert",this.onTableInsert),e.on("update",this.onTableUpdate),e.on("delete",this.onTableDelete),e.on("refresh",this.onTableRefresh)}}deinit(){if(this.getAttr("table")){const e=this.getTable();e.off("insert",this.onTableInsert),e.off("update",this.onTableUpdate),e.off("delete",this.onTableDelete),e.off("refresh",this.onTableRefresh)}super.deinit()}setRows(e){this.rows=e,this.fillRowsByKey()}addRow(e){this.rows.push(e);const t=this.getRowKey(e);this.rowsByKey[t]=e}addRows(e){for(let t=0;t<e.length;t++)this.rows.push(e[t]);this.fillRowsByKey()}getRowsLength(){return this.rows.length}fillRowsByKey(){this.rowsByKey={};for(let e=0;e<this.rows.length;e++){const t=this.rows[e],s=this.getRowKey(t);this.rowsByKey[s]=t}}discardRowColumn(e,t){this.changes.has(e)&&void 0!==this.changes.get(e)[t]&&delete this.changes.get(e)[t]}changeRowColumn(e,t,s){this.changes.has(e)||this.changes.set(e,{}),this.changes.get(e)[t]=s}setValue(e,t,s){if(void 0===s)throw new Error(`${this.getFullName()}: undefined is wrong value for data source`);if("object"==typeof s&&null!==s)throw new Error(`setValue: ${this.getFullName()}.${t}: object must be in JSON format`);e[t]!==s?(this.changeRowColumn(e,t,s),void 0===e[t]&&null===s&&this.discardRowColumn(e,t)):this.discardRowColumn(e,t),this.changes.has(e)&&!Object.keys(this.changes.get(e)).length&&this.changes.delete(e)}isChanged(){return!!this.changes.size}hasNew(){return!!this.news.length}isRowColumnChanged(e,t){return e[t]!==this.getValue(e,t)}getValue(e,t){let s;if(s=this.changes.has(e)&&void 0!==this.changes.get(e)[t]?this.changes.get(e)[t]:e[t],void 0!==s&&"string"!=typeof s)throw new Error(`getValue: ${this.getFullName()}.${t}: object must be in JSON format, value: ${s}`);return s}getKeyValues(e){return this.getData().keyColumns.reduce(((t,s)=>(t[s]=JSON.parse(e[s]),t)),{})}getRowKey(e){const t=[];for(const s of this.getData().keyColumns){if(void 0===e[s])return null;if(null===e[s])throw new Error("wrong value null for data source value");try{const r=JSON.parse(e[s]);t.push(r)}catch(t){throw console.debug("getRowKey: cannot parse: ",e[s]),t}}return(0,l.DW)(t)}removeRow(e){const t=this.getRow(e);if(!t)throw new Error(`${this.getFullName()}: no row with key ${e} to remove`);const s=this.rows.indexOf(t);if(-1===s)throw new Error(`${this.getFullName()}: no row with i ${s} to remove`);this.rows.splice(s,1),delete this.rowsByKey[e]}newRow(e){if(console.debug("DataSource.newRow",this.getFullName(),e),this.rows.length>0)throw new Error("rows can be added to empty data sources only in new mode");this.news.push(e)}getSingleRow(e=!1){if(this.news[0])return this.news[0];const t=this.rows[0];if(!t)throw new Error("no single row");return e?this.getRowWithChanges(t):t}getForm(){return this.getParent()instanceof o.l?this.getParent():null}getPage(){return this.getParent()instanceof o.l?this.getParent().getParent():this.getParent()instanceof a.T?this.getParent():null}getApp(){if((0,d.fF)("DataSource.getApp",this.getFullName()),this.getParent()instanceof i.M)return this.getParent();if(this.getParent()instanceof a.T)return this.getParent().getParent();if(this.getParent()instanceof o.l)return this.getParent().getParent().getParent();if(this.getParent()instanceof c.g)return this.getParent().getParent().getParent().getParent();throw new Error(`unknown parent: ${this.getParent().constructor.name}(${this.getParent().getFullName()})`)}getRow(e){return this.rowsByKey[e]||null}getRows(){if(!this.rows)throw new Error("no rows");return this.rows}getRowByIndex(e){return this.rows[e]}discard(){if(console.debug("DataSource.discard",this.getFullName()),!this.isChanged())throw new Error(`no changes in data source ${this.getFullName()}`);this.changes.clear()}static keyToParams(e,t="key"){if("string"!=typeof e)throw new Error("key not string");const s={},r=JSON.parse(e);if(1===r.length)s[t]=r[0];else{if(!(r.length>1))throw new Error(`invalid key: ${e}`);for(let e=0;e<r.length;e++)s[`${t}${e+1}`]=r[e]}return s}getChangesByKey(){const e={};for(const t of this.changes.keys())e[this.getRowKey(t)]=this.changes.get(t);return e}getRowWithChanges(e){return this.changes.has(e)?Object.assign(Object.assign({},e),this.changes.get(e)):e}hasNewRows(){return this.news.length>0}static copyNewValues(e,t){for(const s in t)e[s]=t[s]}updateRow(e,t){if(console.debug("DataSource.updateRow",this.getFullName(),e,t),!e)throw new Error("no key");const s=this.getRow(e);if(!s)throw new Error(`${this.getFullName()}: no row with key ${e}`);const r=this.getRowKey(t);DataSource.copyNewValues(s,t),e!==r&&(delete this.rowsByKey[e],this.rowsByKey[r]=s)}getTable(){if(!this.getAttr("table"))throw new Error(`${this.getFullName()}: table attr empty`);return this.getDatabase().getTable(this.getAttr("table"))}getDatabase(){if(!this.getAttr("database"))throw new Error(`${this.getFullName()}: database attr empty`);return this.getApp().getDatabase(this.getAttr("database"))}getType(e){return this.getTable().getColumn(e).getType()}async insert(e){if(console.debug("DataSource.insert",this.news),!this.news.length)throw new Error("no new rows to insert");const t=[];for(const e of this.news){const s=this.getRowWithChanges(e);DataSource.copyNewValues(e,s);const r=this.getRowKey(e);if(!r)throw new Error("invalid insert row, no key");t.push(r)}this.changes.clear();for(const e of this.news)this.addRow(e);this.news=[],console.debug("rows:",this.getRows()),console.debug("inserts:",t),this.getParent()instanceof o.l&&this.getForm().onDataSourceInsert({source:this,inserts:t}),this.emit("insert",{source:this,inserts:t});const s=this.getAttr("database"),r=this.getAttr("table");if(s&&r){const e={[s]:{[r]:{insert:t}}};return await this.getApp().emitResult(e,this),e}return null}async delete(e){if(console.debug("DataSource.delete",e),!e)throw new Error("no key");this.removeRow(e);const t=[e];this.getParent()instanceof o.l&&this.getForm().onDataSourceDelete({source:this,deletes:t}),this.emit("delete",{source:this,deletes:t});const s=this.getAttr("database"),r=this.getAttr("table");if(s&&r){const e={[s]:{[r]:{delete:t}}};return await this.getApp().emitResult(e,this),e}return null}async update(){if(console.debug("DataSource.update",this.getFullName()),this.news.length)return await this.insert(),null;if(!this.changes.size)throw new Error(`no changes: ${this.getFullName()}`);const e=this.getChangesByKey(),t={};for(const s in e){const e=this.getRow(s),r=this.getRowWithChanges(e),o=this.getRowKey(r);this.updateRow(s,r),t[s]=o}this.changes.clear(),this.getParent()instanceof o.l&&this.getForm().onDataSourceUpdate({source:this,updates:t}),this.emit("update",{source:this,updates:t});const s=this.getAttr("database"),r=this.getAttr("table");if(s&&r){const e={[s]:{[r]:{update:t}}};return await this.getApp().emitResult(e,this),e}return null}isSurrogate(){return this.isAttr("database")}moveRow(e,t){console.debug("DataSource.moveRow"),n.Wt.moveArrItem(this.rows,e,t);const s={source:this};this.getParent()instanceof o.l&&this.getForm().onDataSourceRefresh(s),this.emit("refresh",s)}getLimit(){return this.getAttr("limit")?parseInt(this.getAttr("limit")):null}getCount(){if(null===this.count)throw new Error(`${this.getFullName()}: no count info`);return this.count}getFrame(){return this.frame}getLastFrame(){return this.lastFrame}setFrame(e){this.frame=e}getFramesCount(){if(null===this.count)throw new Error(`${this.getFullName()}: no count info`);return 0===this.count?1:this.getLimit()?Math.ceil(this.count/this.getLimit()):1}hasMore(){return this.lastFrame<this.getFramesCount()}isPersistent(){return!1}async refresh(){throw new Error("DataSource.refresh not implemented")}}n.Wt.registerGlobalClass(DataSource)},954:(e,t,s)=>{s.d(t,{v:()=>Database});var r=s(106),o=s(166),a=s(920);class Database extends r.H{constructor(){super(...arguments),this.tables=[]}init(){for(const e of this.getData().tables){const t=new o.i(e,this);t.init(),this.addTable(t)}}addTable(e){this.tables.push(e)}findTable(e){return this.tables.find((t=>t.getName()===e))}getTable(e){const t=this.findTable(e);if(!t)throw new Error(`${this.getFullName()}: no table with name: ${e}`);return t}emitResult(e,t=null){console.debug("Database.emitResult");const s=[];for(const r in e)s.push(...this.getTable(r).emitResult(e[r],t));return s}}a.W.registerGlobalClass(Database)},518:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{__webpack_require__.d(__webpack_exports__,{g:()=>Field});var _Model__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(106),_common__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(587),_Form_RowForm_RowForm__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(169);class Field extends _Model__WEBPACK_IMPORTED_MODULE_0__.H{init(){}replaceThis(e){return e.replace(/\{([@\w\.]+)\}/g,((e,t)=>{if(-1===t.indexOf("."))return e;let s=t.split(".");return"this"===s[0]&&(s[0]=this.getPage().getName()),`{${s.join(".")}}`}))}fillDefaultValue(row){const column=this.getAttr("column");if(!column)return;const defaultValue=this.replaceThis(this.getAttr("defaultValue")),js=_common__WEBPACK_IMPORTED_MODULE_1__.Wt.templateToJsString(defaultValue,this.getPage().getParams());if("string"!=typeof js)throw new Error(`${this.getFullName()}: defaultValue must be templated to js string`);try{const value=eval(js);void 0!==value&&(row[column]=this.valueToRaw(value))}catch(e){throw new Error(`[${this.getFullName()}] fillDefaultValue: ${e.toString()}`)}}valueToPageParams(e){if(this.isParam()){const t=this.getValue(e),s=this.valueToRaw(t),r=void 0!==s?_common__WEBPACK_IMPORTED_MODULE_1__.Wt.decodeValue(s):void 0;this.getPage().setParam(this.getFullName(),r)}}isChanged(e){if(!this.getAttr("column"))throw new Error(`${this.getFullName()}: field has no column`);return this.getDefaultDataSource().isRowColumnChanged(e,this.getAttr("column"))}hasColumn(){return!!this.getAttr("column")}getValue(row){if(!row&&this.getParent()instanceof _Form_RowForm_RowForm__WEBPACK_IMPORTED_MODULE_2__.e&&(row=this.getForm().getRow()),!row)throw new Error(`${this.getFullName()}: need row`);let rawValue;if(this.getAttr("column"))rawValue=this.getRawValue(row);else{if(!this.getAttr("value"))throw new Error(`${this.getFullName()}: no column and no value in field`);{const js=this.getAttr("value");try{rawValue=eval(js)}catch(e){throw console.error(e),new Error(`${this.getFullName()}: value eval error: ${e.message}`)}}}if(void 0!==rawValue){if(null===rawValue)throw new Error(`[${this.getFullName()}]: null is wrong raw value`);try{return this.rawToValue(rawValue)}catch(e){throw console.debug("raw value decode error:",this.getFullName(),rawValue),e}}}setValue(e,t){if(!this.getAttr("column"))throw new Error(`field has no column: ${this.getFullName()}`);const s=this.valueToRaw(t);this.getForm().getDefaultDataSource().setValue(e,this.getAttr("column"),s),this.valueToPageParams(e)}rawToValue(e){return _common__WEBPACK_IMPORTED_MODULE_1__.Wt.decodeValue(e)}valueToRaw(e){return _common__WEBPACK_IMPORTED_MODULE_1__.Wt.encodeValue(e)}getRawValue(e){if(!this.hasColumn())throw new Error(`${this.getFullName()}: no column`);return this.getForm().getDefaultDataSource().getValue(e,this.getAttr("column"))}getDefaultDataSource(){return this.getForm().getDefaultDataSource()}getType(){if(this.getAttr("type"))return this.getAttr("type");if(this.getAttr("column")){const e=this.getDefaultDataSource();if(e.isSurrogate())return e.getType(this.getAttr("column"));throw new Error("field type empty")}throw new Error("field type and column empty")}getForm(){return this.getParent()}getPage(){return this.getForm().getPage()}getApp(){return this.getForm().getApp()}isReadOnly(){return"true"===this.getData().readOnly}isNotNull(){return"true"===this.getData().notNull}isNullable(){return"false"===this.getData().notNull}getWidth(){const e=parseInt(this.getData().width);return isNaN(e)?null:0===e?100:e}getFullName(){return`${this.getPage().getName()}.${this.getForm().getName()}.${this.getName()}`}isParam(){return"true"===this.getData().param}validateOnChange(){return void 0===this.getData().validateOnChange||"true"===this.getData().validateOnChange}validateOnBlur(){return void 0!==this.getData().validateOnBlur&&"true"===this.getData().validateOnBlur}getCaption(){const e=this.getAttr("caption");if(""===e){const e=this.getAttr("column");if(e&&this.getForm().hasDefaultPersistentDataSource()){const t=this.getForm().getDataSource("default");if(t.getAttr("table")){return t.getTable().getColumn(e).getCaption()}}}return e}}},2:(e,t,s)=>{s.d(t,{l:()=>Form});var r=s(106),o=s(587);class Form extends r.H{constructor(){super(...arguments),this.dataSources=[],this.fields=[]}init(){this.createDataSources();for(const e of this.getData().fields){const t=o.Wt.getGlobalClass(e.class);if(!t)throw new Error(`no ${e.class} class`);const s=new t(e,this);s.init(),this.fields.push(s)}}deinit(){this.deinitDataSources();for(const e of this.fields)e.deinit();super.deinit()}fillDefaultValues(e){for(const t of this.fields)t.fillDefaultValue(e)}onDataSourceRefresh(e){this.emit("refresh",e)}onDataSourceInsert(e){this.getPage().onFormInsert(e),this.emit("insert",e)}onDataSourceUpdate(e){this.emit("update",e)}onDataSourceDelete(e){this.emit("delete",e)}async update(){if(console.debug("Form.update",this.getFullName(),this.isChanged()),this.getPage().deinited)throw new Error("page already deinited");if(!this.isChanged()&&!this.getDefaultDataSource().hasNewRows())throw new Error(`form model not changed or does not have new rows: ${this.getFullName()}`);await this.getDefaultDataSource().update()}isChanged(){return this.getDefaultDataSource().isChanged()}hasNew(){return this.getDefaultDataSource().hasNew()}async rpc(e,t){if(console.debug("Form.rpc",this.getFullName(),e,t),!e)throw new Error("no name");const s={action:"rpc",uuid:this.getApp().getAttr("uuid"),name:e,page:this.getPage().getName(),form:this.getName(),params:t},r=await this.getApp().request("POST",s);if(r.errorMessage)throw new Error(r.errorMessage);return r}getKey(){return null}getDefaultDataSource(){const e=this.getDataSource("default");if(!e)throw new Error(`${this.getFullName()}: no default data source`);return e}getPage(){return this.getParent()}getApp(){return this.getPage().getApp()}async refresh(){await this.getDefaultDataSource().refresh()}findField(e){return this.fields.find((t=>t.getName()===e))}getField(e){const t=this.findField(e);if(!t)throw new Error(`${this.getFullName()}: no field ${e}`);return t}hasDefaultPersistentDataSource(){return this.getDefaultDataSource().isPersistent()}decodeRow(e){const t={};for(const s of this.fields){const r=s.getAttr("column");r&&(t[r]=s.getValue(e))}return t}}},169:(e,t,s)=>{s.d(t,{e:()=>RowForm});var r=s(2),o=s(920);class RowForm extends r.l{init(){super.init(),this.isNewMode()&&this.getDefaultDataSource().newRow(this.createRow()),this.fillParams(this.getRow())}isNewMode(){const e=this.getAttr("newMode");return"true"===e||"false"!==e&&this.getPage().isNewMode()}fillParams(e){for(const t of this.fields)t.valueToPageParams(e)}onDataSourceUpdate(e){this.fillParams(this.getRow()),super.onDataSourceUpdate(e)}onDataSourceInsert(e){this.fillParams(this.getRow()),super.onDataSourceInsert(e)}getRow(e=!1){return this.getDefaultDataSource().getSingleRow(e)}getKey(){const e=this.getDefaultDataSource();if(e.isPersistent()){const t=this.getRow();return e.getRowKey(t)}return null}createRow(){const e={};return this.fillDefaultValues(e),e}discard(e=[]){console.debug("RowForm.discard",e),this.getDefaultDataSource().isChanged()&&(this.getDefaultDataSource().discard(),e.forEach((e=>{this.getField(e).valueToPageParams(this.getRow())})))}}o.W.registerGlobalClass(RowForm)},106:(e,t,s)=>{s.d(t,{H:()=>Model});var r=s(982),o=s(920);class Model extends r.v{constructor(e,t){if(!e.name)throw new Error("name required for model");super(),this.data=e,this.parent=t,this.deinited=!1}init(){}deinit(){if(this.deinited)throw new Error(`${this.getFullName()}: model already deinited`);this.deinited=!0}static getAttr(e,t){return e[t]}static getCol(e,t){return e[t]}static getName(e){return Model.getAttr(e,"name")}static getClassName(e){return Model.getAttr(e,"class")}isAttr(e){return this.data.hasOwnProperty(e)}getAttr(e){return this.data[e]}getCol(e){return this.data[e]}getClassName(){return this.getAttr("class")}getName(){return this.getAttr("name")}getFullName(){return this.parent?`${this.parent.getFullName()}.${this.getName()}`:this.getName()}getCaption(){return this.getAttr("caption")}findDataSource(e){return this.dataSources.find((t=>t.getName()===e))}getDataSource(e){const t=this.findDataSource(e);if(!t)throw new Error(`${this.getFullName()}: no data source ${e}`);return t}createDataSources(){for(const e of this.data.dataSources)try{const t=o.W.getGlobalClass(e.class);if(!t)throw new Error(`no ${e.class} class`);const s=new t(e,this);s.init(),this.dataSources.push(s)}catch(t){throw t.message=`${this.getFullName()}.${e.name}: ${t.message}`,t}}deinitDataSources(){for(const e of this.dataSources)e.deinit()}hasActions(){return this.data.actions.length>0}getParent(){if(!this.parent)throw new Error("np parent");return this.parent}getData(){return this.data}}},377:(e,t,s)=>{s.d(t,{T:()=>Page});var r=s(106),o=s(677),a=s(920),i=s(169),n=s(978);class Page extends r.H{constructor(e,t,s){super(e,t),this.options=s,this.dataSources=[],this.forms=[],this.params={},s.onCreate&&s.onCreate(this)}init(){this.createDataSources(),this.createForms(),(0,n.fF)("page options:",this.options),(0,n.fF)("page params:",this.getParams())}deinit(){if(this.deinited)throw new Error(`page ${this.getFullName()} is already deinited`);this.deinitDataSources(),this.deinitForms(),super.deinit()}getOptions(){return this.options}createForms(){for(const e of this.getData().forms){const t=a.W.getGlobalClass(r.H.getClassName(e));if(!t)throw new Error(`no ${r.H.getClassName(e)} class`);const s=new t(e,this);s.init(),this.forms.push(s)}}deinitForms(){for(const e of this.forms)e.deinit()}getParams(){return Object.assign(Object.assign({},this.options.params||{}),this.params)}setParam(e,t){this.params[e]=void 0!==t?t:null}async update(){(0,n.fF)("Page.update",this.getFullName());for(const e of this.forms)(e.isChanged()||e.hasNew())&&await e.update()}discard(){(0,n.fF)("Page.discard",this.getFullName());for(const e of this.forms)e instanceof i.e&&e.discard()}getKey(){for(const e of this.forms)if("RowForm"===e.getClassName())return e.getKey();return null}hasRowFormWithDefaultDs(){for(const e of this.forms)if("RowForm"===e.getClassName()&&e.getDefaultDataSource())return!0;return!1}hasRowFormWithDefaultSqlDataSource(){for(const e of this.forms)if("RowForm"===e.getClassName()&&e.hasDefaultPersistentDataSource())return!0;return!1}hasRowForm(){for(const e of this.forms)if("RowForm"===e.getClassName()&&"true"===e.getAttr("visible"))return!0;return!1}hasTableForm(){for(const e of this.forms)if("TableForm"===e.getClassName()&&"true"===e.getAttr("visible"))return!0;return!1}isNewMode(){return!!this.options.newMode}hasNew(){for(const e of this.forms)if(e.hasNew())return!0;return!1}getApp(){return this.getParent()}isModal(){return!!this.options.modal}onFormInsert(e){(0,n.fF)("Page.onFormInsert",e);for(const t of e.inserts){const e=o.o.keyToParams(t);for(const t in e)this.setParam(t,e[t])}}async rpc(e,t){if(!e)throw new Error("no name");const s={action:"rpc",uuid:this.getApp().getAttr("uuid"),name:e,page:this.getName(),params:t},r=await this.getApp().request("POST",s);if(r.errorMessage)throw new Error(r.errorMessage);return r}findForm(e){return this.forms.find((t=>t.getName()===e))}getForm(e){const t=this.findForm(e);if(!t)throw new Error(`${this.getFullName()}: no form ${e}`);return t}isSelectMode(){return!!this.options.selectMode}isFormInTab(){return this.isAttr("formInTab")&&"true"===this.getAttr("formInTab")}}a.W.registerGlobalClass(Page)},166:(e,t,s)=>{s.d(t,{i:()=>Table});var r=s(106),o=s(340),a=s(920);class Table extends r.H{constructor(){super(...arguments),this.columns=[]}init(){for(const e of this.getData().columns){const t=new o.s(e,this);t.init(),this.addColumn(t)}}addColumn(e){this.columns.push(e)}getColumn(e){const t=this.columns.find((t=>t.getName()===e));if(!t)throw new Error(`table ${this.getFullName()}: no column ${e}`);return t}emitResult(e,t=null){return console.debug("Table.emitResult"),[...e.insert?[this.emitInsert(t,e.insert)]:[],...e.update?[this.emitUpdate(t,e.update)]:[],...e.delete?[this.emitDelete(t,e.delete)]:[],...e.refresh?[this.emitRefresh(t)]:[]]}emitInsert(e,t){return this.emit("insert",{source:e,inserts:t})}emitUpdate(e,t){return this.emit("update",{source:e,updates:t})}emitDelete(e,t){return this.emit("delete",{source:e,deletes:t})}emitRefresh(e){return this.emit("refresh",{source:e})}}a.W.registerGlobalClass(Table)},834:(e,t,s)=>{s.d(t,{_l:()=>u._,SR:()=>E.S,J7:()=>CheckBoxField,Hc:()=>CheckBoxListField,sg:()=>F.s,XQ:()=>ComboBoxField,o2:()=>g.o,vo:()=>b.v,Nn:()=>DateField,ln:()=>DateTimeField,j9:()=>FileField,l0:()=>p.l,Ai:()=>LinkField,Kq:()=>LoginController,Sr:()=>LoginFrontHostApp,qg:()=>LoginView,IP:()=>NoSqlDataSource,T3:()=>m.T,vv:()=>A.v,B4:()=>v.B,ZI:()=>PasswordField,Md:()=>PersistentDataSource,$S:()=>PhoneField,gu:()=>RadioField,e9:()=>w.e,Vn:()=>RowFormCheckBoxFieldController,vB:()=>RowFormCheckBoxListFieldController,Eh:()=>RowFormCheckBoxListFieldView,ji:()=>RowFormComboBoxFieldController,MR:()=>RowFormComboBoxFieldView,iq:()=>D.i,Qx:()=>RowFormDateFieldController,dc:()=>RowFormDateFieldView,lG:()=>RowFormDateTimeFieldController,I9:()=>RowFormDateTimeFieldView,Ey:()=>RowFormFieldController,Qk:()=>RowFormFieldView,GW:()=>RowFormFileFieldController,vg:()=>RowFormLinkFieldController,Ay:()=>RowFormPasswordFieldController,k6:()=>RowFormPhoneFieldController,mn:()=>RowFormPhoneFieldView,v2:()=>RowFormRadioFieldController,L_:()=>RowFormTextAreaFieldController,xd:()=>RowFormTextAreaFieldView,K5:()=>RowFormTextBoxFieldController,Vu:()=>RowFormTextBoxFieldView,Yn:()=>RowFormTimeFieldController,o0:()=>x.o,B:()=>SqlDataSource,iA:()=>y.i,R8:()=>TableForm,j5:()=>TableFormCheckBoxFieldController,Lh:()=>TableFormCheckBoxFieldView,QN:()=>TableFormComboBoxFieldController,uZ:()=>TableFormComboBoxFieldView,GZ:()=>TableFormController,JR:()=>TableFormDateFieldController,s6:()=>TableFormDateFieldView,LH:()=>TableFormDateTimeFieldController,OW:()=>TableFormDateTimeFieldView,tG:()=>TableFormLinkFieldController,iZ:()=>TableFormPhoneFieldController,YB:()=>TableFormTextBoxFieldController,W$:()=>TableFormTextBoxFieldView,vX:()=>TableFormView,N7:()=>TextAreaField,Nx:()=>TextBoxField,iJ:()=>ViewerFrontHostApp});var r=s(623),o=s(997),a=s(689),i=s.n(a),n=s(805),l=s(587);class LoginView extends n.G{constructor(e){super(e),this.onLoginFormSubmit=e=>{document.querySelector(".LoginView__button").disabled=!0},this.onChange=e=>{this.errMsgRef.current.innerHTML=""},this.errMsgRef=i().createRef()}renderLogo(){return null}renderTitle(){return this.getCtrl().getFrontHostApp().getData().title}render(){return(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__container`},{children:(0,o.jsxs)("form",Object.assign({className:`${this.getCssBlockName()}__form`,method:"post",onSubmit:this.onLoginFormSubmit},{children:[(0,o.jsx)("input",{type:"hidden",name:"tzOffset",value:JSON.stringify((new Date).getTimezoneOffset())}),(0,o.jsx)("input",{type:"hidden",name:"action",value:"login"}),(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__logo-title`},{children:[(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__logo`},{children:this.renderLogo()})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__title`},{children:this.renderTitle()}))]})),(0,o.jsx)(l.zC,{classList:[`${this.getCssBlockName()}__field`],name:"username",placeholder:this.getCtrl().getText().login.username,required:!0,autoFocus:!0,spellCheck:!1,value:this.getCtrl().getFrontHostApp().getData().username||"",onChange:this.onChange}),(0,o.jsx)(l.ro,{classList:[`${this.getCssBlockName()}__field2`],name:"password",placeholder:this.getCtrl().getText().login.password,value:this.getCtrl().getFrontHostApp().getData().password||"",onChange:this.onChange}),(0,o.jsx)("p",Object.assign({className:`${this.getCssBlockName()}__err-msg`,ref:this.errMsgRef},{children:this.getCtrl().getFrontHostApp().getData().errMsg})),(0,o.jsx)("button",Object.assign({className:`${this.getCssBlockName()}__button`,type:"submit"},{children:this.getCtrl().getText().login.signIn}))]}))}))}}class LoginController extends r.Q{constructor(e){super(),console.debug(`${this.constructor.name}.constructor`),this.frontHostApp=e}static create(e){const t=e.getData();if(!t.name)throw new Error("no app name");return new(l.Wt.getGlobalClass(`${t.name}LoginController`)||LoginController)(e)}getViewClass(){return LoginView}getText(){return this.frontHostApp.getText()}getFrontHostApp(){return this.frontHostApp}getViewClassCssBlockName(){return this.getViewClass().name}}class LoginFrontHostApp extends l.Qh{constructor(e){console.debug("LoginFrontHostApp.constructor",e),super(),this.data=e}async run(){console.debug("LoginFrontHostApp.run");const e=LoginController.create(this),t=document.querySelector(`.${e.getViewClassCssBlockName()}__root`);if(!t)throw new Error("no root element");l.Wt.createReactComponent(t,e.getViewClass(),{ctrl:e})}getText(){return this.data.text}getData(){return this.data}}l.Wt.registerGlobalClass(LoginFrontHostApp);var c=s(405),d=s.n(c),h=s(274),u=s(367);class AlertView extends n.G{constructor(e){super(e),this.el=i().createRef()}getHeaderStyle(){return this.getCtrl().options.titleStyle}render(){return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames(),ref:this.el,tabIndex:0,onKeyDown:this.getCtrl().onKeyDown},{children:(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__container`},{children:(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__content flex-column`},{children:[(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__header`},{children:[(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__title`,style:this.getHeaderStyle()},{children:this.getCtrl().options.title||"Alert"})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close`,onClick:this.getCtrl().onCloseClick},{children:(0,o.jsx)(l.BX,{})}))]})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__main flex-max`},{children:this.getCtrl().options.message})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__footer`},{children:(0,o.jsx)(l.zx,{classList:[`${this.getCssBlockName()}__ok-button`],title:"OK",onClick:this.getCtrl().onOkButtonClick})}))]}))}))}))}componentDidMount(){this.getElement().focus()}}class AlertController extends r.Q{constructor(e){if(super(),this.onOkButtonClick=async e=>{this.close()},this.onCloseClick=async e=>{this.close()},this.onKeyDown=async e=>{"Escape"===e.key&&this.close()},this.options=e,!e.message)throw new Error("no message");if(!e.onClose)throw new Error("no onClose")}getViewClass(){return AlertView}close(){this.options.onClose()}}class ConfirmView extends n.G{constructor(e){super(e),this.el=i().createRef()}render(){if(!this.getCtrl().options.yesButton)throw new Error("no yesButton option");if(!this.getCtrl().options.noButton)throw new Error("no noButton option");return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames(),ref:this.el,tabIndex:0,onKeyDown:this.getCtrl().onKeyDown},{children:(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__container`},{children:(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__content flex-column`},{children:[(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__header`},{children:[(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__title`,style:this.getCtrl().options.titleStyle},{children:this.getCtrl().options.title||"Confirm"})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close`,onClick:this.getCtrl().onCloseClick},{children:(0,o.jsx)(l.BX,{})}))]})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__main flex-max`},{children:this.getCtrl().options.message})),(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__footer`},{children:[(0,o.jsx)(l.zx,{classList:[`${this.getCssBlockName()}__no-button`],title:this.getCtrl().options.noButton,onClick:this.getCtrl().onCloseClick}),(0,o.jsx)(l.zx,{classList:[`${this.getCssBlockName()}__yes-button`],title:this.getCtrl().options.yesButton,onClick:this.getCtrl().onYesClick})]}))]}))}))}))}componentDidMount(){this.getElement().focus()}}class ConfirmController extends r.Q{constructor(e){if(super(),this.onYesClick=e=>{this.close(!0)},this.onCloseClick=e=>{this.close(!1)},this.onKeyDown=async e=>{"Escape"===e.key&&this.close(!1)},this.options=e,!e.message)throw new Error("no message");if(!e.onClose)throw new Error("no onClose")}getViewClass(){return ConfirmView}close(e){this.options.onClose(e)}}class ViewerFrontHostApp extends l.Qh{constructor(e){if(!e.data)throw new Error("ViewerFrontHostApp: no data");super(e),this.options=e,this.applicationController=null}async run(){console.debug("ViewerFrontHostApp.run",this.getData());const e=new h.M(this.getData());e.init();const t=this.applicationController=u._.create(e,this);t.init();const s=`.${t.getViewClass().name}__root`,r=document.querySelector(s);if(!r)throw new Error(`no root element: ${s}`);t.createView(r);try{await t.connect()}catch(e){this.logError(e)}}async onWindowPopState(e){await this.applicationController.onWindowPopState(e)}logError(e){console.error("FrontHostApp.logError",e);const t={type:"error",source:"client",message:e.message,stack:e.stack,data:JSON.stringify({href:window.location.href,platformVersion:this.getData().versions.platform,appVersion:this.getData().versions.app},null,4)};console.debug(`POST ${this.getData().logErrorUrl}`,t),fetch(this.getData().logErrorUrl,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(t)}).catch((e=>{console.error(e.message)}))}getData(){if(!this.options.data)throw new Error("no data");return this.options.data}alert(e){return console.debug("ViewerFrontHostApp.alert",e),new Promise(((t,s)=>{try{const r=document.querySelector(".alert-root");if(!r)throw new Error("no .alert-root");if(0===r.childElementCount){const s=this.alertCtrl=new AlertController(Object.assign(Object.assign({},e),{onClose:()=>{this.alertCtrl=null,d().unmountComponentAtNode(r),t()}}));l.Wt.createReactComponent(r,s.getViewClass(),{ctrl:s,key:0})}else s(new Error("alert already exists"))}catch(e){s(e)}}))}confirm(e){return console.debug("ViewerFrontHostApp.confirm",e),new Promise(((t,s)=>{try{const r=document.querySelector(".alert-root");if(!r)throw new Error("no .alert-root");if(0===r.childElementCount){const s=this.alertCtrl=new ConfirmController(Object.assign(Object.assign({},e),{onClose:e=>{this.alertCtrl=null,d().unmountComponentAtNode(r),t(e)}}));l.Wt.createReactComponent(r,s.getViewClass(),{ctrl:s})}else s(new Error("confirm already exists"))}catch(e){s(e)}}))}}l.Wt.registerGlobalClass(ViewerFrontHostApp);var g=s(677),m=s(377),p=s(2),w=s(169),f=s(920);class TableForm extends p.l{}f.W.registerGlobalClass(TableForm);var C=s(518);class DateField extends C.g{getFormat(){return this.getAttr("format")}rawToValue(e){const t=l.Wt.decodeValue(e);return t&&"false"===this.getAttr("timezone")&&l.Wt.addTimezoneOffset(t),t}valueToRaw(e){let t;if(e&&"false"===this.getAttr("timezone")){const s=l.Wt.cloneDate(e);l.Wt.removeTimezoneOffset(s),t=l.Wt.encodeValue(s)}else t=l.Wt.encodeValue(e);return t}}l.Wt.registerGlobalClass(DateField);class ComboBoxField extends C.g{getDisplayValue(e){let t=null;if(e[this.getData().displayColumn])try{t=l.Wt.decodeValue(e[this.getData().displayColumn])}catch(t){throw console.debug("cannot parse:",e[this.getData().displayColumn]),t}else t=this.getData().displayColumn,t=t.replace(/\{([\w\.]+)\}/g,((t,s)=>e.hasOwnProperty(s)?e[s]||"":t));return t}getValueValue(e){if(!e[this.getData().valueColumn])throw new Error("no valueColumn in ComboBox data source");return l.Wt.decodeValue(e[this.getData().valueColumn])}getComboBoxDataSource(){const e=this.getData().dataSourceName;if(!e)throw new Error(`${this.getFullName()}: no dataSourceName`);if(this.getForm().findDataSource(e))return this.getForm().getDataSource(e);if(this.getPage().findDataSource(e))return this.getPage().getDataSource(e);if(this.getApp().findDataSource(e))return this.getApp().getDataSource(e);throw new Error(`${this.getFullName()}: no data source: ${e}`)}findRowByRawValue(e){return this.getComboBoxDataSource().getRows().find((t=>t[this.getData().valueColumn]===e))}}l.Wt.registerGlobalClass(ComboBoxField);class TextBoxField extends C.g{}f.W.registerGlobalClass(TextBoxField);class PersistentDataSource extends g.o{constructor(){super(...arguments),this.onTableUpdate=async e=>{if(console.debug("PersistentDataSource.onTableUpdate",this.getFullName(),e),this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableUpdate`);if(e.source!==this){if(!Object.keys(e.updates).length)throw new Error(`${this.getFullName()}: no updates`);await this.refill(),this.getParent()instanceof p.l&&this.getForm().onDataSourceUpdate(e),this.emit("update",e)}},this.onTableInsert=async e=>{if(console.debug("PersistentDataSource.onTableInsert",this.getFullName(),e),this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableInsert`);e.source!==this&&(await this.refill(),this.getParent()instanceof p.l&&this.getForm().onDataSourceInsert(e),this.emit("insert",e))},this.onTableDelete=async e=>{if(console.debug("PersistentDataSource.onTableDelete",this.getFullName(),e),this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableDelete`);e.source!==this&&(await this.refill(),this.getParent()instanceof p.l&&this.getForm().onDataSourceDelete(e),this.emit("delete",e))},this.onTableRefresh=async e=>{if(console.debug("PersistentDataSource.onTableRefresh",this.getFullName(),e),this.deinited)throw new Error(`${this.getFullName()}: this data source deinited for onTableDelete`);if(e.source)throw new Error("refresh is foreign result so source must be null");await this.refill(),this.getParent()instanceof p.l&&this.getForm().onDataSourceRefresh(e),this.emit("refresh",e)}}async insert(e){console.debug("PersistentDataSource.insert",e);const t=this.getAttr("database"),s=this.getAttr("table");if(""===s)throw new Error("no data source table to insert");const r={action:"insert",uuid:this.getApp().getAttr("uuid"),page:this.getForm().getPage().getName(),form:this.getForm().getName(),row:this.getRowWithChanges(e)},o=await this.getApp().request("POST",r),[a]=Object.keys(o[t][s].insertEx);if(!a)throw new Error("no inserted row key");const i=o[t][s].insertEx[a];for(const t in i)e[t]=i[t];this.news.splice(this.news.indexOf(e),1),this.changes.clear(),this.addRow(e);const n={source:this,inserts:o[t][s].insert};return this.getParent()instanceof p.l&&this.getForm().onDataSourceInsert(n),this.emit("insert",n),await this.getApp().emitResult(o,this),o}async update(){console.debug("PersistentDataSource.update",this.getFullName());const e=this.getAttr("database"),t=this.getAttr("table");if(""===t)throw new Error("no data source table to update");if(this.news[0])return await this.insert(this.news[0]);if(!this.changes.size)throw new Error(`no changes: ${this.getFullName()}`);const s={action:"update",uuid:this.getApp().getAttr("uuid"),page:this.getForm().getPage().getName(),form:this.getForm().getName(),changes:this.getChangesByKey()},r=await this.getApp().request2("PATCH",window.location.pathname,s),[o]=Object.keys(r[e][t].updateEx);if(!o)throw new Error("no updated row");const a=r[e][t].updateEx[o];this.changes.clear(),this.updateRow(o,a);const i={source:this,updates:r[e][t].update};return this.getParent()instanceof p.l&&this.getForm().onDataSourceUpdate(i),this.emit("update",i),await this.getApp().emitResult(r,this),r}async delete(e){if(console.debug("PersistentDataSource.delete:",this.getFullName(),e),!e)throw new Error("no key");const t=this.getAttr("database"),s=this.getAttr("table");if(!s)throw new Error(`no table in data source: ${this.getFullName()}`);const r={action:"_delete",uuid:this.getApp().getAttr("uuid"),page:this.getForm().getPage().getName(),form:this.getForm().getName(),params:{key:e}},o=await this.getApp().request2("DELETE",window.location.pathname,r);await this.refill();const a={source:this,deletes:o[t][s].delete};return this.getParent()instanceof p.l&&this.getForm().onDataSourceDelete(a),this.emit("delete",a),await this.getApp().emitResult(o,this),o}getPageParams(){const e=this.getPage();return e?e.getParams():{}}async refresh(){console.debug("PersistentDataSource.refresh",this.getFullName()),await this.refill(),this.getParent()instanceof p.l&&this.getForm().onDataSourceRefresh({source:this})}async refill(){if(console.debug("PersistentDataSource.refill",this.getFullName()),this.isChanged())throw new Error(`cannot refill changed data source: ${this.getFullName()}`);const e=await this.select(this.getLimit()?{frame:this.frame}:{});this.count=e.count,this.setRows(e.rows),this.lastFrame=1}async fill(e){if(this.isChanged())throw new Error(`cannot fill changed data source: ${this.getFullName()}`);const t=await this.select(this.getLimit()?{frame:e}:{});this.count=t.count,this.addRows(t.rows)}async more(){if(!this.hasMore())throw new Error(`${this.getFullName()}: no more rows`);this.lastFrame++,await this.fill(this.lastFrame)}async select(e={}){console.debug("PersistentDataSource.select",this.getFullName(),e);const t=this.getPage(),s=this.getForm(),r={action:"select",page:t?t.getName():void 0,form:s?s.getName():void 0,ds:this.getName(),params:l.Wt.encodeObject(Object.assign(Object.assign({},this.getPageParams()),e))},o=await this.getApp().request2("GET",`${window.location.pathname}?${l.Wt.queryToString(r)}`);if(!(o.rows instanceof Array))throw new Error("rows must be array");return o}isPersistent(){return!0}}class SqlDataSource extends PersistentDataSource{}f.W.registerGlobalClass(SqlDataSource);class NoSqlDataSource extends PersistentDataSource{}f.W.registerGlobalClass(NoSqlDataSource);class TextAreaField extends C.g{getRows(){return this.getData().rows}getCols(){return this.getData().cols}}l.Wt.registerGlobalClass(TextAreaField);class PasswordField extends C.g{}l.Wt.registerGlobalClass(PasswordField);class DateTimeField extends C.g{getFormat(){return this.getAttr("format")}rawToValue(e){const t=l.Wt.decodeValue(e);return t&&"false"===this.getAttr("timezone")&&l.Wt.addTimezoneOffset(t),t}valueToRaw(e){let t;if(e&&"false"===this.getAttr("timezone")){const s=l.Wt.cloneDate(e);l.Wt.removeTimezoneOffset(s),t=l.Wt.encodeValue(s)}else t=l.Wt.encodeValue(e);return t}}l.Wt.registerGlobalClass(DateTimeField);class CheckBoxField extends C.g{}f.W.registerGlobalClass(CheckBoxField);class RadioField extends C.g{getDisplayValue(e){const t=this.getAttr("displayColumn");let s=null;if(e[t])try{s=l.Wt.decodeValue(e[t])}catch(s){throw console.debug("cannot parse:",e[t]),s}else s=t,s=s.replace(/\{([\w\.]+)\}/g,((t,s)=>e.hasOwnProperty(s)?e[s]||"":t));return s}getValueValue(e){const t=this.getAttr("valueColumn");if(!e[t])throw new Error("no valueColumn in ComboBox data source");return l.Wt.decodeValue(e[t])}getDataSource(){const e=this.getAttr("dataSourceName");if(!e)throw new Error(`${this.getFullName()}: no dataSourceName`);if(this.getForm().findDataSource(e))return this.getForm().getDataSource(e);if(this.getPage().findDataSource(e))return this.getPage().getDataSource(e);if(this.getApp().findDataSource(e))return this.getApp().getDataSource(e);throw new Error(`${this.getFullName()}: no data source: ${e}`)}findRowByRawValue(e){const t=this.getAttr("valueColumn");return this.getDataSource().getRows().find((s=>s[t]===e))}}l.Wt.registerGlobalClass(RadioField);class FileField extends C.g{}l.Wt.registerGlobalClass(FileField);class PhoneField extends C.g{}l.Wt.registerGlobalClass(PhoneField);class CheckBoxListField extends C.g{getDisplayValue(e){let t=null;if(e[this.getData().displayColumn])try{t=l.Wt.decodeValue(e[this.getData().displayColumn])}catch(t){throw console.debug("cannot parse:",e[this.getData().displayColumn]),t}else t=this.getData().displayColumn,t=t.replace(/\{([\w\.]+)\}/g,((t,s)=>e.hasOwnProperty(s)?e[s]||"":t));return t}getValueValue(e){if(!e[this.getData().valueColumn])throw new Error("no valueColumn in CheckBoxList data source");return l.Wt.decodeValue(e[this.getData().valueColumn])}getDataSource(){const e=this.getData().dataSourceName;if(!e)throw new Error(`${this.getFullName()}: no dataSourceName`);if(this.getForm().findDataSource(e))return this.getForm().getDataSource(e);if(this.getPage().findDataSource(e))return this.getPage().getDataSource(e);if(this.getApp().findDataSource(e))return this.getApp().getDataSource(e);throw new Error(`${this.getFullName()}: no data source: ${e}`)}findRowByRawValue(e){return this.getDataSource().getRows().find((t=>t[this.getData().valueColumn]===e))}}l.Wt.registerGlobalClass(CheckBoxListField);var b=s(954),y=s(166),F=s(340);class LinkField extends C.g{}l.Wt.registerGlobalClass(LinkField);var E=s(783),v=s(324),D=s(278),x=s(157),k=s(534);class TableFormFieldController extends k.Z{getValueForWidget(e){return this.valueToString(this.getModel().getValue(e))}getForm(){return this.getParent()}getAlign(){return null}}var P=s(190);class FieldView extends P.H{getStyle(e){return this.getCtrl().getViewStyle(e)}}class TableFormFieldView extends FieldView{constructor(e){super(e),this.span=i().createRef()}getSpanOffsetWidth(){return this.span.current?this.span.current.offsetWidth:0}}class TableFormTextBoxFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("span",Object.assign({ref:this.span},{children:t.getValueForWidget(e)}))}))}}l.Wt.registerGlobalClass(TableFormTextBoxFieldView);class TableFormTextBoxFieldController extends TableFormFieldController{getViewClass(){return super.getViewClass()||TableFormTextBoxFieldView}}l.Wt.registerGlobalClass(TableFormTextBoxFieldController);var A=s(409);class RowFormFieldController extends k.Z{constructor(e,t){super(e,t),this.state={value:null,parseError:null,error:null,changed:!1},this.onChange=async(e,t=!0)=>{console.debug("RowFormFieldController.onChange",JSON.stringify("string"==typeof e?e.substring(0,100):e)),this.resetErrors(),this.rerender();try{this.setValueFromWidget(e)}catch(e){console.error(`${this.getModel().getFullName()}: cannot parse view value: ${e.message}`),this.state.parseError=e.message}if(!this.state.parseError&&this.isValidateOnChange()&&(this.validate(),this.isValid()&&this.copyValueToModel()),this.refreshChangedState(),t){try{this.emit("change",{value:e})}catch(e){console.error("unhandled change event error:",this.getModel().getFullName(),e)}this.getParent().onFieldChange({source:this})}},this.onBlur=(e,t=!0)=>{if(console.debug("RowFormFieldController.onBlur",this.getModel().getFullName(),JSON.stringify(e)),this.isEditable()&&(this.rerender(),this.isValidateOnBlur())){try{this.setValueFromWidget(e)}catch(e){console.error(`${this.getModel().getFullName()}: cannot parse view value: ${e.message}`),this.state.parseError=e.message}if(!this.state.parseError&&this.isValidateOnBlur()&&(this.validate(),this.isValid()&&this.copyValueToModel()),this.refreshChangedState(),t){try{this.emit("change",{value:e})}catch(e){console.error("unhandled change event error:",this.getModel().getFullName(),e)}this.getParent().onFieldChange({source:this})}}},this.onChangePure=async(e,t=!0)=>{if(console.debug("RowFormFieldController.onChangePure",JSON.stringify(e)),this.setValue(e),this.resetErrors(),this.rerender(),this.isValidateOnChange()&&(this.validate(),this.isValid()&&this.copyValueToModel()),this.refreshChangedState(),t){try{this.emit("change",{value:e})}catch(e){console.error("unhandled change event error:",this.getModel().getFullName(),e)}this.getParent().onFieldChange({source:this})}}}init(){const e=this.getRow(),t=this.getModel().getValue(e);this.setValue(t)}refill(){if(!this.view)return;const e=this.getModel().getValue(this.getRow());this.setValue(e),this.resetErrors(),this.refreshChangedState()}getRow(){return this.getModel().getForm().getRow()}getForm(){return this.getParent()}copyValueToModel(){this.getModel().setValue(this.getRow(),this.getValue())}putValue(e){this.onChange(e,!1)}getValueForWidget(){const e=this.getValue();return this.valueToString(e)}setValueFromWidget(e){if("string"!=typeof e)throw new Error(`${this.getModel().getFullName()}: widgetValue must be string, but got ${typeof e}`);const t=this.stringToValue(e);this.setValue(t)}setValue(e){this.state.value=e}getValue(){return this.state.value}isChanged(){return this.state.changed}isValid(){return null===this.state.parseError&&null===this.state.error}validate(){this.isVisible()&&(this.state.error=this.getError())}refreshChangedState(){this.state.changed=this.calcChangedState(this.getRow())}getPlaceholder(){if(this.getModel().getAttr("placeholder"))return this.getModel().getAttr("placeholder");if(this.getApp().getHostApp().isDebugMode()){const e=this.getValue();if(void 0===e)return"undefined";if(null===e)return"null";if(""===e)return"empty string"}return null}getError(){if(this.view&&this.view.getWidget())try{this.view.getWidget().getValue()}catch(e){return`can't parse value: ${e.message}`}const e=this.getValue();return this.getModel().isNotNull()&&null==e?this.getNullErrorText():null}getNullErrorText(){return this.getModel().getApp().getText().form.required}isEditable(){return"edit"===this.getParent().getMode()&&!this.getModel().isReadOnly()}isParseError(){return null!==this.state.parseError}calcChangedState(e){if(!e)throw new Error("FieldController: no row");if(this.isParseError())return console.debug(`FIELD CHANGED ${this.getModel().getFullName()}: parse error: ${this.getErrorMessage()}`),!0;if(!this.isValid())return console.debug(`FIELD CHANGED ${this.getModel().getFullName()}: not valid: ${this.getErrorMessage()}`),!0;if(this.getModel().hasColumn()){const t=this.getModel().valueToRaw(this.getValue()),s=this.getModel().getRawValue(e);if(t!==s)return console.debug(`FIELD CHANGED ${this.getModel().getFullName()}`,JSON.stringify(s),JSON.stringify(t)),!0;if(this.getModel().isChanged(e)){let t=e[this.getModel().getAttr("column")],s=this.getModel().getDefaultDataSource().getRowWithChanges(e)[this.getModel().getAttr("column")];return t&&(t=t.substr(0,100)),s&&(s=s.substr(0,100)),console.debug(`MODEL CHANGED ${this.getModel().getFullName()}:`,t,s),!0}}return!1}setError(e){this.state.error=e}resetErrors(){this.setError(null),this.state.parseError=null}getErrorMessage(){return this.state.parseError?this.state.parseError:this.state.error}renderView(){return i().createElement(this.getViewClass(),{onCreate:this.onViewCreate,ctrl:this})}isValidateOnChange(){return this.getModel().validateOnChange()}isValidateOnBlur(){return this.getModel().validateOnBlur()}}class RowFormFieldView extends FieldView{constructor(e){super(e),this.onWidgetCreate=e=>{this.widget=e},this.widget=null}getWidget(){return this.widget}getClassList(){const e=this.getCtrl();return[...super.getClassList(),...e.isEditable()?["editable"]:[],...e.isChanged()?["changed"]:[],...null!==e.getErrorMessage()?["error"]:[]]}}class RowFormDateFieldView extends RowFormFieldView{render(){const e=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:(0,o.jsx)(l.Ol,{classList:[`${this.getCssBlockName()}__date-picker`],onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),onChange:e.onChange,placeholder:e.getPlaceholder(),format:e.getFormat(),oldDates:this.props.oldDates,minDate:this.props.minDate,debug:e.getApp().getHostApp().isDebugMode()})}))}}class RowFormDateFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormDateFieldView}getValueForWidget(){return this.getValue()}setValueFromWidget(e){this.setValue(e)}}f.W.registerGlobalClass(RowFormDateFieldController);class RowFormComboBoxFieldView extends RowFormFieldView{constructor(){super(...arguments),this.onChange=async e=>{this.rerender(),await this.getCtrl().onChange(e)}}isCreateButtonVisible(){return"edit"===this.getCtrl().getForm().getMode()&&("disabled"!==this.getCtrl().getModel().getAttr("newRowMode")&&("editPage"===this.getCtrl().getModel().getAttr("newRowMode")?!!this.getCtrl().getModel().getAttr("itemEditPage")&&!!this.getCtrl().getModel().getAttr("itemCreateForm"):"createPage"===this.getCtrl().getModel().getAttr("newRowMode")?!!this.getCtrl().getModel().getAttr("itemCreatePage")&&!!this.getCtrl().getModel().getAttr("itemCreateForm"):void 0))}renderSelect(){const e=this.getCtrl();return(0,o.jsx)(l.Ph,{classList:[`${this.getCssBlockName()}__select`],onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),onChange:this.onChange,items:e.getItems(),placeholder:e.getPlaceholder(),onMouseDown:e.getModel().getAttr("itemSelectPage")?e.onItemSelect:null})}renderEditButton(){const e=this.getCtrl();return(0,o.jsx)(l.zx,Object.assign({classList:[`${this.getCssBlockName()}__edit-button`],onClick:e.onEditButtonClick,enabled:!!e.getValue()},{children:"..."}))}renderCreateButton(){const e=this.getCtrl();return(0,o.jsx)(l.zx,Object.assign({classList:[`${this.getCssBlockName()}__create-button`],onClick:e.onCreateButtonClick},{children:"+"}))}render(){return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[this.renderSelect(),this.getCtrl().getModel().getAttr("itemEditPage")&&!!this.getCtrl().getValue()&&this.renderEditButton(),this.isCreateButtonVisible()&&this.renderCreateButton()]}))}}var N=s(855);class RowFormComboBoxFieldController extends RowFormFieldController{constructor(){super(...arguments),this.onEditButtonClick=async e=>{console.debug("RowFormComboBoxFieldController.onEditButtonClick");const t=this.getModel().getAttr("itemEditPage"),s=this.getValue();t&&s&&await this.openPage({name:t,params:{key:s}})},this.onCreateButtonClick=async e=>{console.debug("RowFormComboBoxFieldController.onCreateButtonClick");const t=this.getModel().getAttr("newRowMode"),s=this.getModel().getAttr("itemCreateForm");if(!s)throw new Error("no itemCreateForm");let r;if("editPage"===t)r=this.getModel().getAttr("itemEditPage");else{if("createPage"!==t)throw new Error(`wrong newRowMode value: ${t}`);r=this.getModel().getAttr("itemCreatePage")}const o=(await this.openPage({name:r,newMode:!0})).getModel().getForm(s),a=async e=>{o.off("insert",a);const[t]=e.inserts,[s]=f.W.decodeValue(t);await this.onChange(s.toString())};o.on("insert",a)},this.onListInsert=async e=>{console.debug("RowFormComboBoxFieldController.onListInsert"),await this.rerender()},this.onListUpdate=async e=>{await this.rerender()},this.onListDelete=async e=>{await this.rerender()},this.onItemSelect=async e=>{if(0===e.button){e.preventDefault();const t=this.getValue(),s=t?(0,N.DW)([t]):void 0;await this.openPage({name:this.getModel().getAttr("itemSelectPage"),selectMode:!0,selectedKey:s,onSelect:async e=>{if(e){const[t]=(0,N.mV)(e);this.getValue()!==t&&await this.getView().onChange(t.toString())}else null!==this.getValue()&&await this.getView().onChange("")}})}}}init(){super.init();const e=this.getModel().getComboBoxDataSource();e.on("insert",this.onListInsert),e.on("update",this.onListUpdate),e.on("delete",this.onListDelete)}deinit(){const e=this.getModel().getComboBoxDataSource();e.off("insert",this.onListInsert),e.off("update",this.onListUpdate),e.off("delete",this.onListDelete),super.deinit()}getViewClass(){return super.getViewClass()||RowFormComboBoxFieldView}getItems(){try{return this.getRows().map((e=>({value:this.valueToString(this.getModel().getValueValue(e)),title:this.getModel().getDisplayValue(e)})))}catch(e){throw e.message=`${this.getModel().getFullName()}: ${e.message}`,e}}getRows(){return this.getModel().getComboBoxDataSource().getRows()}getPlaceholder(){return this.getModel().getAttr("placeholder")?this.getModel().getAttr("placeholder"):this.getApp().getHostApp().isDebugMode()?"[null]":null}}f.W.registerGlobalClass(RowFormComboBoxFieldController);class RowFormTextBoxFieldView extends RowFormFieldView{constructor(e){super(e),this.onClear=async e=>{this.getCtrl().onChange(""),setTimeout((()=>{this.getWidget().getElement().focus()}),0)},this.onFocus=async e=>{this.addCssClass("focus"),await this.rerender()},this.onBlur=async e=>{const t=e.target.value;this.removeCssClass("focus"),this.getCtrl().onBlur(t)},this.state={classList:[]}}isCloseVisible(){const e=this.getCtrl();return!!e.isEditable()&&""!==e.getValueForWidget()}renderTextBox(){const e=this.getCtrl();return(0,o.jsx)(l.zC,{classList:[`${this.getCssBlockName()}__input`],value:e.getValueForWidget(),readOnly:!e.isEditable(),enabled:e.isEditable(),autoFocus:e.isAutoFocus(),placeholder:e.getPlaceholder()||null,autocomplete:e.getAutocomplete(),onCreate:this.onWidgetCreate,onChange:e.onChange,onFocus:this.onFocus,onBlur:this.onBlur})}renderCloseIcon(){return(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${this.isCloseVisible()?"visible":""}`,onMouseDown:this.onClear},{children:(0,o.jsx)(l.Tw,{})}))}render(){return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[this.renderTextBox(),this.renderCloseIcon()]}))}}class RowFormTextBoxFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormTextBoxFieldView}}f.W.registerGlobalClass(RowFormTextBoxFieldController);var _=s(423),j=s(87),S=s(978);class TableFormView extends j.m{constructor(){super(...arguments),this.renderGridCellView=(e,t,s,r)=>{const o=this.getCtrl().getField(t.name);if(!o)throw new Error(`no field: ${t.name}`);return i().createElement(o.getViewClass(),{row:e,column:t,onCreate:s,onUnmount:r,ctrl:o})},this.createLinkCallback=e=>this.getCtrl().getApp().getHostApp().createLink(Object.assign({page:this.getCtrl().getModel().getAttr("itemEditPage")},g.o.keyToParams(e)))}renderToolbar(){const e=this.getCtrl(),t=e.getModel(),s=t.getDefaultDataSource();return(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__toolbar flex grid-gap-5`},{children:["disabled"!==t.getData().newRowMode&&(0,o.jsx)(l.zx,Object.assign({classList:["toolbar-button","default"],onClick:e.onNewClick,enabled:!e.getParent().getModel().hasNew()},{children:(0,o.jsx)("div",{children:t.getApp().getText().form.new})}),"new"),"true"===t.getData().refreshButton&&s.isPersistent()&&(0,o.jsx)(l.zx,Object.assign({classList:["toolbar-button"],onClick:e.onRefreshClick,enabled:!e.getParent().getModel().hasNew()},{children:(0,o.jsx)("div",{children:t.getApp().getText().form.refresh})}),"refresh"),"disabled"!==t.getData().deleteRowMode&&(0,o.jsx)(l.zx,Object.assign({classList:["toolbar-button"],onClick:e.onDeleteClick,enabled:e.isRowSelected()},{children:(0,o.jsx)("div",{children:t.getApp().getText().form.delete})}),"delete"),e.getModel().hasActions()&&(0,o.jsx)(l.PS,Object.assign({classList:["toolbar-dropdown-button"],actions:this.getActionsForDropdownButton(),onClick:this.onActionsClick},{children:(0,o.jsx)(l.Yv,{})}))]}))}renderPaging(){const e=this.getCtrl(),t=this.getCtrl().getModel().getDefaultDataSource();return(0,o.jsxs)("div",Object.assign({className:"paging"},{children:[(0,o.jsx)("div",Object.assign({className:"paging__countBlock"},{children:(0,o.jsxs)("span",Object.assign({className:"count"},{children:[t.getRowsLength()," ",t.getLimit()&&`of ${f.W.formatNumber(t.getCount())}`]}))})),t.getLimit()&&(0,o.jsxs)("div",Object.assign({className:"paging__gotoBlock"},{children:[(0,o.jsx)(l.zx,Object.assign({enabled:e.canPrev(),onClick:e.onPreviousClick},{children:(0,o.jsx)(l.Ey,{size:18})})),(0,o.jsx)(l.zC,{value:e.getModel().getDefaultDataSource().getFrame().toString(),onChange:e.onFrameChanged}),(0,o.jsxs)("div",Object.assign({className:"paging__framesCount"},{children:[" ","/ ",f.W.formatNumber(t.getFramesCount())," "]})),(0,o.jsx)(l.zx,Object.assign({enabled:e.canNext(),onClick:e.onNextClick},{children:(0,o.jsx)(l.m9,{size:18})}))]}))]}))}getGridColumns(){const e=this.getCtrl();return Object.keys(e.fields).filter((t=>e.getField(t).isVisible())).map((t=>{const s=e.getField(t);return{name:s.getModel().getName(),title:s.getModel().getCaption(),width:s.getModel().getWidth(),align:s.getAlign()}}))}getRows(){return this.getCtrl().getModel().getDefaultDataSource().getRows()}getGridExtraColumn(){return!0}getGridClass(){return l.rj}renderGrid(){const e=this.getCtrl();return i().createElement(this.getGridClass(),{classList:["flex-max"],onCreate:e.onGridCreate,name:e.getModel().getFullName(),columns:this.getGridColumns(),rows:this.getRows(),getRowKey:t=>e.getModel().getDefaultDataSource().getRowKey(t),onDoubleClick:e.onGridCellDblClick,onDeleteKeyDown:e.onGridDeleteKeyDown,onSelectionChange:e.onGridSelectionChange,onLinkClick:e.onGridLinkClick,renderGridCellView:this.renderGridCellView,updated:e.getUpdated(),extraColumn:this.getGridExtraColumn(),selectedKey:e.getPage().getModel().getOptions().selectedKey,createLinkCallback:this.createLinkCallback})}render(){(0,S.fF)("TableFormView.render",this.getCtrl().getModel().getFullName());const e=this.getCtrl();return(0,o.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} full flex-column grid-gap-5`,style:this.getStyle()},{children:[this.renderToolbar(),this.renderGrid(),e.getModel().hasDefaultPersistentDataSource()&&this.renderPaging()]}))}}class TableFormController extends _.z{constructor(){super(...arguments),this.fields={},this.state={updated:Date.now()},this.grid=null,this.onGridCreate=e=>{this.grid=e},this.onNewClick=async e=>{console.debug("TableFormController.onNewClick"),await this.new()},this.onRefreshClick=async e=>{console.debug("TableFormController.onRefreshClick",this.getModel().getFullName()),await this.getModel().refresh()},this.onDeleteClick=async e=>{console.debug("TableFormController.onDeleteClick",this.getModel().getFullName(),this.grid.getActiveRowKey());await this.getApp().confirm({message:this.getModel().getApp().getText().form.areYouSure})&&await this.getModel().getDefaultDataSource().delete(this.grid.getActiveRowKey())},this.onGridCellDblClick=async(e,t)=>{if("form"===this.getModel().getAttr("editMethod"))this.getPage().getModel().isSelectMode()?await this.getPage().selectRow(t):await this.edit(t)},this.onGridLinkClick=async e=>{console.debug("TableFormController.onGridLinkClick",e),await this.edit(e)},this.onGridDeleteKeyDown=async(e,t)=>{if(console.debug("TableFormController.onGridDeleteKeyDown",e,t),"disabled"!==this.getModel().getAttr("deleteRowMode")){await this.getApp().confirm({message:this.getModel().getApp().getText().form.areYouSure})&&await this.getModel().getDefaultDataSource().delete(t)}},this.onModelRefresh=async e=>{console.debug("TableFormController.onModelRefresh",this.getModel().getFullName(),e),this.view&&(this.invalidate(),await this.rerender())},this.onModelInsert=async e=>{if(console.debug("TableFormController.onModelInsert",this.getModel().getFullName(),e),this.view){if(this.grid&&e.source)for(const t of e.inserts)this.grid.setActiveRowKey(t);this.invalidate(),await this.rerender()}},this.onModelUpdate=async e=>{if(console.debug("TableFormController.onModelUpdate",this.getModel().getFullName(),e,this.view),this.view){if(this.grid)for(const t in e.updates)if(this.grid.getActiveRowKey()===t){const s=e.updates[t];t!==s&&this.grid.setActiveRowKey(s)}this.invalidate(),await this.rerender()}},this.onModelDelete=async e=>{if(console.debug("TableFormController.onModelDelete",this.getModel().getFullName(),e),this.view){if(this.grid)for(const t of e.deletes)this.grid.getActiveRowKey()===t&&this.grid.setActiveRowKey(null);this.invalidate(),await this.rerender()}},this.onGridSelectionChange=async e=>{this.invalidate(),await this.getPage().rerender()},this.isRowSelected=()=>!!this.grid&&!!this.grid.getActiveRowKey(),this.onFrameChanged=async e=>{console.debug("TableFormController.onFrameChanged",e);let t=parseInt(e);console.debug("frame:",t);const s=this.getModel().getDefaultDataSource().getFramesCount();t<1&&(t=1),t>s&&(t=s),this.getModel().getDefaultDataSource().setFrame(t),this.getModel().getDefaultDataSource().refresh(),await this.rerender()},this.onNextClick=async()=>{console.debug("TableFormController.onNextClick");const e=this.getModel().getDefaultDataSource().getFrame()+1;this.getModel().getDefaultDataSource().setFrame(e),this.getModel().getDefaultDataSource().refresh(),await this.rerender()},this.onPreviousClick=async()=>{console.debug("TableFormController.onPreviousClick");const e=this.getModel().getDefaultDataSource().getFrame()-1;this.getModel().getDefaultDataSource().setFrame(e),this.getModel().getDefaultDataSource().refresh(),this.rerender()}}getViewClass(){return super.getViewClass()||TableFormView}init(){super.init(),this.getModel().on("refresh",this.onModelRefresh),this.getModel().on("update",this.onModelUpdate),this.getModel().on("delete",this.onModelDelete),this.getModel().on("insert",this.onModelInsert)}deinit(){this.getModel().off("refresh",this.onModelRefresh),this.getModel().off("update",this.onModelUpdate),this.getModel().off("delete",this.onModelDelete),this.getModel().off("insert",this.onModelInsert),super.deinit()}async new(){if("oneclick"===this.getModel().getAttr("newRowMode")){const e={};this.getModel().fillDefaultValues(e),await this.getModel().getDefaultDataSource().insert(e)}else if("editform"===this.getModel().getAttr("newRowMode")){if(!this.getModel().getAttr("itemEditPage"))throw new Error(`[${this.getModel().getFullName()}] itemEditPage is empty`);await this.openPage({name:this.getModel().getAttr("itemEditPage"),newMode:!0,modal:!0})}else if("createform"===this.getModel().getAttr("newRowMode")){if(!this.getModel().getAttr("itemCreatePage"))throw new Error(`[${this.getModel().getFullName()}] itemCreatePage is empty`);await this.openPage({name:this.getModel().getAttr("itemCreatePage"),newMode:!0,modal:!0})}else if("oneclick editform"===this.getModel().getAttr("newRowMode")){if(!this.getModel().getAttr("itemEditPage"))throw new Error(`[${this.getModel().getFullName()}] itemEditPage is empty`);const e={};this.getModel().fillDefaultValues(e);const t=await this.getModel().getDefaultDataSource().insert(e),s=this.getModel().getDefaultDataSource().getAttr("database"),r=this.getModel().getDefaultDataSource().getAttr("table"),[o]=t[s][r].insert;await this.openPage({name:this.getModel().getAttr("itemEditPage"),modal:!0,params:Object.assign({},g.o.keyToParams(o))})}else if("oneclick createform"===this.getModel().getAttr("newRowMode")){if(!this.getModel().getAttr("itemCreatePage"))throw new Error(`[${this.getModel().getFullName()}] itemCreatePage is empty`);const e={};this.getModel().fillDefaultValues(e);const t=await this.getModel().getDefaultDataSource().insert(e),s=this.getModel().getDefaultDataSource().getAttr("database"),r=this.getModel().getDefaultDataSource().getAttr("table"),[o]=t[s][r].insert;await this.openPage({name:this.getModel().getAttr("itemCreatePage"),modal:!0,params:Object.assign({},g.o.keyToParams(o))})}}async edit(e){if(!this.getModel().getAttr("itemEditPage"))throw new Error(`${this.getModel().getFullName()}: itemEditPage is empty`);try{await this.openPage({name:this.getModel().getAttr("itemEditPage"),modal:!0,params:Object.assign({},g.o.keyToParams(e))})}catch(e){throw e.message=`${this.getModel().getFullName()} edit: ${e.message}`,e}}getActiveRow(){const e=this.grid.getActiveRowKey();if(!e)throw new Error(`${this.getModel().getFullName()}: no active row key`);return this.getModel().getDefaultDataSource().getRow(e)}canPrev(){return this.getModel().getDefaultDataSource().getFrame()>1}canNext(){const e=this.getModel().getDefaultDataSource();return e.getFrame()<e.getFramesCount()}getSelectedRowKey(){return this.grid?this.grid.getActiveRowKey():null}isActionEnabled(e){return this.isRowSelected()}getField(e){return this.fields[e]}}l.Wt.registerGlobalClass(TableFormController);class TableFormDateFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("span",Object.assign({ref:this.span},{children:t.getValueForWidget(e)}))}))}}class TableFormDateFieldController extends TableFormFieldController{getViewClass(){return super.getViewClass()||TableFormDateFieldView}getValueForWidget(e){const t=this.getModel().getValue(e);return t?l.Wt.formatDate(t,this.getFormat()||"{DD}.{MM}.{YYYY} {hh}:{mm}:{ss}"):""}}l.Wt.registerGlobalClass(TableFormDateFieldController);class RowFormTextAreaFieldView extends RowFormFieldView{constructor(e){super(e),this.onFocus=async e=>{this.addCssClass("focus"),await this.rerender()},this.onBlur=async e=>{this.removeCssClass("focus"),await this.rerender()},this.state={classList:[]}}render(){const e=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:(0,o.jsx)(l.Kx,{classList:[`${this.getCssBlockName()}__textarea`],onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),disabled:!e.isEditable(),onChange:e.onChange,placeholder:e.getPlaceholder(),rows:e.getModel().getRows(),cols:e.getModel().getCols(),onFocus:this.onFocus,onBlur:this.onBlur})}))}}class RowFormTextAreaFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormTextAreaFieldView}}f.W.registerGlobalClass(RowFormTextAreaFieldController);class RowFormPasswordFieldView extends RowFormFieldView{constructor(e){super(e),this.onCloseClick=async e=>{const t=this.getCtrl();this.getWidget().state.value="",this.getWidget().setState({value:""}),t.onChange(""),this.getWidget().getElement().focus()},this.onFocus=async e=>{this.addCssClass("focus"),await this.rerender()},this.onBlur=async e=>{this.removeCssClass("focus"),await this.rerender()},this.onIconClick=e=>{this.setState((e=>({type:"password"===e.type?"text":"password"})))},this.state={classList:[],type:"password"}}isCloseVisible(){return!!this.getCtrl().isEditable()&&(this.getWidget()?""!==this.getWidget().state.value:void 0!==this.props.value)}render(){const e=this.getCtrl();return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[(0,o.jsx)(l.zC,{classList:[`${this.getCssBlockName()}__input`],type:this.state.type,value:e.getValueForWidget(),readOnly:!e.isEditable(),disabled:!e.isEditable(),autoFocus:e.isAutoFocus(),placeholder:e.getPlaceholder()||null,autocomplete:e.getAutocomplete(),onCreate:this.onWidgetCreate,onChange:e.onChange,onFocus:this.onFocus,onBlur:this.onBlur}),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${this.isCloseVisible()?"visible":""}`,onClick:this.onCloseClick},{children:(0,o.jsx)(l.Tw,{})})),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon`,onClick:this.onIconClick},{children:"password"===this.state.type?(0,o.jsx)(l.K3,{}):(0,o.jsx)(l.X0,{})}))]}))}}class RowFormPasswordFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormPasswordFieldView}}f.W.registerGlobalClass(RowFormPasswordFieldController);class TableFormCheckBoxFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames(),style:Object.assign(Object.assign({},this.getStyle(e)),{textAlign:t.getAlign()})},{children:(0,o.jsx)(l.Jg,{ref:this.span,checked:t.getValueForWidget(e),readOnly:!0,disabled:!0})}))}}class TableFormComboBoxFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("span",Object.assign({ref:this.span},{children:t.getValueForWidget(e)}))}))}}class TableFormDateTimeFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("span",Object.assign({ref:this.span},{children:t.getValueForWidget(e)}))}))}}class TableFormDateTimeFieldController extends TableFormFieldController{getViewClass(){return super.getViewClass()||TableFormDateTimeFieldView}getValueForWidget(e){const t=this.getModel().getValue(e);return t?l.Wt.formatDate(t,this.getFormat()||"{DD}.{MM}.{YYYY} {hh}:{mm}:{ss}"):""}}l.Wt.registerGlobalClass(TableFormDateTimeFieldController);class RowFormDateTimeFieldView extends RowFormFieldView{constructor(){super(...arguments),this.onClear2=async()=>{this.getCtrl().onChange2(null)}}isCloseVisible(){if(this.props.readOnly)return!1;const{ctrl:e}=this.props;return e.widget2?""!==e.widget2.state.value:void 0!==this.props.value}renderDatePart(){const e=this.getCtrl();return(0,o.jsx)(l.Ol,{classList:[`${this.getCssBlockName()}__dropdown-date-picker`],onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),onChange:e.onChange,placeholder:e.getPlaceholder(),format:e.getFormat(),oldDates:this.props.oldDates,highlightedDate:e.getHighlightedDate?e.getHighlightedDate():null,selectToday:e.getSelectToday?e.getSelectToday():null,minDate:e.getMinDate?e.getMinDate():null,debug:e.getApp().getHostApp().isDebugMode()})}renderTimePart(){const e=this.getCtrl();return(0,o.jsx)(l.jh,{classList:[`${this.getCssBlockName()}__time-box`],onCreate:e.onView2Create,readOnly:!e.isEditable(),value:e.getValueForTime(),onChange:e.onChange2,onBlur:e.isValidateOnBlur2()?e.onBlur2:null,placeholder:e.getPlaceholder2(),onClear:this.onClear2})}getMode(){return this.getCtrl().state.value?"datetime":"date"}render(){return(0,o.jsxs)("div",Object.assign({className:`${this.getCssClassNames()} ${this.getMode()}`,style:this.getStyle(this.getCtrl().getRow())},{children:[this.renderDatePart(),this.renderTimePart()]}))}}class RowFormDateTimeFieldController extends RowFormFieldController{constructor(e,t){super(e,t),this.widget2=null,this.defaultValue=0,this.onView2Create=e=>{this.widget2=e},this.onChange2=(e,t=!0)=>{if(this.resetErrors(),this.resetErrors2(),this.rerender(),this.isValidateOnChange2()){try{this.setValueFromView2(e)}catch(e){console.debug(`${this.getModel().getFullName()}: cannot parse time: ${e.message}`),this.state.parseError2=e.message}if(this.state.parseError2||(this.validate2(),this.isValid()&&this.copyValueToModel()),this.refreshChangedState(),t){try{this.emit("change",{value:e})}catch(e){console.error("unhandled change event error:",this.getModel().getFullName(),e)}this.getParent().onFieldChange({source:this})}}},this.onBlur2=(e,t=!0)=>{if(console.debug("RowFormDateTimeFieldController.onBlur2",e),this.isEditable()){this.resetErrors2(),this.rerender();try{this.setValueFromView2(e)}catch(e){console.debug(`${this.getModel().getFullName()}: cannot parse time: ${e.message}`),this.state.parseError2=e.message}if(this.state.parseError2||(this.validate2(),this.isValid()&&this.copyValueToModel()),this.refreshChangedState(),t){try{this.emit("change",{value:e})}catch(e){console.error("unhandled change event error:",this.getModel().getFullName(),e)}this.getParent().onFieldChange({source:this})}}},this.state.parseError2=null,this.state.error2=null}getViewClass(){return super.getViewClass()||RowFormDateTimeFieldView}getValueForWidget(){return this.getValue()}getValueForTime(){const e=this.getValue();if(e){const t=60*e.getHours()+e.getMinutes();if(t!==this.defaultValue)return t}return null}setValueFromWidget(e){if(null===e)this.state.parseError2=null,this.resetErrors2(),this.widget2&&this.widget2.setValue(null);else{const[t,s]=l.DB.splitTime(this.defaultValue);e.setHours(t,s)}this.setValue(e)}getPlaceholder2(){return l.DB.getStringValue(this.defaultValue)}getDefaultValue(){return this.defaultValue}setDefaultValue2(e){if("string"==typeof e)this.defaultValue=l.DB.getIntegerValue(e);else{if(e>=1440)throw new Error(`wrong default value: ${e}`);this.defaultValue=e}this.widget2&&null===this.widget2.getValue()&&this.state.value&&this.setValue2(null)}setValueFromView2(e){if(isNaN(e))throw new Error(this.getTimeErrorText());this.setValue2(e)}getTimeErrorText(){return this.getModel().getApp().getText().field.timeNotValid}setValue2(e){const t=null!==e?e:this.defaultValue,[s,r]=l.DB.splitTime(t);this.state.value.setHours(s,r)}validate2(){this.state.error2=this.getError2()}getError2(){if(this.widget2)try{this.widget2.getValue()}catch(e){return`can't parse time: ${e.message}`}return null}isParseError2(){return null!==this.state.parseError2}resetErrors2(){this.setError2(null),this.state.parseError2=null}setError2(e){this.state.error2=e}getErrorMessage2(){return this.state.parseError2?this.state.parseError2:this.state.error2}isValid2(){return null===this.state.parseError2&&null===this.state.error2}refill(){this.widget2&&(super.refill(),this.widget2.setValue(this.getValueForTime()),this.resetErrors2(),this.refreshChangedState())}isParseError(){return super.isParseError()||this.isParseError2()}isValid(){return super.isValid()&&this.isValid2()}getErrorMessage(){return null===super.getErrorMessage()&&null===this.getErrorMessage2()?null:[...super.getErrorMessage()?[super.getErrorMessage()]:[],...this.getErrorMessage2()?[this.getErrorMessage2()]:[]].join(", ")}isValidateOnChange2(){return!0}isValidateOnBlur2(){return!1}}f.W.registerGlobalClass(RowFormDateTimeFieldController);class TableFormComboBoxFieldController extends TableFormFieldController{constructor(){super(...arguments),this.onListUpdate=async e=>{this.getForm().invalidate(),await this.getForm().rerender()}}init(){super.init();const e=this.getModel().getComboBoxDataSource();e.on("insert",this.onListUpdate),e.on("update",this.onListUpdate),e.on("delete",this.onListUpdate)}deinit(){const e=this.getModel().getComboBoxDataSource();e.off("insert",this.onListUpdate),e.off("update",this.onListUpdate),e.off("delete",this.onListUpdate),super.deinit()}getViewClass(){return super.getViewClass()||TableFormComboBoxFieldView}getValueForWidget(e){const t=this.getModel().getValue(e),s=this.getModel().valueToRaw(t);if(void 0===s||"null"===s)return"";const r=this.getModel().findRowByRawValue(s);return r?this.valueToString(this.getModel().getDisplayValue(r)):`[no row for id: ${s}]`}}f.W.registerGlobalClass(TableFormComboBoxFieldController);class TableFormCheckBoxFieldController extends TableFormFieldController{getViewClass(){return super.getViewClass()||TableFormCheckBoxFieldView}getValueForWidget(e){return this.getModel().getValue(e)}getAlign(){return"center"}}f.W.registerGlobalClass(TableFormCheckBoxFieldController);class RowFormRadioFieldView extends RowFormFieldView{constructor(){super(...arguments),this.onClick=async e=>{console.debug("RowFormRadioFieldView.onClick",e.currentTarget.dataset.value);let t=JSON.parse(e.currentTarget.dataset.value);this.getCtrl().getValue()!==t&&await this.getCtrl().onChangePure(t)}}render(){const e=this.getCtrl().getValue();return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:this.getCtrl().getItems().map((t=>(0,o.jsx)("input",{className:`${this.getCssBlockName()}__toggle ${e===t.value?"selected":""}`,type:"button",value:t.title||t.value,disabled:!this.getCtrl().isEditable(),"data-value":JSON.stringify(t.value),onClick:this.onClick},t.value)))}))}}class RowFormRadioFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormRadioFieldView}getItems(){try{return this.getRows().map((e=>({value:this.getModel().getValueValue(e),title:this.getModel().getDisplayValue(e)})))}catch(e){throw e.message=`${this.getModel().getFullName()}: ${e.message}`,e}}getRows(){return this.getModel().getDataSource().getRows()}}f.W.registerGlobalClass(RowFormRadioFieldController);class RowFormCheckBoxFieldView extends RowFormFieldView{constructor(){super(...arguments),this.onCheckBoxChange=(e,t)=>{this.getCtrl().onChange(e)}}render(){const e=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:(0,o.jsx)(l.Jg,{onCreate:this.onWidgetCreate,checked:e.getValueForWidget(),readOnly:!e.isEditable(),disabled:!e.isEditable(),onChange:this.onCheckBoxChange})}))}}class RowFormCheckBoxFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormCheckBoxFieldView}getValueForWidget(){return this.getValue()}setValueFromWidget(e){this.setValue(e)}}f.W.registerGlobalClass(RowFormCheckBoxFieldController);class ModalController extends r.Q{constructor(e={}){if(super(),!e.app)throw new Error("no app");if(!e.id)throw new Error("no id");this.options=e}getId(){return this.options.id}getApp(){return this.options.app}async close(){await this.getApp().closeModal(this),this.options.onClose&&this.options.onClose()}}class ImageDialogView extends n.G{constructor(e){super(e),this.el=i().createRef()}render(){console.debug("ImageDialogView.render");const{ctrl:e}=this.props;return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames(),ref:this.el,tabIndex:0,onKeyDown:this.getCtrl().onKeyDown},{children:[(0,o.jsx)("img",{className:`${this.getCssBlockName()}__image`,src:e.getSrc(),onClick:e.onImageClick}),(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close`,onClick:e.onCloseClick},{children:(0,o.jsx)(l.BX,{})}))]}))}componentDidMount(){this.getElement().focus()}}class ImageDialogController extends ModalController{constructor(e){if(super(e),this.onCloseClick=async e=>{await this.close()},this.onKeyDown=async e=>{"Escape"===e.key&&await this.close()},this.onImageClick=async e=>{console.debug("ImageDialogController.onImageClick"),await this.close()},!e.src)throw new Error("no src")}getViewClass(){return console.debug("ImageDialogController.getViewClass"),ImageDialogView}getSrc(){return this.options.src}}class RowFormFileFieldView extends RowFormFieldView{constructor(){super(...arguments),this.image=i().createRef(),this.div=i().createRef(),this.input=i().createRef(),this.onClearClick=e=>{this.getCtrl().onChange("")},this.onChange=async e=>{const t=e.target.files[0];if(t){const e=await l.Wt.readFileAsDataURL(t);this.getCtrl().onChange(e)}},this.onImageClick=async e=>{console.debug("RowFormFileFieldView.onImageClick");const t=this.getCtrl(),s=t.getApp(),r=t.getValueForWidget(),o=new ImageDialogController({app:s,id:s.getNewId(),src:r,onClose:()=>{console.debug("onClose"),this.getCtrl().getPage().getView().getElement().focus()}});await s.openModal(o)},this.onImageIconClick=async e=>{console.debug("RowFormFileFieldView.onImageIconClick"),this.getInput().click()}}getImage(){return this.image.current}getDiv(){return this.div.current}getInput(){return this.input.current}updateSize(){if(this.getImage()){const e=this.getImage().getNaturalSize();this.getDiv().innerText=`${e[0]}×${e[1]}`}}render(){const e=this.getCtrl(),t=e.getRow(),s=e.getValueForWidget();return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames(),style:this.getStyle(t)},{children:[s?(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__image-block`},{children:[(0,o.jsx)(l.Ee,{classList:[`${this.getCssBlockName()}__image`],ref:this.image,src:s,onClick:this.onImageClick}),(0,o.jsx)("span",{className:`${this.getCssBlockName()}__size`,ref:this.div}),(0,o.jsx)("span",Object.assign({className:`${this.getCssBlockName()}__length`},{children:l.Wt.formatNumber(s.length)}))]})):(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__image-icon`,onClick:this.onImageIconClick},{children:(0,o.jsx)("svg",Object.assign({xmlns:"http://www.w3.org/2000/svg",width:96,height:96,viewBox:"0 0 48 48"},{children:(0,o.jsx)("path",{d:"M38.65 15.3V11h-4.3V8h4.3V3.65h3V8H46v3h-4.35v4.3ZM4.7 44q-1.2 0-2.1-.9-.9-.9-.9-2.1V15.35q0-1.15.9-2.075.9-.925 2.1-.925h7.35L15.7 8h14v3H17.1l-3.65 4.35H4.7V41h34V20h3v21q0 1.2-.925 2.1-.925.9-2.075.9Zm17-7.3q3.6 0 6.05-2.45 2.45-2.45 2.45-6.1 0-3.6-2.45-6.025Q25.3 19.7 21.7 19.7q-3.65 0-6.075 2.425Q13.2 24.55 13.2 28.15q0 3.65 2.425 6.1Q18.05 36.7 21.7 36.7Zm0-3q-2.4 0-3.95-1.575-1.55-1.575-1.55-3.975 0-2.35 1.55-3.9 1.55-1.55 3.95-1.55 2.35 0 3.925 1.55 1.575 1.55 1.575 3.9 0 2.4-1.575 3.975Q24.05 33.7 21.7 33.7Zm0-5.5Z"})}))})),(0,o.jsxs)("div",Object.assign({className:`${this.getCssBlockName()}__toolbar`},{children:[(0,o.jsx)("input",{ref:this.input,type:"file",onChange:this.onChange,disabled:!e.isEditable(),style:{display:s?void 0:"none"}}),!!s&&(0,o.jsx)(l.zx,Object.assign({onClick:this.onClearClick,enabled:e.isEditable()},{children:this.getCtrl().getApp().getModel().getText().field.clear}))]}))]}))}componentDidMount(){setTimeout((()=>this.updateSize()),0)}componentDidUpdate(e,t,s){setTimeout((()=>this.updateSize()),0)}}class RowFormFileFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormFileFieldView}}f.W.registerGlobalClass(RowFormFileFieldController);class RowFormPhoneFieldView extends RowFormFieldView{constructor(e){super(e),this.onClear=async e=>{this.getCtrl().onChange(""),setTimeout((()=>{this.getWidget().getElement().focus()}),0)},this.onFocus=async e=>{this.addCssClass("focus"),await this.rerender()},this.onBlur=async e=>{this.removeCssClass("focus"),this.getCtrl().onBlur(e)},this.state={classList:[]}}isCloseVisible(){const e=this.getCtrl();return!!e.isEditable()&&""!==e.getValueForWidget()}renderPhoneBox(){const e=this.getCtrl();return(0,o.jsx)(l.Fg,{classList:[`${this.getCssBlockName()}__input`],value:e.getValueForWidget(),readOnly:!e.isEditable(),disabled:!e.isEditable(),autoFocus:e.isAutoFocus(),placeholder:e.getPlaceholder()||null,autocomplete:e.getAutocomplete(),onCreate:this.onWidgetCreate,onChange:e.onChange,onFocus:this.onFocus,onBlur:this.onBlur})}renderClearButton(){return(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__close ${this.isCloseVisible()?"visible":""}`,onMouseDown:this.onClear},{children:(0,o.jsx)(l.Tw,{})}))}renderPhoneIcon(){return(0,o.jsx)("div",Object.assign({className:`${this.getCssBlockName()}__icon`},{children:(0,o.jsx)(l.qW,{})}))}render(){return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[this.renderPhoneBox(),this.renderClearButton(),this.renderPhoneIcon()]}))}}class RowFormPhoneFieldController extends RowFormFieldController{getViewClass(){return super.getViewClass()||RowFormPhoneFieldView}getPhoneFormatErrorText(){return this.getModel().getApp().getText().form.phoneNumberFormatError}getError(){const e=super.getError();if(e)return e;const t=this.getValue();return t&&"+7"===t.substr(0,2)&&t.length<12?this.getPhoneFormatErrorText():null}}f.W.registerGlobalClass(RowFormPhoneFieldController);class TableFormPhoneFieldView extends TableFormFieldView{render(){const e=this.props.row;return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("span",Object.assign({ref:this.span},{children:l.Fg.formatPhoneNumber(this.getCtrl().getValueForWidget(e))}))}))}}class TableFormPhoneFieldController extends TableFormFieldController{getViewClass(){return super.getViewClass()||TableFormPhoneFieldView}}f.W.registerGlobalClass(TableFormPhoneFieldController);class RowFormCheckBoxListFieldView extends RowFormFieldView{getItems(){const e=this.getCtrl();try{return e.getRows().map((t=>e.getItemFromRow(t)))}catch(t){throw t.message=`${e.getModel().getFullName()}: ${t.message}`,t}}renderCheckBoxList(){const e=this.getCtrl();return(0,o.jsx)(l.$,{name:e.getModel().getFullName(),classList:[`${this.getCssBlockName()}__checkboxlist`],onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),onChange:e.onChange,items:this.getItems()})}render(){return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:this.renderCheckBoxList()}))}}class RowFormCheckBoxListFieldController extends RowFormFieldController{constructor(){super(...arguments),this.onListInsert=async e=>{console.debug("RowFormCheckBoxListFieldController.onListInsert"),await this.rerender()},this.onListUpdate=async e=>{await this.rerender()},this.onListDelete=async e=>{await this.rerender()}}init(){super.init();const e=this.getModel().getDataSource();e.on("insert",this.onListInsert),e.on("update",this.onListUpdate),e.on("delete",this.onListDelete)}deinit(){const e=this.getModel().getDataSource();e.off("insert",this.onListInsert),e.off("update",this.onListUpdate),e.off("delete",this.onListDelete),super.deinit()}getViewClass(){return super.getViewClass()||RowFormCheckBoxListFieldView}getRows(){return this.getModel().getDataSource().getRows()}getValueForWidget(){return this.getValue()}setValueFromWidget(e){this.setValue(e)}getItemFromRow(e){return{value:this.valueToString(this.getModel().getValueValue(e)),title:this.getModel().getDisplayValue(e)}}}f.W.registerGlobalClass(RowFormCheckBoxListFieldController);class RowFormLinkFieldView extends RowFormFieldView{render(){const e=this.getCtrl();let t=e.getValueForWidget(),s=e.getValueForWidget();const r=e.getDisplayValue();r&&(s=r);const a=e.getModel().getAttr("page");if(a){const s=e.getValueForWidget();t=e.getPage().createOpenInNewLink(a,(0,N.DW)([s]))}return(0,o.jsx)("div",Object.assign({className:this.getCssClassNames()},{children:(0,o.jsx)("a",Object.assign({href:t,onClick:e.onClick,target:"_blank"},{children:s}))}))}}class RowFormLinkFieldController extends RowFormFieldController{constructor(){super(...arguments),this.onClick=e=>{console.debug("RowFormLinkFieldController.onClick",e);const t=this.getModel().getAttr("page");t&&(e.preventDefault(),this.openPage({name:t,params:{key:this.getValue()}})),this.emit({source:this})}}getViewClass(){return super.getViewClass()||RowFormLinkFieldView}getDisplayValue(){const e=this.getModel().getAttr("displayColumn");if(e){const t=this.getModel().getDefaultDataSource(),s=t.getValue(t.getSingleRow(),e);return JSON.parse(s)}return null}}f.W.registerGlobalClass(RowFormLinkFieldController);class TableFormLinkFieldView extends TableFormFieldView{render(){const e=this.props.row,t=this.getCtrl();return(0,o.jsx)("div",Object.assign({className:`${this.getCssClassNames()} ellipsis`,style:this.getStyle(e)},{children:(0,o.jsx)("a",Object.assign({href:"#",onClick:t.onClick},{children:t.getValueForWidget(e)}))}))}}class TableFormLinkFieldController extends TableFormFieldController{constructor(){super(...arguments),this.onClick=e=>{console.debug("TableFormLinkFieldController.onClick",e),e.preventDefault(),this.emit("click",{source:this})}}getViewClass(){return super.getViewClass()||TableFormLinkFieldView}}f.W.registerGlobalClass(TableFormLinkFieldController);class RowFormTimeFieldView extends RowFormFieldView{constructor(){super(...arguments),this.onCloseClick=async e=>{console.debug("RowFormTimeFieldView.onCloseClick")}}isCloseVisible(){return!this.props.readOnly&&(this.getWidget()?""!==this.getWidget().state.value:void 0!==this.props.value)}render(){const e=this.getCtrl();return(0,o.jsxs)("div",Object.assign({className:this.getCssClassNames()},{children:[(0,o.jsx)(l.DB,{onCreate:this.onWidgetCreate,value:e.getValueForWidget(),readOnly:!e.isEditable(),onChange:e.onChange,onBlur:e.onBlur,placeholder:e.getPlaceholder()}),(0,o.jsx)("div",Object.assign({className:"close "+(this.isCloseVisible()?"visible":""),onClick:this.onCloseClick},{children:(0,o.jsx)(l.Tw,{})}))]}))}}class RowFormTimeFieldController extends RowFormFieldController{constructor(){super(...arguments),this.defaultValue=null}getViewClass(){return super.getViewClass()||RowFormTimeFieldView}getValueForWidget(){return this.getValue()}setValueFromWidget(e){if(isNaN(e))throw new Error("wrong time");this.setValue(e)}getDefaultValue(){return this.defaultValue}setDefaultValue2(e){if("string"==typeof e)this.defaultValue=l.DB.getIntegerValue(e);else{if(e>=1440)throw new Error(`wrong default value: ${e}`);this.defaultValue=e}}getPlaceholder(){return null!==this.defaultValue?l.DB.getStringValue(this.defaultValue):super.getPlaceholder()}}f.W.registerGlobalClass(RowFormTimeFieldController)},855:(e,t,s)=>{s.d(t,{DW:()=>r,Mo:()=>a,mV:()=>o});const r=e=>JSON.stringify(e),o=e=>JSON.parse(e);function a(e){return JSON.parse(e)}},211:e=>{e.exports=require("colors/safe")},632:e=>{e.exports=require("ejs")},13:e=>{e.exports=require("mongodb")},689:e=>{e.exports=require("react")},405:e=>{e.exports=require("react-dom")},997:e=>{e.exports=require("react/jsx-runtime")},147:e=>{e.exports=require("fs")},17:e=>{e.exports=require("path")},598:e=>{e.exports=JSON.parse('{"name":"qforms","version":"0.39.0","description":"A fullstack framework/platform based on Express and React for building Web UI for databases.","main":"dist/index.js","files":["dist"],"scripts":{"webpack-back-index":"NODE_ENV=dev webpack --config webpack.config.back.index.js","webpack-back-start":"NODE_ENV=dev webpack --config webpack.config.back.start.js","webpack-front-editor":"NODE_ENV=dev webpack --config webpack.config.editor.js","webpack-front-index":"NODE_ENV=dev webpack --config webpack.config.index.js","webpack-front-monitor":"NODE_ENV=dev webpack --config webpack.config.monitor.js","webpack-front-viewer":"NODE_ENV=dev webpack --config webpack.config.viewer.js","build":"npx gulp build-dev","build:prod":"npx gulp build-prod","start":"NODE_ENV=dev node dist/start.js","start:sample":"NODE_ENV=dev bun apps-ts/sample/start.ts","start:apps":"NODE_ENV=dev QFORMS_LOG_LEVEL=log APPS_DIR_PATH=~/projects/qforms-apps LISTEN_PORT=7000 node dist/start.js","nodemon-start":"NODE_ENV=dev nodemon --watch dist --watch apps dist/start.js","test":"jest --runInBand","test:path":"jest --runTestsByPath","test:cov":"jest --coverage","docker:build":"npx gulp docker-build","docker:run":"npx gulp docker-run","prettier:write":"npx prettier --write \\"src/**/*.{ts,tsx,less}\\""},"dependencies":{"body-parser":"^1.19.1","colors":"^1.4.0","cookie-parser":"^1.4.6","ejs":"~3.1.7","express":"^4.17.2","express-session":"^1.17.2","glob":"^5.0.5","mongodb":"^4.13.0","mysql":"^2.18.1","node-fetch":"^2.6.7","pg":"^8.11.0","react":"^17.0.2","react-dom":"^17.0.2","slash":"^1.0.0","uuid":"^8.3.2","ws":"^2.3.1"},"devDependencies":{"@babel/cli":"^7.16.0","@babel/core":"^7.16.5","@babel/plugin-proposal-class-properties":"^7.16.5","@babel/plugin-transform-react-jsx":"^7.16.5","@babel/preset-react":"^7.18.6","@types/cookie-parser":"^1.4.3","@types/express":"^4.17.14","@types/express-session":"^1.17.6","@types/glob":"^8.1.0","@types/jest":"^29.4.0","@types/mysql":"^2.15.21","@types/node":"^14.18.34","@types/node-fetch":"^2.6.4","@types/pg":"^8.6.6","@types/react":"^17.0.52","@types/react-dom":"^17.0.18","@types/slash":"^3.0.0","@types/supertest":"^2.0.12","@types/uuid":"^9.0.2","@types/ws":"^8.5.5","@typescript-eslint/eslint-plugin":"^5.45.1","@typescript-eslint/parser":"^5.45.1","babel-loader":"^9.1.0","babel-preset-react-app":"^3.1.2","chai":"^3.2.0","copy-webpack-plugin":"^11.0.0","css-loader":"^6.7.3","del":"^1.2.1","esbuild-loader":"^4.0.2","eslint":"^8.29.0","eslint-config-airbnb":"^19.0.4","eslint-config-airbnb-typescript":"^17.0.0","eslint-config-prettier":"^8.6.0","eslint-plugin-import":"^2.26.0","eslint-plugin-jsx-a11y":"^6.6.1","eslint-plugin-prettier":"^4.2.1","eslint-plugin-react":"^7.31.11","eslint-plugin-react-hooks":"^4.6.0","gulp":"^4.0.2","gulp-babel":"^8.0.0","gulp-clean-css":"^4.3.0","gulp-concat":"^2.6.0","gulp-hash-filename":"^3.0.0","gulp-less":"^4.0.1","gulp-minify":"^3.1.0","gulp-sourcemaps":"^3.0.0","gulp-typescript":"^6.0.0-alpha.1","gulp-uglify":"^3.0.2","jest":"^29.4.3","less-loader":"^11.1.0","mini-css-extract-plugin":"^2.7.2","nodemon":"^2.0.20","null-loader":"^4.0.1","prettier":"^2.8.4","should":"^7.0.4","supertest":"^6.3.3","terser-webpack-plugin":"^5.3.6","through":"^2.3.8","ts-jest":"^29.0.5","ts-loader":"^9.3.1","typescript":"^4.9.3","webpack":"^5.74.0","webpack-cli":"^4.10.0","webpack-node-externals":"^3.0.0"},"repository":{"type":"git","url":"https://github.com/alexn1/qforms.git"},"keywords":["web","ui","database"],"author":{"name":"Alexander Nesterenko","email":"alex140@gmail.com","url":"https://github.com/alexn1"},"license":"MIT","bugs":{"url":"https://github.com/alexn1/qforms/issues"},"homepage":"https://github.com/alexn1/qforms"}')}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var s=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](s,s.exports,__webpack_require__),s.exports}__webpack_require__.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return __webpack_require__.d(t,{a:t}),t},__webpack_require__.d=(e,t)=>{for(var s in t)__webpack_require__.o(t,s)&&!__webpack_require__.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};return(()=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{ActionEditor:()=>s.ActionEditor,ActionEditorController:()=>s.ActionEditorController,ApplicationController:()=>o._l,ApplicationEditor:()=>s.ApplicationEditor,ApplicationEditorController:()=>s.ApplicationEditorController,ApplicationView:()=>o.SR,ArrowIcon:()=>r.e0,BackHostApp:()=>s.BackHostApp,BaseModel:()=>s.BaseModel,BkAction:()=>s.BkAction,BkApplication:()=>s.BkApplication,BkCheckBoxField:()=>s.BkCheckBoxField,BkCheckBoxListField:()=>s.BkCheckBoxListField,BkColumn:()=>s.BkColumn,BkComboBoxField:()=>s.BkComboBoxField,BkDataSource:()=>s.BkDataSource,BkDatabase:()=>s.BkDatabase,BkDateField:()=>s.BkDateField,BkDateTimeField:()=>s.BkDateTimeField,BkField:()=>s.BkField,BkFileField:()=>s.BkFileField,BkForm:()=>s.BkForm,BkHelper:()=>s.BkHelper,BkImageField:()=>s.BkImageField,BkLabelField:()=>s.BkLabelField,BkLinkField:()=>s.BkLinkField,BkModel:()=>s.BkModel,BkMongoDbDatabase:()=>s.BkMongoDbDatabase,BkMySqlDatabase:()=>s.BkMySqlDatabase,BkNoSqlDataSource:()=>s.BkNoSqlDataSource,BkPage:()=>s.BkPage,BkPageLink:()=>s.BkPageLink,BkParam:()=>s.BkParam,BkPasswordField:()=>s.BkPasswordField,BkPhoneField:()=>s.BkPhoneField,BkPostgreSqlDatabase:()=>s.BkPostgreSqlDatabase,BkRadioField:()=>s.BkRadioField,BkRowForm:()=>s.BkRowForm,BkSqlDataSource:()=>s.BkSqlDataSource,BkTable:()=>s.BkTable,BkTableForm:()=>s.BkTableForm,BkTextAreaField:()=>s.BkTextAreaField,BkTextBoxField:()=>s.BkTextBoxField,BkTimeField:()=>s.BkTimeField,Box:()=>r.xu,Button:()=>r.zx,CancelIcon:()=>r.FB,CheckBox:()=>r.Jg,CheckBoxField:()=>o.J7,CheckBoxFieldEditor:()=>s.CheckBoxFieldEditor,CheckBoxList:()=>r.$,CheckBoxListField:()=>o.Hc,CheckBoxListFieldEditor:()=>s.CheckBoxListFieldEditor,CloseIcon:()=>r.Tw,CloseIcon2:()=>r.BX,Column:()=>o.sg,ColumnEditor:()=>s.ColumnEditor,ColumnEditorController:()=>s.ColumnEditorController,ComboBox:()=>r.Ct,ComboBoxField:()=>o.XQ,ComboBoxFieldEditor:()=>s.ComboBoxFieldEditor,Context:()=>s.Context,Converter:()=>s.Converter,DataSource:()=>o.o2,DataSourceEditor:()=>s.DataSourceEditor,DataSourceEditorController:()=>s.DataSourceEditorController,Database:()=>o.vo,DatabaseEditor:()=>s.DatabaseEditor,DatabaseEditorController:()=>s.DatabaseEditorController,DatabaseResult:()=>t.U6,DateField:()=>o.Nn,DateFieldEditor:()=>s.DateFieldEditor,DateIcon:()=>r.IH,DatePicker:()=>r.Mt,DateTimeField:()=>o.ln,DateTimeFieldEditor:()=>s.DateTimeFieldEditor,DeleteIcon:()=>r.pJ,DoneIcon:()=>r.qw,DownIcon:()=>r.KL,DropdownButton:()=>r.PS,DropdownDatePicker:()=>r.Ol,EditIcon:()=>r.dY,Expand:()=>r.M0,FieldEditor:()=>s.FieldEditor,FieldEditorController:()=>s.FieldEditorController,FileField:()=>o.j9,FileFieldEditor:()=>s.FileFieldEditor,Form:()=>o.l0,FormEditor:()=>s.FormEditor,FormEditorController:()=>s.FormEditorController,FrontHostApp:()=>r.Qh,Grid:()=>r.rj,GridCell:()=>r.r8,GridRow:()=>r.Jn,Helper:()=>r.Wt,Image:()=>r.Ee,ImageFieldEditor:()=>s.ImageFieldEditor,InsertExResult:()=>t.cW,JsonFile:()=>s.JsonFile,KeyColumnEditor:()=>s.KeyColumnEditor,KeyColumnEditorController:()=>s.KeyColumnEditorController,LabelFieldEditor:()=>s.LabelFieldEditor,LeftIcon:()=>r.Ey,LinkField:()=>o.Ai,LinkFieldEditor:()=>s.LinkFieldEditor,LocationIcon:()=>r._t,LoginController:()=>o.Kq,LoginFrontHostApp:()=>o.Sr,LoginView:()=>o.qg,Menu:()=>r.v2,Modal:()=>r.u_,MongoDbDatabaseEditor:()=>s.MongoDbDatabaseEditor,MoreVertIcon:()=>r.Yv,MySqlDatabaseEditor:()=>s.MySqlDatabaseEditor,NoSqlDataSource:()=>o.IP,NoSqlDataSourceEditor:()=>s.NoSqlDataSourceEditor,OpenInNewIcon:()=>r.r$,Page:()=>o.T3,PageController:()=>o.vv,PageEditor:()=>s.PageEditor,PageEditorController:()=>s.PageEditorController,PageLinkEditor:()=>s.PageLinkEditor,PageLinkEditorController:()=>s.PageLinkEditorController,PageView:()=>o.B4,ParamEditor:()=>s.ParamEditor,ParamEditorController:()=>s.ParamEditorController,Password:()=>r.ro,PasswordField:()=>o.ZI,PasswordFieldEditor:()=>s.PasswordFieldEditor,PasswordIcon:()=>r.CW,PersistentDataSource:()=>o.Md,PhoneBox:()=>r.Fg,PhoneField:()=>o.$S,PhoneFieldEditor:()=>s.PhoneFieldEditor,PhoneIcon:()=>r.qW,PostgreSqlDatabaseEditor:()=>s.PostgreSqlDatabaseEditor,Radio:()=>r.Y8,RadioField:()=>o.gu,RadioFieldEditor:()=>s.RadioFieldEditor,ReactComponent:()=>r.rN,Result:()=>t.x4,RightIcon:()=>r.m9,RowForm:()=>o.e9,RowFormCheckBoxFieldController:()=>o.Vn,RowFormCheckBoxListFieldController:()=>o.vB,RowFormCheckBoxListFieldView:()=>o.Eh,RowFormComboBoxFieldController:()=>o.ji,RowFormComboBoxFieldView:()=>o.MR,RowFormController:()=>o.iq,RowFormDateFieldController:()=>o.Qx,RowFormDateFieldView:()=>o.dc,RowFormDateTimeFieldController:()=>o.lG,RowFormDateTimeFieldView:()=>o.I9,RowFormEditor:()=>s.RowFormEditor,RowFormFieldController:()=>o.Ey,RowFormFieldView:()=>o.Qk,RowFormFileFieldController:()=>o.GW,RowFormLinkFieldController:()=>o.vg,RowFormPasswordFieldController:()=>o.Ay,RowFormPhoneFieldController:()=>o.k6,RowFormPhoneFieldView:()=>o.mn,RowFormRadioFieldController:()=>o.v2,RowFormTextAreaFieldController:()=>o.L_,RowFormTextAreaFieldView:()=>o.xd,RowFormTextBoxFieldController:()=>o.K5,RowFormTextBoxFieldView:()=>o.Vu,RowFormTimeFieldController:()=>o.Yn,RowFormView:()=>o.o0,Search:()=>r.ol,Select:()=>r.Ph,SettingsIcon:()=>r.ew,Slider:()=>r.iR,SqlDataSource:()=>o.B,SqlDataSourceEditor:()=>s.SqlDataSourceEditor,Statusbar:()=>r.XW,Tab:()=>r.OK,Tab2:()=>r.db,Table:()=>o.iA,TableEditor:()=>s.TableEditor,TableEditorController:()=>s.TableEditorController,TableForm:()=>o.R8,TableFormCheckBoxFieldController:()=>o.j5,TableFormCheckBoxFieldView:()=>o.Lh,TableFormComboBoxFieldController:()=>o.QN,TableFormComboBoxFieldView:()=>o.uZ,TableFormController:()=>o.GZ,TableFormDateFieldController:()=>o.JR,TableFormDateFieldView:()=>o.s6,TableFormDateTimeFieldController:()=>o.LH,TableFormDateTimeFieldView:()=>o.OW,TableFormEditor:()=>s.TableFormEditor,TableFormLinkFieldController:()=>o.tG,TableFormPhoneFieldController:()=>o.iZ,TableFormTextBoxFieldController:()=>o.YB,TableFormTextBoxFieldView:()=>o.W$,TableFormView:()=>o.vX,TableResult:()=>t.Lm,TextArea:()=>r.Kx,TextAreaField:()=>o.N7,TextAreaFieldEditor:()=>s.TextAreaFieldEditor,TextBox:()=>r.zC,TextBoxField:()=>o.Nx,TextBoxFieldEditor:()=>s.TextBoxFieldEditor,TimeBox:()=>r.DB,TimeBox2:()=>r.jh,TimeFieldEditor:()=>s.TimeFieldEditor,TimeIcon:()=>r.wZ,Tooltip:()=>r.u,UpdateEx:()=>t.cY,UpdateResult:()=>t.sF,ViewerFrontHostApp:()=>o.iJ,VisibilityIcon:()=>r.K3,VisibilityOffIcon:()=>r.X0,VisualEditorController:()=>s.VisualEditorController,keyToKeyTuple:()=>e.mV,keyTupleToKey:()=>e.DW,parseJson:()=>e.Mo});var e=__webpack_require__(855),t=__webpack_require__(224),s=__webpack_require__(450),r=__webpack_require__(587),o=__webpack_require__(834)})(),__webpack_exports__})()));